<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Friday, Mar 25</title>

<script src="site_libs/header-attrs-2.13/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Statistics 436/516</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="lectures.html">Lectures</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Friday, Mar 25</h1>

</div>


<p>You can also download a <a href="lecture-03-25-2022.pdf">PDF</a> copy
of this lecture.</p>
<div id="impact-of-pesticides-on-skylark-reproductivity"
class="section level2">
<h2>Impact of Pesticides on Skylark Reproductivity</h2>
<p>During the four summers from 1992 to 1995 researchers from the
National Environmental Research Institute in the Ministry of Environment
and Energy in Denmark conducted a study to examine how pesticide use
impacts skylark reproduction in barley fields.<a href="#fn1"
class="footnote-ref" id="fnref1"><sup>1</sup></a> The study used a
fractional factorial design in which each year two of four fields were
sprayed with pesticides while the other two fields were not.<a
href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a> Which
fields were sprayed was alternated so that a field was sprayed every
other year. The number of fledgling skylarks produced in each field each
year was recorded. The data are in the <code>skylark</code> data frame
from the <strong>trtools</strong> package. The data are plotted
below.</p>
<pre class="r"><code>library(trtools)
library(ggplot2)
p &lt;- ggplot(skylark, aes(x = spray, y = count)) + 
   geom_point() + facet_grid(field ~ year) + 
   labs(shape = &quot;Field&quot;, x = &quot;Field Sprayed?&quot;, 
    y = &quot;Number of Skylark Fledglings&quot;) + theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-03-25-2022_files/figure-html/unnamed-chunk-2-1.png" width="100%" style="display: block; margin: auto;" />
The plot clearly shows the incomplete nature of the fractional factorial
design. In any given year, a field either was or was not sprayed. The
objective is to investigate the effect of spraying on the number of
skylarks while controlling for the effects of year and field.</p>
<ol style="list-style-type: decimal">
<li><p>Estimate a Poisson regression model for the number of skylark
fledglings as your response variable that will reproduce the following
results.</p>
<pre class="r"><code>cbind(summary(m)$coefficients, confint(m))</code></pre>
<pre><code>             Estimate Std. Error  z value   Pr(&gt;|z|)    2.5 %   97.5 %
(Intercept)  3.430943    0.13262 25.86999 1.450e-147  3.16352  3.68367
sprayyes    -0.456126    0.09385 -4.86011  1.173e-06 -0.64141 -0.27324
fieldKr      0.049089    0.12672  0.38738  6.985e-01 -0.19929  0.29806
fieldKu      0.004964    0.12800  0.03879  9.691e-01 -0.24611  0.25625
fieldRd     -0.179048    0.13417 -1.33452  1.820e-01 -0.44342  0.08326
year1993     0.462623    0.13064  3.54108  3.985e-04  0.20868  0.72149
year1994     0.060018    0.14149  0.42420  6.714e-01 -0.21735  0.33816
year1995     0.327281    0.13411  2.44041  1.467e-02  0.06596  0.59240</code></pre>
<p>Note that here <code>m</code> is a model object created using the
<code>glm</code> function.</p>
<p><strong>Solution</strong>: The results can be replicated as follows.
Note that the output above indicates that only the “main effects” of
spray, field, and year were specified. We can see that there are
indicator variables for spray, field, and year, but no interaction
terms.</p>
<pre class="r"><code>m &lt;- glm(count ~ spray + field + year, family = poisson, data = skylark)
cbind(summary(m)$coefficients, confint(m))</code></pre>
<pre><code>             Estimate Std. Error  z value   Pr(&gt;|z|)    2.5 %   97.5 %
(Intercept)  3.430943    0.13262 25.86999 1.450e-147  3.16352  3.68367
sprayyes    -0.456126    0.09385 -4.86011  1.173e-06 -0.64141 -0.27324
fieldKr      0.049089    0.12672  0.38738  6.985e-01 -0.19929  0.29806
fieldKu      0.004964    0.12800  0.03879  9.691e-01 -0.24611  0.25625
fieldRd     -0.179048    0.13417 -1.33452  1.820e-01 -0.44342  0.08326
year1993     0.462623    0.13064  3.54108  3.985e-04  0.20868  0.72149
year1994     0.060018    0.14149  0.42420  6.714e-01 -0.21735  0.33816
year1995     0.327281    0.13411  2.44041  1.467e-02  0.06596  0.59240</code></pre></li>
<li><p>According to the model, the expected number of skylark fledglings
when a field <em>is</em> sprayed is about 0.63 times that when a field
is <em>not</em> sprayed. In other words, we estimate when the fields are
sprayed the expected number of skylark fledglings by about 37 percent
lower. Note that these effects are qualified as “when controlling for
field and year” or “for any given field or year” since the model
conditions the distribution of counts on these variables as well.
Confirm this result by applying the exponential function to the
parameter estimates.</p>
<p><strong>Solution</strong>: The quantity we want to estimate is <span
class="math inline">\(e^{\beta_1}\)</span> which is the “rate ratio” for
the effect of spraying. This gives the “multiplicative effect” of
spraying — i.e., the ratio of the expected count when spraying to the
expected count when not spraying. You could compute this in R or with a
hand calculator by computing <code>exp(-0.4561258)</code>. Also we can
do this in R as follows.</p>
<pre class="r"><code>exp(cbind(coef(m), confint(m)))</code></pre>
<pre><code>                      2.5 %  97.5 %
(Intercept) 30.9058 23.6537 39.7921
sprayyes     0.6337  0.5265  0.7609
fieldKr      1.0503  0.8193  1.3472
fieldKu      1.0050  0.7818  1.2921
fieldRd      0.8361  0.6418  1.0868
year1993     1.5882  1.2321  2.0575
year1994     1.0619  0.8046  1.4024
year1995     1.3872  1.0682  1.8083</code></pre>
<p>Note that I’ve included the endpoints of the confidence intervals as
well. If you just wanted the point estimate you could use
<code>exp(coef(m))</code>. The function <code>coef</code> extracts the
parameter estimates from the model object <code>m</code>.</p></li>
<li><p>Replicate the result that was obtained in the previous problem
using the <code>contrast</code> function and the <code>tf = exp</code>
option. Note that you will need to specify a field and a year, but since
the model does not contain any interactions between spray and those
variables the multiplicative effect of spray will not depend on the
field or year you specify.</p>
<p><strong>Solution</strong>: Here is how we could make inferences about
the spray effect using the <code>contrast</code> function.</p>
<pre class="r"><code>trtools::contrast(m, tf = exp,
    a = list(spray = &quot;yes&quot;, field = &quot;Ke&quot;, year = &quot;1992&quot;),
    b = list(spray = &quot;no&quot;, field = &quot;Ke&quot;, year = &quot;1992&quot;))</code></pre>
<pre><code> estimate  lower  upper
   0.6337 0.5273 0.7617</code></pre>
<p>Also we can “flip” the rate ratio.</p>
<pre class="r"><code>trtools::contrast(m, tf = exp,
    a = list(spray = &quot;no&quot;, field = &quot;Ke&quot;, year = &quot;1992&quot;),
    b = list(spray = &quot;yes&quot;, field = &quot;Ke&quot;, year = &quot;1992&quot;))</code></pre>
<pre><code> estimate lower upper
    1.578 1.313 1.897</code></pre>
<p>This shows that if a field is not sprayed the the expected number of
fledglings is about 1.58 (58%) higher than when it is sprayed. Again,
note that the field and year does not matter since there are no
interactions between spray and either of those variables, so the
multiplicative effect of spray will be the same regardless of the field
and year. You could verify this by specifying a different field and/or
year. Note that there are slight differences in the confidence intervals
obtained here and in the previous problem. That is because
<code>confint</code> computes a profile likelihood confidence interval
whereas <code>contrast</code> computes a Wald confidence interval. Also
note that while we were mainly interested in the effect of spray here,
we could easily compare different fields or years.</p>
<p>You can also use the <strong>emmeans</strong> package to estimate
rate ratios, provided that the explanatory variable in question is
categorical. Here is how you can use it to estimate the rate ratios for
every combination of year and field (note that they are all the same for
this model).</p>
<pre class="r"><code>library(emmeans)
pairs(emmeans(m, ~ spray | field*year), 
  type = &quot;response&quot;, infer = TRUE)</code></pre>
<pre><code>field = Ke, year = 1992:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Kr, year = 1992:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ku, year = 1992:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Rd, year = 1992:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ke, year = 1993:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Kr, year = 1993:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ku, year = 1993:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Rd, year = 1993:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ke, year = 1994:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Kr, year = 1994:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ku, year = 1994:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Rd, year = 1994:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ke, year = 1995:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Kr, year = 1995:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Ku, year = 1995:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

field = Rd, year = 1995:
 contrast ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 no / yes  1.58 0.148 Inf      1.31       1.9    1   4.860  &lt;.0001

Confidence level used: 0.95 
Intervals are back-transformed from the log scale 
Tests are performed on the log scale </code></pre></li>
<li><p>Use <code>contrast</code> to estimate the expected number of
fledglings with and without spraying for any given field or year.</p>
<p><strong>Solution</strong>: For example, the expected counts with and
without spraying for field <code>Ke</code> in 1992 is</p>
<pre class="r"><code>trtools::contrast(m, a = list(spray = c(&quot;yes&quot;,&quot;no&quot;), field = &quot;Ke&quot;, year = &quot;1992&quot;),
    tf = exp, cnames = c(&quot;spray&quot;,&quot;no spray&quot;))</code></pre>
<pre><code>         estimate lower upper
spray       19.59 15.07 25.45
no spray    30.91 23.83 40.08</code></pre>
<p>Also note that the ratio of these estimated expected counts (spray
divided by no spray) is about 0.63 which is what we estimated earlier.
If you wanted to estimate a bunch of expected counts it might be easier
to use <code>glmint</code>. Below I have estimated the estimated
expected count for every combination of spray, field, and year. Note
that <code>glmint</code> does not require you to specify a
transformation function. It knows what function to use based on the
model.</p>
<pre class="r"><code>d &lt;- expand.grid(spray = c(&quot;yes&quot;,&quot;no&quot;), field = c(&quot;Ke&quot;,&quot;Kr&quot;,&quot;Ku&quot;,&quot;Rd&quot;), 
    year = c(&quot;1992&quot;,&quot;1993&quot;,&quot;1994&quot;,&quot;1995&quot;))
cbind(d, glmint(m, newdata = d))</code></pre>
<pre><code>   spray field year   fit   low   upp
1    yes    Ke 1992 19.59 15.07 25.45
2     no    Ke 1992 30.91 23.83 40.08
3    yes    Kr 1992 20.57 15.50 27.31
4     no    Kr 1992 32.46 25.02 42.11
5    yes    Ku 1992 19.68 14.80 26.18
6     no    Ku 1992 31.06 23.88 40.39
7    yes    Rd 1992 16.38 12.46 21.52
8     no    Rd 1992 25.84 19.69 33.90
9    yes    Ke 1993 31.11 24.27 39.87
10    no    Ke 1993 49.09 38.46 62.65
11   yes    Kr 1993 32.67 25.64 41.63
12    no    Kr 1993 51.56 41.68 63.76
13   yes    Ku 1993 31.26 24.47 39.93
14    no    Ku 1993 49.33 39.77 61.19
15   yes    Rd 1993 26.01 20.05 33.74
16    no    Rd 1993 41.04 31.76 53.03
17   yes    Ke 1994 20.80 16.08 26.90
18    no    Ke 1994 32.82 25.42 42.37
19   yes    Kr 1994 21.84 16.52 28.88
20    no    Kr 1994 34.47 26.69 44.52
21   yes    Ku 1994 20.90 15.78 27.69
22    no    Ku 1994 32.98 25.47 42.70
23   yes    Rd 1994 17.39 13.29 22.76
24    no    Rd 1994 27.44 21.00 35.84
25   yes    Ke 1995 27.17 21.05 35.07
26    no    Ke 1995 42.87 33.35 55.11
27   yes    Kr 1995 28.54 22.24 36.62
28    no    Kr 1995 45.03 36.11 56.15
29   yes    Ku 1995 27.30 21.22 35.13
30    no    Ku 1995 43.09 34.46 53.88
31   yes    Rd 1995 22.72 17.39 29.67
32    no    Rd 1995 35.84 27.55 46.63</code></pre>
<p>Here <code>fit</code> is the estimated expected count, and
<code>low</code> and <code>upp</code> are the endpoints of the
confidence interval for the expected count. Note that even though
observations were not made at every combination of spray, field, and
year, we can still <em>estimate</em> the expected counts for each
combination. But we can only do this by assuming (implicitly when
specifying the model) that there are no interactions among these
variables. We could add a layer to the plot above to show the estimates
and confidence intervals for the expected counts.</p>
<pre class="r"><code>d &lt;- cbind(d, glmint(m, newdata = d))
p &lt;- p + geom_pointrange(aes(y = fit, ymin = low, ymax = upp), 
  shape = 21, fill = &quot;white&quot;, data = d) + geom_point()
plot(p)</code></pre>
<p><img src="lecture-03-25-2022_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;" />
Note that I “added” a layer after <code>geom_pointrange</code> to show
points corresponding to the observed counts so that they would be on top
of the points showing the estimated expected counts.</p>
<p>Here is how to use the <strong>emmeans</strong> package to estimate
the expected counts (rates) for each combination of spray, field, and
year.</p>
<pre class="r"><code>library(emmeans)
emmeans(m, ~ spray*field*year, type = &quot;response&quot;)</code></pre>
<pre><code> spray field year rate   SE  df asymp.LCL asymp.UCL
 no    Ke    1992 30.9 4.10 Inf      23.8      40.1
 yes   Ke    1992 19.6 2.62 Inf      15.1      25.4
 no    Kr    1992 32.5 4.31 Inf      25.0      42.1
 yes   Kr    1992 20.6 2.97 Inf      15.5      27.3
 no    Ku    1992 31.1 4.16 Inf      23.9      40.4
 yes   Ku    1992 19.7 2.87 Inf      14.8      26.2
 no    Rd    1992 25.8 3.58 Inf      19.7      33.9
 yes   Rd    1992 16.4 2.28 Inf      12.5      21.5
 no    Ke    1993 49.1 6.11 Inf      38.5      62.6
 yes   Ke    1993 31.1 3.94 Inf      24.3      39.9
 no    Kr    1993 51.6 5.59 Inf      41.7      63.8
 yes   Kr    1993 32.7 4.04 Inf      25.6      41.6
 no    Ku    1993 49.3 5.42 Inf      39.8      61.2
 yes   Ku    1993 31.3 3.90 Inf      24.5      39.9
 no    Rd    1993 41.0 5.37 Inf      31.8      53.0
 yes   Rd    1993 26.0 3.45 Inf      20.1      33.7
 no    Ke    1994 32.8 4.28 Inf      25.4      42.4
 yes   Ke    1994 20.8 2.73 Inf      16.1      26.9
 no    Kr    1994 34.5 4.50 Inf      26.7      44.5
 yes   Kr    1994 21.8 3.11 Inf      16.5      28.9
 no    Ku    1994 33.0 4.34 Inf      25.5      42.7
 yes   Ku    1994 20.9 3.00 Inf      15.8      27.7
 no    Rd    1994 27.4 3.74 Inf      21.0      35.8
 yes   Rd    1994 17.4 2.39 Inf      13.3      22.8
 no    Ke    1995 42.9 5.49 Inf      33.4      55.1
 yes   Ke    1995 27.2 3.54 Inf      21.1      35.1
 no    Kr    1995 45.0 5.07 Inf      36.1      56.1
 yes   Kr    1995 28.5 3.63 Inf      22.2      36.6
 no    Ku    1995 43.1 4.91 Inf      34.5      53.9
 yes   Ku    1995 27.3 3.51 Inf      21.2      35.1
 no    Rd    1995 35.8 4.81 Inf      27.6      46.6
 yes   Rd    1995 22.7 3.09 Inf      17.4      29.7

Confidence level used: 0.95 
Intervals are back-transformed from the log scale </code></pre>
<pre class="r"><code>emmeans(m, ~ spray|field*year, type = &quot;response&quot;)</code></pre>
<pre><code>field = Ke, year = 1992:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    30.9 4.10 Inf      23.8      40.1
 yes   19.6 2.62 Inf      15.1      25.4

field = Kr, year = 1992:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    32.5 4.31 Inf      25.0      42.1
 yes   20.6 2.97 Inf      15.5      27.3

field = Ku, year = 1992:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    31.1 4.16 Inf      23.9      40.4
 yes   19.7 2.87 Inf      14.8      26.2

field = Rd, year = 1992:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    25.8 3.58 Inf      19.7      33.9
 yes   16.4 2.28 Inf      12.5      21.5

field = Ke, year = 1993:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    49.1 6.11 Inf      38.5      62.6
 yes   31.1 3.94 Inf      24.3      39.9

field = Kr, year = 1993:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    51.6 5.59 Inf      41.7      63.8
 yes   32.7 4.04 Inf      25.6      41.6

field = Ku, year = 1993:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    49.3 5.42 Inf      39.8      61.2
 yes   31.3 3.90 Inf      24.5      39.9

field = Rd, year = 1993:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    41.0 5.37 Inf      31.8      53.0
 yes   26.0 3.45 Inf      20.1      33.7

field = Ke, year = 1994:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    32.8 4.28 Inf      25.4      42.4
 yes   20.8 2.73 Inf      16.1      26.9

field = Kr, year = 1994:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    34.5 4.50 Inf      26.7      44.5
 yes   21.8 3.11 Inf      16.5      28.9

field = Ku, year = 1994:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    33.0 4.34 Inf      25.5      42.7
 yes   20.9 3.00 Inf      15.8      27.7

field = Rd, year = 1994:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    27.4 3.74 Inf      21.0      35.8
 yes   17.4 2.39 Inf      13.3      22.8

field = Ke, year = 1995:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    42.9 5.49 Inf      33.4      55.1
 yes   27.2 3.54 Inf      21.1      35.1

field = Kr, year = 1995:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    45.0 5.07 Inf      36.1      56.1
 yes   28.5 3.63 Inf      22.2      36.6

field = Ku, year = 1995:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    43.1 4.91 Inf      34.5      53.9
 yes   27.3 3.51 Inf      21.2      35.1

field = Rd, year = 1995:
 spray rate   SE  df asymp.LCL asymp.UCL
 no    35.8 4.81 Inf      27.6      46.6
 yes   22.7 3.09 Inf      17.4      29.7

Confidence level used: 0.95 
Intervals are back-transformed from the log scale </code></pre></li>
</ol>
</div>
<div id="aflatoxicol-and-liver-tumors-in-trout" class="section level2">
<h2>Aflatoxicol and Liver Tumors in Trout</h2>
<p>The data in the data frame <code>ex2116</code> in the
<strong>Sleuth3</strong> package are from an experiment that
investigated the relationship between aflatoxicol and liver tumors in
trout. The figure below shows the proportion of trout in each tank that
developed liver tumors as well as the dose of aflatoxicol to which the
trout were exposed. Aflatoxicol is a metabolite of Aflatoxin B1, a toxic
by-product produced by a mold that infects some nuts and grains. Twenty
tanks of rainbow trout embryos were exposed to one of five doses of
aflatoxicol for one hour. The number of fish in each tank that developed
liver tumors one year later was then observed. The plot below shows the
data.</p>
<pre class="r"><code>library(Sleuth3)
library(ggplot2)
p &lt;- ggplot(ex2116, aes(x = Dose, y = Tumor/Total)) + 
   geom_point(alpha = 0.5) + theme_classic() + ylim(0, 1) + 
   labs(x = &quot;Dose (ppm)&quot;, y = &quot;Proportion of Trout With Liver Tumors&quot;)
plot(p)</code></pre>
<p><img src="lecture-03-25-2022_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;" />
The goal here is to estimate the effect of aflatoxicol on the risk of
liver tumors in trout. Here we will consider three different logistic
regression models.</p>
<ol style="list-style-type: decimal">
<li><p>Consider the logistic regression model <span
class="math display">\[
\log\left[\frac{E(Y_i)}{1-E(Y_i)}\right] = \beta_0 + \beta_1 d_i,
\]</span> where <span class="math inline">\(Y_i\)</span> is the <span
class="math inline">\(i\)</span>-th observation of the proportion of
trout from a tank that developed liver tumors and <span
class="math inline">\(d_i\)</span> is the corresponding dose of
aflatoxicol to which those trout were exposed. This model can also be
written as <span class="math display">\[
E(Y_i) = \frac{e^{\eta_i}}{1 + e^{\eta_i}},
\]</span> where <span class="math inline">\(\eta_i = \beta_0 + \beta_1
d_i\)</span>. Note that by definition <span
class="math inline">\(E(Y_i)\)</span> is also the <em>probability</em>
that a trout from a given tank will develop liver tumors, and <span
class="math inline">\(E(Y_i)/[1-E(Y_i)]\)</span> is the <em>odds</em>
that a trout from a given tank will develop liver tumors. Estimate this
model using <code>glm</code>. You should be able to replicate the
following results.</p>
<pre class="r"><code>cbind(summary(m)$coefficients, confint(m))</code></pre>
<pre><code>            Estimate Std. Error z value  Pr(&gt;|z|)  2.5 %  97.5 %
(Intercept)   -0.867    0.07673   -11.3 1.321e-29 -1.019 -0.7179
Dose          14.334    0.93695    15.3 7.838e-53 12.558 16.2346</code></pre>
<p>Next estimate the odds ratio for the effect of increasing dose by
0.05 ppm using the <code>contrast</code> function.<a href="#fn3"
class="footnote-ref" id="fnref3"><sup>3</sup></a> Remember to use the
<code>tf = exp</code> option. You should find that increasing dose by
0.05 ppm is estimated to increase the odds of tumor development by a
factor of about 2.05 (i.e., approximately a 105% increase in the odds of
tumor development). That is the odds ratio for the effect of increasing
dose by 0.05 ppm.</p>
<p><strong>Solution</strong>: We can estimate the model as follows.</p>
<pre class="r"><code>m1 &lt;- glm(cbind(Tumor, Total-Tumor) ~ Dose, family = binomial, data = ex2116)
cbind(summary(m1)$coefficients, confint(m1))</code></pre>
<pre><code>            Estimate Std. Error z value  Pr(&gt;|z|)  2.5 %  97.5 %
(Intercept)   -0.867    0.07673   -11.3 1.321e-29 -1.019 -0.7179
Dose          14.334    0.93695    15.3 7.838e-53 12.558 16.2346</code></pre>
<p>Now we can use <code>contrast</code> to estimate the odds ratio.</p>
<pre class="r"><code>trtools::contrast(m1, a = list(Dose = 0.1), b = list(Dose = 0.05), tf = exp)</code></pre>
<pre><code> estimate lower upper
    2.048 1.868 2.245</code></pre>
<p>Note that the same odds ratio would be obtained for any two values of
dose that differ by 0.05 ppm. Note that if you computed <span
class="math inline">\(e^{\beta_1}\)</span> you would be estimating the
odds ratio for the effect of increasing dose by 1 ppm (which is quite a
bit given that in the study dose varied from 0 to 0.25 ppm). Note that
you can also use <code>contrast</code> to estimate the odds of tumor
development at any value of dose. Here I will do it for the values of
dose used in the study, but we could use any (reasonable) value of
dose.</p>
<pre class="r"><code>trtools::contrast(m1, a = list(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25)), tf = exp,
    cnames = c(&quot;0.01 ppm&quot;,&quot;0.025 ppm&quot;,&quot;0.05 ppm&quot;,&quot;0.1 ppm&quot;,&quot;0.25 ppm&quot;))</code></pre>
<pre><code>          estimate   lower   upper
0.01 ppm    0.4850  0.4225  0.5566
0.025 ppm   0.6013  0.5323  0.6792
0.05 ppm    0.8604  0.7736  0.9570
0.1 ppm     1.7618  1.5471  2.0062
0.25 ppm   15.1257 10.4786 21.8338</code></pre>
<p>Note that the odds ratio we computed above is simply the ratio of the
odds at 0.1 ppm and 0.05 ppm. The probability of tumor development at a
given dose can also be obtained using <code>contrast</code> with the
<code>tf = plogis</code> option.</p>
<pre class="r"><code>trtools::contrast(m1, a = list(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25)), tf = plogis,
    cnames = c(&quot;0.01 ppm&quot;,&quot;0.025 ppm&quot;,&quot;0.05 ppm&quot;,&quot;0.1 ppm&quot;,&quot;0.25 ppm&quot;))</code></pre>
<pre><code>          estimate  lower  upper
0.01 ppm    0.3266 0.2970 0.3576
0.025 ppm   0.3755 0.3474 0.4045
0.05 ppm    0.4625 0.4362 0.4890
0.1 ppm     0.6379 0.6074 0.6674
0.25 ppm    0.9380 0.9129 0.9562</code></pre>
<p>Note that <code>glmint</code> can also be used to obtain the
estimated probabilities.</p>
<pre class="r"><code>d &lt;- data.frame(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25))
cbind(d, glmint(m1, newdata = d))</code></pre>
<pre><code>   Dose    fit    low    upp
1 0.010 0.3266 0.2970 0.3576
2 0.025 0.3755 0.3474 0.4045
3 0.050 0.4625 0.4362 0.4890
4 0.100 0.6379 0.6074 0.6674
5 0.250 0.9380 0.9129 0.9562</code></pre></li>
<li><p>Now consider a model where we use the base-2 logarithm of dose as
the explanatory variable so that <span class="math display">\[\eta_i =
\beta_0 + \beta_1 \log_2(d_i).\]</span> Recall that the function <span
class="math inline">\(\log_2\)</span> is known to R as
<code>log2</code>. Estimate this model using <code>glm</code>. You
should be able to replicate the following results.</p>
<pre class="r"><code>cbind(summary(m)$coefficients, confint(m))</code></pre>
<pre><code>            Estimate Std. Error z value  Pr(&gt;|z|)  2.5 % 97.5 %
(Intercept)   4.1634     0.2085   19.97 9.564e-89 3.7631  4.581
log2(Dose)    0.8997     0.0446   20.17 1.628e-90 0.8141  0.989</code></pre>
<p>Here increasing the base-2 logarithm of dose by one unit is the same
thing as <em>doubling</em> dose, and so the effect on the odds ratio of
doubling dose will be the same regardless of what you double (e.g., 0.05
to 1 ppm, 0.1 to 0.2 ppm, etc.).<a href="#fn4" class="footnote-ref"
id="fnref4"><sup>4</sup></a> Confirm that the odds ratio for the effect
of doubling dose is approximately 2.46, which is approximately a 146%
increase in the odds of tumor development. That is, doubling dose will
increase the odds of tumor development by a factor of about 2.46. Also
confirm that these odds ratios do not depend on the <em>base</em> of the
logarithm by trying the natural logarithm with the model <span
class="math inline">\(\eta_i = \beta_0 + \beta_1 \log(d_i)\)</span>.</p>
<p><strong>Solution</strong>: We can estimate the model as follows.</p>
<pre class="r"><code>m2 &lt;- glm(cbind(Tumor, Total-Tumor) ~ log2(Dose), family = binomial, data = ex2116)
cbind(summary(m2)$coefficients, confint(m2))</code></pre>
<pre><code>            Estimate Std. Error z value  Pr(&gt;|z|)  2.5 % 97.5 %
(Intercept)   4.1634     0.2085   19.97 9.564e-89 3.7631  4.581
log2(Dose)    0.8997     0.0446   20.17 1.628e-90 0.8141  0.989</code></pre>
<p>Now we can use <code>contrast</code> to estimate the odds ratio.</p>
<pre class="r"><code>trtools::contrast(m2, a = list(Dose = 0.1), b = list(Dose = 0.05), tf = exp)</code></pre>
<pre><code> estimate lower upper
    2.459 2.253 2.684</code></pre>
<p>Note that the same odds ratio would be obtained for any two values of
dose that differ by a factor of 2.</p></li>
<li><p>Rather than trying to decide between using dose or some
transformation of dose in the model, we can instead define dose as a
5-level factor. There are two ways we could specify dose as a factor.
One would be to create a new variable.</p>
<pre class="r"><code>ex2116$Dosef &lt;- factor(ex2116$Dose)</code></pre>
<p>The levels of <code>Dosef</code> will be the original values of
<code>Dose</code> but converted to strings, which we can see if we use
the <code>levels</code> function.</p>
<pre class="r"><code>levels(ex2116$Dosef)</code></pre>
<pre><code>[1] &quot;0.01&quot;  &quot;0.025&quot; &quot;0.05&quot;  &quot;0.1&quot;   &quot;0.25&quot; </code></pre>
<p>Another approach is to replace <code>Dose</code> in the model formula
with <code>factor(Dose)</code>. Use the <code>contrast</code> function
to estimate the odds ratio for the odds of tumor development at 0.025
ppm versus 0.01 ppm, 0.05 ppm versus 0.01 ppm, 0.1 ppm versus 0.01 ppm,
and 0.25 ppm versus 0.01 ppm.<a href="#fn5" class="footnote-ref"
id="fnref5"><sup>5</sup></a> You should find that these odds ratios are
approximately 7.94, 22.92, 48.91, and 70.84. Thus, for example, at a
dose of 0.025 ppm the odds of tumor development is about 7.94 times
higher than it is at a dose of 0.01 ppm (i.e., about 694% higher).</p>
<p><strong>Solution</strong>: Here is how we can estimate this
model.</p>
<pre class="r"><code>m3 &lt;- glm(cbind(Tumor, Total-Tumor) ~ factor(Dose), family = binomial, data = ex2116)
cbind(summary(m3)$coefficients, confint(m3))</code></pre>
<pre><code>                  Estimate Std. Error z value  Pr(&gt;|z|)  2.5 % 97.5 %
(Intercept)         -2.556     0.2076 -12.310 8.049e-35 -2.988 -2.171
factor(Dose)0.025    2.073     0.2353   8.809 1.264e-18  1.628  2.553
factor(Dose)0.05     3.132     0.2354  13.306 2.130e-40  2.688  3.614
factor(Dose)0.1      3.890     0.2453  15.857 1.252e-56  3.427  4.391
factor(Dose)0.25     4.260     0.2566  16.605 6.436e-62  3.775  4.784</code></pre>
<pre class="r"><code>trtools::contrast(m3,
    a = list(Dose = c(0.025,0.05,0.1,0.25)),
    b = list(Dose = 0.01), tf = exp,
    cnames = c(&quot;0.025 vs 0.01 ppm&quot;,&quot;0.05 vs 0.01 ppm&quot;,&quot;0.1 vs 0.01 ppm&quot;,&quot;0.25 vs 0.01 ppm&quot;))</code></pre>
<pre><code>                  estimate lower  upper
0.025 vs 0.01 ppm    7.945  5.01  12.60
0.05 vs 0.01 ppm    22.920 14.45  36.36
0.1 vs 0.01 ppm     48.909 30.24  79.10
0.25 vs 0.01 ppm    70.840 42.84 117.13</code></pre>
<p>Note that we do not necessarily need to put the dose values in quotes
since they will be converted to labels anyway. Since the 0.01 ppm level
is the reference category we can also obtain the odds ratios by applying
the exponential function to the parameter estimates.</p>
<pre class="r"><code>exp(cbind(coef(m3), confint(m3)))</code></pre>
<pre><code>                              2.5 %   97.5 %
(Intercept)        0.07764  0.05038   0.1141
factor(Dose)0.025  7.94467  5.09246  12.8513
factor(Dose)0.05  22.92031 14.70370  37.1110
factor(Dose)0.1   48.90919 30.77256  80.7191
factor(Dose)0.25  70.84000 43.61279 119.5297</code></pre>
<p>Again note that the confidence intervals are slightly different
because <code>contrast</code> computes Wald confidence intervals whereas
<code>confint</code> computes profile likelihood confidence intervals.
Since dose is being treated as a categorical variable, we can also use
functions from the <strong>emmeans</strong> package to estimate these
odds ratios. Using <code>pairs</code> provides odds ratios for all pairs
of dose levels.</p>
<pre class="r"><code>library(emmeans)
pairs(emmeans(m3, ~Dose, type = &quot;response&quot;), 
  adjust = &quot;none&quot;, infer = TRUE)</code></pre>
<pre><code> contrast     odds.ratio      SE  df asymp.LCL asymp.UCL null z.ratio p.value
 0.01 / 0.025     0.1259 0.02961 Inf    0.0794    0.1996    1  -8.809  &lt;.0001
 0.01 / 0.05      0.0436 0.01027 Inf    0.0275    0.0692    1 -13.306  &lt;.0001
 0.01 / 0.1       0.0204 0.00502 Inf    0.0126    0.0331    1 -15.857  &lt;.0001
 0.01 / 0.25      0.0141 0.00362 Inf    0.0085    0.0233    1 -16.605  &lt;.0001
 0.025 / 0.05     0.3466 0.05431 Inf    0.2550    0.4712    1  -6.762  &lt;.0001
 0.025 / 0.1      0.1624 0.02781 Inf    0.1161    0.2272    1 -10.614  &lt;.0001
 0.025 / 0.25     0.1121 0.02097 Inf    0.0777    0.1618    1 -11.699  &lt;.0001
 0.05 / 0.1       0.4686 0.08031 Inf    0.3349    0.6557    1  -4.423  &lt;.0001
 0.05 / 0.25      0.3236 0.06055 Inf    0.2242    0.4669    1  -6.029  &lt;.0001
 0.1 / 0.25       0.6904 0.13774 Inf    0.4670    1.0208    1  -1.857  0.0633

Confidence level used: 0.95 
Intervals are back-transformed from the log odds ratio scale 
Tests are performed on the log odds ratio scale </code></pre>
<p>By default the odds ratios are computed here with the odds for a
tumor for the larger dose in the denominator. We can reverse these odds
ratios to put the odds corresponding to the larger dose in the
numerator.</p>
<pre class="r"><code>pairs(emmeans(m3, ~Dose, type = &quot;response&quot;), adjust = &quot;none&quot;, 
  rev = TRUE, infer = TRUE)</code></pre>
<pre><code> contrast     odds.ratio     SE  df asymp.LCL asymp.UCL null z.ratio p.value
 0.025 / 0.01       7.94  1.869 Inf      5.01     12.60    1   8.809  &lt;.0001
 0.05 / 0.01       22.92  5.395 Inf     14.45     36.36    1  13.306  &lt;.0001
 0.05 / 0.025       2.88  0.452 Inf      2.12      3.92    1   6.762  &lt;.0001
 0.1 / 0.01        48.91 11.998 Inf     30.24     79.10    1  15.857  &lt;.0001
 0.1 / 0.025        6.16  1.054 Inf      4.40      8.61    1  10.614  &lt;.0001
 0.1 / 0.05         2.13  0.366 Inf      1.53      2.99    1   4.423  &lt;.0001
 0.25 / 0.01       70.84 18.176 Inf     42.84    117.13    1  16.605  &lt;.0001
 0.25 / 0.025       8.92  1.668 Inf      6.18     12.86    1  11.699  &lt;.0001
 0.25 / 0.05        3.09  0.578 Inf      2.14      4.46    1   6.029  &lt;.0001
 0.25 / 0.1         1.45  0.289 Inf      0.98      2.14    1   1.857  0.0633

Confidence level used: 0.95 
Intervals are back-transformed from the log odds ratio scale 
Tests are performed on the log odds ratio scale </code></pre>
<p>Using the <code>contrast</code> function from the
<strong>emmeans</strong> package (which is different from the function
of the same name in the <strong>trtools</strong> package) we can also
obtain odds ratios for comparing against a given level, such as the
lowest dose.</p>
<pre class="r"><code>contrast(emmeans(m3, ~Dose, type = &quot;response&quot;), method = &quot;trt.vs.ctrl&quot;,
  ref = 1, adjust = &quot;none&quot;, infer = TRUE)</code></pre>
<pre><code> contrast     odds.ratio    SE  df asymp.LCL asymp.UCL null z.ratio p.value
 0.025 / 0.01       7.94  1.87 Inf      5.01      12.6    1   8.809  &lt;.0001
 0.05 / 0.01       22.92  5.39 Inf     14.45      36.4    1  13.306  &lt;.0001
 0.1 / 0.01        48.91 12.00 Inf     30.24      79.1    1  15.857  &lt;.0001
 0.25 / 0.01       70.84 18.18 Inf     42.84     117.1    1  16.605  &lt;.0001

Confidence level used: 0.95 
Intervals are back-transformed from the log odds ratio scale 
Tests are performed on the log odds ratio scale </code></pre>
<p>The <code>ref = 1</code> indicates that we want odds ratios relative
to the first level.</p></li>
<li><p>Use <code>contrast</code> to estimate the odds and probability of
tumor development at each value of dose used in the study for any of the
three models.</p>
<p><strong>Solution</strong>: I will use the model in which dose was
specified as a factor, but the syntax would be the same for any of the
models. The estimated odds can be computed as follows.</p>
<pre class="r"><code>trtools::contrast(m3, a = list(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25)), 
  tf = exp, cnames = c(&quot;0.01 ppm&quot;,&quot;0.025 ppm&quot;,&quot;0.05 ppm&quot;,&quot;0.1 ppm&quot;,&quot;0.25 ppm&quot;))</code></pre>
<pre><code>          estimate   lower  upper
0.01 ppm   0.07764 0.05168 0.1166
0.025 ppm  0.61682 0.49654 0.7662
0.05 ppm   1.77953 1.43188 2.2116
0.1 ppm    3.79730 2.93938 4.9056
0.25 ppm   5.50000 4.09298 7.3907</code></pre>
<p>The estimated probabilities can be computed as follows.</p>
<pre class="r"><code>trtools::contrast(m3, a = list(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25)), 
  tf = plogis, cnames = c(&quot;0.01 ppm&quot;,&quot;0.025 ppm&quot;,&quot;0.05 ppm&quot;,&quot;0.1 ppm&quot;,&quot;0.25 ppm&quot;))</code></pre>
<pre><code>          estimate   lower  upper
0.01 ppm   0.07205 0.04914 0.1044
0.025 ppm  0.38150 0.33179 0.4338
0.05 ppm   0.64023 0.58880 0.6886
0.1 ppm    0.79155 0.74615 0.8307
0.25 ppm   0.84615 0.80365 0.8808</code></pre>
<p>Here is a tip. We took advantage of the fact that the R function
<code>plogis</code> is the mathematical function <span
class="math inline">\(e^z/(1+e^z)\)</span>. But what if we wanted to use
a function unknown to R. We can define the function as the argument.</p>
<pre class="r"><code>trtools::contrast(m3, a = list(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25)), 
  tf = function(z) exp(z)/(1 + exp(z)), 
  cnames = c(&quot;0.01 ppm&quot;,&quot;0.025 ppm&quot;,&quot;0.05 ppm&quot;,&quot;0.1 ppm&quot;,&quot;0.25 ppm&quot;))</code></pre>
<pre><code>          estimate   lower  upper
0.01 ppm   0.07205 0.04914 0.1044
0.025 ppm  0.38150 0.33179 0.4338
0.05 ppm   0.64023 0.58880 0.6886
0.1 ppm    0.79155 0.74615 0.8307
0.25 ppm   0.84615 0.80365 0.8808</code></pre>
<p>Alternatively you could define the function prior to using
<code>contrast</code>.</p>
<pre class="r"><code>myfunction &lt;- function(z) {
  exp(z)/(1 + exp(z))
}
trtools::contrast(m3, a = list(Dose = c(0.01, 0.025, 0.05, 0.1, 0.25)), 
  tf = myfunction, cnames = c(&quot;0.01 ppm&quot;,&quot;0.025 ppm&quot;,&quot;0.05 ppm&quot;,&quot;0.1 ppm&quot;,&quot;0.25 ppm&quot;))</code></pre>
<pre><code>          estimate   lower  upper
0.01 ppm   0.07205 0.04914 0.1044
0.025 ppm  0.38150 0.33179 0.4338
0.05 ppm   0.64023 0.58880 0.6886
0.1 ppm    0.79155 0.74615 0.8307
0.25 ppm   0.84615 0.80365 0.8808</code></pre>
<p>It is also useful to note that you can use <code>glmint</code> to
estimate the probabilities.</p>
<pre class="r"><code>d &lt;- data.frame(Dose = c(0.01,0.025,0.05,0.1,0.25))
glmint(m3, newdata = d)</code></pre>
<pre><code>      fit     low    upp
1 0.07205 0.04914 0.1044
2 0.38150 0.33179 0.4338
3 0.64023 0.58880 0.6886
4 0.79155 0.74615 0.8307
5 0.84615 0.80365 0.8808</code></pre>
<pre class="r"><code>cbind(d, glmint(m3, newdata = d))</code></pre>
<pre><code>   Dose     fit     low    upp
1 0.010 0.07205 0.04914 0.1044
2 0.025 0.38150 0.33179 0.4338
3 0.050 0.64023 0.58880 0.6886
4 0.100 0.79155 0.74615 0.8307
5 0.250 0.84615 0.80365 0.8808</code></pre>
<p>One last way to do this is using the <strong>emmeans</strong>
package. It works well when the explanatory variable(s) is/are all
categorical (i.e., factors), but is much more limited when the response
variable(s) is/are quantitative.</p>
<pre class="r"><code>library(emmeans)
emmeans(m, ~ Dose, type = &quot;response&quot;)</code></pre>
<pre><code>  Dose  prob     SE  df asymp.LCL asymp.UCL
 0.010 0.072 0.0139 Inf    0.0491     0.104
 0.025 0.382 0.0261 Inf    0.3318     0.434
 0.050 0.640 0.0255 Inf    0.5888     0.689
 0.100 0.791 0.0216 Inf    0.7462     0.831
 0.250 0.846 0.0196 Inf    0.8037     0.881

Confidence level used: 0.95 
Intervals are back-transformed from the logit scale </code></pre></li>
</ol>
<p>Here are plots of the three models we considered.</p>
<pre class="r"><code>p &lt;- ggplot(ex2116, aes(x = Dose, y = Tumor/Total)) + 
   geom_point(alpha = 0.5) + theme_classic() + ylim(0, 1) + 
   labs(x = &quot;Dose (ppm)&quot;, y = &quot;Proportion of Trout With Liver Tumors&quot;)

m &lt;- glm(cbind(Tumor, Total-Tumor) ~ Dose, family = binomial, data = ex2116)
d &lt;- data.frame(Dose = seq(0.01, 0.25, length = 100))
d$yhat &lt;- predict(m, newdata = d, type = &quot;response&quot;)
p1 &lt;- p + geom_line(aes(y = yhat), data = d) + ggtitle(&quot;Dose&quot;)

m &lt;- glm(cbind(Tumor, Total-Tumor) ~ log2(Dose), family = binomial, data = ex2116)
d &lt;- data.frame(Dose = seq(0.01, 0.25, length = 100))
d$yhat &lt;- predict(m, newdata = d, type = &quot;response&quot;)
p2 &lt;- p + geom_line(aes(y = yhat), data = d) + ggtitle(&quot;Log Dose&quot;)

m &lt;- glm(cbind(Tumor, Total-Tumor) ~ factor(Dose), family = binomial, data = ex2116)
d &lt;- data.frame(Dose = unique(ex2116$Dose))
d$yhat &lt;- predict(m, newdata = d, type = &quot;response&quot;)
p3 &lt;- p + geom_point(aes(y = yhat), data = d, pch = 3, size = 3) + ggtitle(&quot;Dose as Factor&quot;)

cowplot::plot_grid(p1, p2, p3, nrow = 1) </code></pre>
<p><img src="lecture-03-25-2022_files/figure-html/unnamed-chunk-38-1.png" width="100%" style="display: block; margin: auto;" />
Note that the three models do not appear to fit the data equally well.
Using the logarithm of dose as an explanatory variable appears to be a
better fit than using dose, but both models appear to systematically
over-estimate or under-estimate the probability of tumor development.
Treating dose as a factor may be a better model here. This is even more
clear when looking at residual plots.</p>
<pre class="r"><code>m1 &lt;- glm(cbind(Tumor, Total-Tumor) ~ Dose, family = binomial, data = ex2116)
m2 &lt;- glm(cbind(Tumor, Total-Tumor) ~ log2(Dose), family = binomial, data = ex2116)
m3 &lt;- glm(cbind(Tumor, Total-Tumor) ~ factor(Dose), family = binomial, data = ex2116)

d1 &lt;- ex2116
d1$yhat &lt;- predict(m1)
d1$residual &lt;- rstudent(m1)

d2 &lt;- ex2116
d2$yhat &lt;- predict(m2)
d2$residual &lt;- rstudent(m2)

d3 &lt;- ex2116
d3$yhat &lt;- predict(m3)
d3$residual &lt;- rstudent(m3)

p &lt;- ggplot(d1, aes(x = yhat, y = residual)) + theme_classic()
p &lt;- p + geom_point(alpha = 0.5) + ylim(-8,6) + geom_hline(yintercept = c(-2,2), linetype = 3)
p &lt;- p + labs(x = &quot;Predicted Log-Odds&quot;, y = &quot;Studentized Residual&quot;)
p1 &lt;- p + ggtitle(&quot;Dose&quot;)

p &lt;- ggplot(d2, aes(x = yhat, y = residual)) + theme_classic()
p &lt;- p + geom_point(alpha = 0.5) + ylim(-8,6) + geom_hline(yintercept = c(-2,2), linetype = 3)
p &lt;- p + labs(x = &quot;Predicted Log-Odds&quot;, y = NULL)
p2 &lt;- p + ggtitle(&quot;Log Dose&quot;)

p &lt;- ggplot(d3, aes(x = yhat, y = residual)) + theme_classic()
p &lt;- p + geom_point(alpha = 0.5) + ylim(-8,6) + geom_hline(yintercept = c(-2,2), linetype = 3)
p &lt;- p + labs(x = &quot;Predicted Log-Odds&quot;, y = NULL)
p3 &lt;- p + ggtitle(&quot;Dose as Factor&quot;)

cowplot::plot_grid(p1, p2, p3, nrow = 1) </code></pre>
<p><img src="lecture-03-25-2022_files/figure-html/unnamed-chunk-39-1.png" width="100%" style="display: block; margin: auto;" />
Based on the residuals, the model with dose as a factor appears to
provide the best fit to the data. But there may be another model that
uses dose as a quantitative explanatory variable (i.e., not a factor)
that would be a good fit to these data.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>Odderskær, P., Prang, A., Eknegaard, N., &amp; Andersen,
P. N. (1997). Skylark reproduction in pesticide treated fields
(Comparative studies of Alauda arvensis breeding performance in sprayed
and unsprayed barley fields). <em>Bekæmpelsesmiddelforskning fra
Miljøstyrelsennr</em>, 32, National Environmental Research Institute,
Ministry of the Environment and Energy, Denmark: Danish Environmental
Protection Agency.<a href="#fnref1"
class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>A fractional factorial design is a design in which
observations are made at only a subset of the possible combinations of
levels of two or more factors. Such designs are quite economical but can
preclude the estimation of interactions. This does not mean that such
interactions are not present, but rather that if they are they are
confounded with the main effects. For this particular design it is only
possible to fully estimate a model with “main effects” for each of the
three factors. Ideally factional factorial designs are used when
interactions are negligible.<a href="#fnref2"
class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Here <span class="math inline">\(e^{\beta_1}\)</span>
would be the odds ratio for the effect of increasing dose by 1 ppm.
However that is probably not a realistic effect as it would be a
relatively large increase in dose. The study only considered up to 0.25
ppm. Using <code>contrast</code> is convenient here to estimate the odds
ratio for the effect of an arbitrary change in dose.<a href="#fnref3"
class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>We do not have to use the odds ratio for the effect of
doubling dose just because we are using the base-2 logarithm of dose as
our explanatory variable. We could also estimate the odds ratio for the
effect of increasing dose from, say, 0.05 ppm to 0.1 ppm. But we would
need to remember that because we are using the base-2 logarithm of dose
as an explanatory variable that this would <em>not</em> be the same odds
ratio as increasing dose the same amount from, say, 0.1 ppm to 0.15 ppm.
Similarly for the previous model where we did not use the base-2
logarithm of dose, we could still estimate the odds ratio for the effect
of doubling dose. But here we would need to remember that the odds ratio
of doubling from, say, 0.05 ppm to 0.1 ppm would <em>not</em> be the
same as the odds ratio for doubling from 0.1 ppm to 0.2 ppm.<a
href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>Note that how you specify the levels of dose will depend
on whether you created a new variable like <code>Dosef</code> or
converted it to a factor within the model formula with
<code>factor(Dose)</code>. For the latter you will need to specify dose
as a <em>number</em> but if you created it to a new variable you will
need to specify it as a <em>string</em> by enclosing it in quotes.<a
href="#fnref5" class="footnote-back">↩︎</a></p></li>
</ol>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
