<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Wednesday, Feb 23</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Statistics 436/516</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="lectures.html">Lectures</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Wednesday, Feb 23</h1>

</div>


<p>You can also download a <a href="lecture-02-23-2022.pdf">PDF</a> copy of this lecture.</p>
<div id="iteratively-weighted-least-squares" class="section level2">
<h2>Iteratively Weighted Least Squares</h2>
<p><em>Iteratively weighted least squares</em> can be used when we assume that the variance is proportional to a function of the mean so that <span class="math display">\[
  \text{Var}(Y_i) \propto h[E(Y_i)],
\]</span> where <span class="math inline">\(h\)</span> is some specified function, implying that our weights should be <span class="math display">\[
  w_i = \frac{1}{h[E(Y_i)]}.
\]</span> Because <span class="math inline">\(E(Y_i)\)</span> is unknown we can use the estimate <span class="math inline">\(\hat{y}_i\)</span> to obtain weights <span class="math display">\[
  w_i = \frac{1}{h(\hat{y}_i)}.
\]</span><br />
Because <span class="math inline">\(\hat{y}_i\)</span> depends on the weights used in the weighted least squares algorithm, and <span class="math inline">\(w_i\)</span> depends on <span class="math inline">\(\hat{y}_i\)</span>, we can use the following algorithm known as <em>iteratively weighted least squares</em>.</p>
<ol style="list-style-type: decimal">
<li><p>Estimate the model using <em>ordinary least squares</em> where all <span class="math inline">\(w_i\)</span> = 1.</p></li>
<li><p>Compute weights as <span class="math inline">\(w_i = 1/h(\hat{y}_i)\)</span>.</p></li>
<li><p>Estimate the model using <em>weighted least squares</em> with the weights <span class="math inline">\(w_i = 1/h(\hat{y}_i)\)</span>.</p></li>
</ol>
<p>The second and third steps can be repeated until the estimates and thus the weights stop changing. Typically only a few iterations are necessary.</p>
<p><strong>Example</strong>: Consider again following data from a study on the effects of fuel reduction on biomass.</p>
<pre class="r"><code>library(trtools) # for biomass data

m.ols &lt;- lm(suitable ~ -1 + treatment:total, data = biomass)
summary(m.ols)$coefficients</code></pre>
<pre><code>                 Estimate Std. Error t value Pr(&gt;|t|)
treatmentn:total   0.1056    0.04183   2.524 1.31e-02
treatmenty:total   0.1319    0.01121  11.773 7.61e-21</code></pre>
<pre class="r"><code>d &lt;- expand.grid(treatment = c(&quot;n&quot;,&quot;y&quot;), total = seq(0, 2767, length = 10))
d$yhat &lt;- predict(m.ols, newdata = d)

p &lt;- ggplot(biomass, aes(x = total, y = suitable, color = treatment)) + 
  geom_point() + geom_line(aes(y = yhat), data = d) + theme_minimal() + 
  labs(x = &quot;Total Biomass (kg/ha)&quot;, y = &quot;Suitable Biomass (kg/ha)&quot;,
    color = &quot;Treatment&quot;)
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-2-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>biomass$yhat &lt;- predict(m.ols)
biomass$rest &lt;- rstudent(m.ols)

p &lt;- ggplot(biomass, aes(x = yhat, y = rest, color = treatment)) + 
  geom_point() + theme_minimal() + 
  labs(x = &quot;Predicted Value&quot;, y = &quot;Studentized Residual&quot;, 
    color = &quot;Treatment&quot;)
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-2-2.png" width="100%" style="display: block; margin: auto;" /> Assume that <span class="math inline">\(\text{Var}(Y_i) \propto E(Y_i)\)</span>, which means the weights should be <span class="math inline">\(w_i = 1/E(Y_i)\)</span>. We can program the iteratively weighted least squares algorithm as follows.</p>
<pre class="r"><code>biomass$w &lt;- 1 # initial weights are all equal to one
for (i in 1:5) {
  m.wls &lt;- lm(suitable ~ -1 + treatment:total, weights = w, data = biomass)
  print(coef(m.wls)) # optional
  biomass$w &lt;- 1 / predict(m.wls)
}</code></pre>
<pre><code>treatmentn:total treatmenty:total 
          0.1056           0.1319 
treatmentn:total treatmenty:total 
          0.1155           0.1578 
treatmentn:total treatmenty:total 
          0.1155           0.1578 
treatmentn:total treatmenty:total 
          0.1155           0.1578 
treatmentn:total treatmenty:total 
          0.1155           0.1578 </code></pre>
<p>Now let’s take a look at the residuals.</p>
<pre class="r"><code>biomass$yhat &lt;- predict(m.wls)
biomass$rest &lt;- rstudent(m.wls)

p &lt;- ggplot(biomass, aes(x = yhat, y = rest, color = treatment)) + 
  geom_point() + theme_minimal() + 
  labs(x = &quot;Predicted Value&quot;, y = &quot;Studentized Residual&quot;, 
    color = &quot;Treatment&quot;)
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;" /> That may not be quite enough. Suppose we assume that <span class="math inline">\(\text{Var}(Y_i) \propto E(Y_i)^p\)</span> where <span class="math inline">\(p\)</span> = 2.</p>
<pre class="r"><code>biomass$w &lt;- 1 # initial weights are all equal to one
for (i in 1:5) {
  m.wls &lt;- lm(suitable ~ -1 + treatment:total, weights = w, data = biomass)
  biomass$w &lt;- 1 / predict(m.wls)^2
}</code></pre>
<p>Now let’s take a look at the residuals.</p>
<pre class="r"><code>biomass$yhat &lt;- predict(m.wls)
biomass$rest &lt;- rstudent(m.wls)

p &lt;- ggplot(biomass, aes(x = yhat, y = rest, color = treatment)) + 
  geom_point() + theme_minimal() + 
  labs(x = &quot;Predicted Value&quot;, y = &quot;Studentized Residual&quot;, 
    color = &quot;Treatment&quot;)
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-6-1.png" width="100%" style="display: block; margin: auto;" /> Better. Maybe too much? We could try <span class="math inline">\(p\)</span> = 1.5 or something like that. The residuals do get a little strange for higher predicted values, but we’ll leave it here.</p>
<p>The model is <span class="math inline">\(E(S_i) = \beta_1n_it_i + \beta_2y_it_i\)</span>, where <span class="math inline">\(n_i\)</span> and <span class="math inline">\(y_i\)</span> are indicator variables for if the <span class="math inline">\(i\)</span>-th plot was treated or not by fuel reduction. We can also write the model as <span class="math display">\[
  E(S_i) = 
  \begin{cases}
    \beta_1t_i, &amp; \text{if the $i$-th plot was not treated by fuel reduction,} \\
    \beta_2t_i, &amp; \text{if the $i$-th plot was treated by fuel reduction}.
  \end{cases}
\]</span> We can use <span class="math inline">\(\beta_2-\beta_1\)</span> for inferences about the treatment effect.</p>
<pre class="r"><code>lincon(m.ols, a = c(-1,1)) </code></pre>
<pre><code>         estimate     se    lower  upper tvalue  df pvalue
(-1,1),0  0.02634 0.0433 -0.05953 0.1122 0.6082 104 0.5444</code></pre>
<pre class="r"><code>lincon(m.wls, a = c(-1,1))</code></pre>
<pre><code>         estimate      se   lower  upper tvalue  df   pvalue
(-1,1),0  0.06386 0.02359 0.01708 0.1106  2.707 104 0.007937</code></pre>
<p>The <code>contrast</code> function from the <strong>trtools</strong> package can also do this. It can make inferences for a <em>difference of differences</em>.</p>
<pre class="r"><code>contrast(m.wls, 
  a = list(treatment = &quot;y&quot;, total = 1),
  b = list(treatment = &quot;y&quot;, total = 0),
  u = list(treatment = &quot;n&quot;, total = 1),
  v = list(treatment = &quot;n&quot;, total = 0))</code></pre>
<pre><code> estimate      se   lower  upper tvalue  df   pvalue
  0.06386 0.02359 0.01708 0.1106  2.707 104 0.007937</code></pre>
<p>This estimates <span class="math inline">\(E(Y_a) - E(Y_b) - [E(Y_u) - E(Y_v)]\)</span>. This can also be done using the <code>emtrends</code> function from the <strong>emmeans</strong> package.</p>
<pre class="r"><code>library(emmeans)
emtrends(m.wls, ~treatment, var = &quot;total&quot;) # estimate slopes</code></pre>
<pre><code> treatment total.trend     SE  df lower.CL upper.CL
 n               0.125 0.0183 104   0.0888    0.161
 y               0.189 0.0149 104   0.1593    0.219

Confidence level used: 0.95 </code></pre>
<pre class="r"><code>pairs(emtrends(m.wls, ~ treatment, var = &quot;total&quot;)) # estimate difference between slopes</code></pre>
<pre><code> contrast estimate     SE  df t.ratio p.value
 n - y     -0.0639 0.0236 104  -2.707  0.0079</code></pre>
<p>Recall that both the <strong>emmeans</strong> and <strong>trtools</strong> packages have a <code>contrast</code> function. To avoid conflicts or having to use <code>trtools::contrast</code> to call te <code>contrast</code> function from the <strong>trtools</strong> package later, we can unload the <strong>emmeans</strong> package usin <code>detach</code>.</p>
<pre class="r"><code>detach(package:emmeans)</code></pre>
<p>Yet another approach to compare the slopes is to change the parameterization. Consider the following model.</p>
<pre class="r"><code>m.wls &lt;- lm(suitable ~ -1 + total + total:treatment, weights = w, data = biomass)
summary(m.wls)$coefficients</code></pre>
<pre><code>                 Estimate Std. Error t value  Pr(&gt;|t|)
total             0.18892    0.01493  12.656 8.836e-23
total:treatmentn -0.06386    0.02359  -2.707 7.937e-03</code></pre>
<p>From <code>summary</code> we can see that this model can be written as <span class="math display">\[
  E(S_i) = \beta_1t_i + \beta_2t_in_i,
\]</span></p>
<p>where <span class="math inline">\(n_i\)</span> is an indicator variable where <span class="math inline">\(n_i\)</span> = 1 if the treatment was not appiled to the <span class="math inline">\(i\)</span>-th plot, add <span class="math inline">\(n_i\)</span> = 0 otherwise, so we can also write the model as <span class="math display">\[
  E(S_i) = 
  \begin{cases}
  (\beta_1 + \beta_2)t_i, &amp; \text{if the $i$-th plot was not treated by fuel reduction}, \\
  \beta_1t_i, &amp; \text{if the $i$-th plot was treated by fuel reduction}.
  \end{cases}
\]</span> Note that the meaning of <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span> have changed here. The slopes of the lines with and without treatment are <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_1 + \beta_2\)</span>, respectively, and the difference between the slopes is <span class="math inline">\(\beta_1 - (\beta_1 + \beta_2) = -\beta_2\)</span>. So inferences for <span class="math inline">\(\beta_2\)</span> are for the difference in the slopes (after we reverse the sign). Although not necessary, we can change the reference category to avoid having to reverse the sign.</p>
<pre class="r"><code>biomass$treatment &lt;- relevel(biomass$treatment, ref = &quot;y&quot;)
m.wls &lt;- lm(suitable ~ -1 + total + total:treatment, weights = w, data = biomass)
summary(m.wls)$coefficients</code></pre>
<pre><code>                 Estimate Std. Error t value  Pr(&gt;|t|)
total             0.12506    0.01827   6.847 5.428e-10
total:treatmenty  0.06386    0.02359   2.707 7.937e-03</code></pre>
<p>Now the model can be written as <span class="math display">\[
  E(S_i) = \beta_1t_i + \beta_2t_in_i,
\]</span> or <span class="math display">\[
  E(S_i) = 
  \begin{cases}
  \beta_1t_i, &amp; \text{if the $i$-th plot was not treated by fuel reduction}, \\
  (\beta_1+\beta_2)t_i, &amp; \text{if the $i$-th plot was treated by fuel reduction}.
  \end{cases}
\]</span> Note: For some reason the reference category (<code>y</code>) is getting an indicator variable here, where normally it does not. I am not sure if this is a bug or intentional, but it appears to be due to the somewhat unusual parameterization I am using.</p>
</div>
<div id="parametric-models-for-heteroscedasticity" class="section level2">
<h2>Parametric Models for Heteroscedasticity</h2>
<p><strong>Example</strong>: Consider the following data where variability appears to vary by treatment.</p>
<pre class="r"><code>library(trtools) # for pulse data
p &lt;- ggplot(pulse, aes(x = pulse1, y = pulse2, color = treatment)) +
  geom_point() + theme_minimal() + 
  labs(x = &quot;Pulse Before&quot;, y = &quot;Pulse After&quot;, color = &quot;Treatment&quot;) +
  theme(legend.position = c(0.85,0.2))
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-13-1.png" width="100%" style="display: block; margin: auto;" /> There is one case with missing values on <code>pulse1</code> and <code>pulse2</code>.</p>
<pre class="r"><code>subset(pulse, !complete.cases(pulse)) # show observations with missing data</code></pre>
<pre><code>   height weight age gender smokes alcohol exercise treatment pulse1 pulse2 year
76    173     64  20 female     no     yes moderate       sat     NA     NA   97</code></pre>
<p>This will cause problems so we are going to remove it.</p>
<pre class="r"><code>pulse &lt;- subset(pulse, complete.cases(pulse)) # overwrite pulse with only complete cases</code></pre>
<p>Let’s consider a simple linear model.</p>
<pre class="r"><code>m &lt;- lm(pulse2 ~ treatment + pulse1 + treatment:pulse1, data = pulse)
summary(m)$coefficients</code></pre>
<pre><code>                     Estimate Std. Error  t value  Pr(&gt;|t|)
(Intercept)          59.41757    10.4467  5.68767 1.171e-07
treatmentsat        -51.25896    15.7451 -3.25554 1.524e-03
pulse1                0.89363     0.1357  6.58544 1.841e-09
treatmentsat:pulse1  -0.01437     0.2049 -0.07011 9.442e-01</code></pre>
<pre class="r"><code>pulse$yhat &lt;- predict(m)
pulse$rest &lt;- rstudent(m)
p &lt;- ggplot(pulse, aes(x = yhat, y = rest, color = treatment)) + 
  geom_point() + theme_minimal() + 
  labs(x = &quot;Predicted Value&quot;, y = &quot;Studentized Residual&quot;, 
    color = &quot;Treatment&quot;) + 
  theme(legend.position = c(0.8,0.2))
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-16-1.png" width="100%" style="display: block; margin: auto;" /> Consider that the model assumed by <code>lm</code> is <span class="math display">\[\begin{align}
  E(Y_i) &amp; = \beta_0 + \beta_1t_i + \beta_2x_i + \beta_3t_ix_i, \\
  \text{Var}(Y_i) &amp; = \sigma^2,
\end{align}\]</span> where <span class="math inline">\(Y_i\)</span> is the second pulse measurement, <span class="math inline">\(t_i\)</span> is an indicator variable for the treatment (i.e., <span class="math inline">\(t_i\)</span> = 1 if the <span class="math inline">\(i\)</span>-th observation was from the sitting treatment condition, and <span class="math inline">\(t_i\)</span> = 0 otherwise), and <span class="math inline">\(x_i\)</span> is the first pulse measurement. Maybe it would make sense to have something like <span class="math display">\[
  \text{Var}(Y_i) = 
  \begin{cases}
    \sigma^2_s, &amp; \text{if the $i$-th observation is from the sitting treatment}, \\
    \sigma^2_r, &amp; \text{if the $i$-th observation is from the running treatment}.
  \end{cases}
\]</span> We can estimate such a model using the <code>gls</code> function from the <strong>nlme</strong> package.</p>
<pre class="r"><code>library(nlme) # should come with R 
m &lt;- gls(pulse2 ~ treatment + pulse1 + treatment:pulse1, data = pulse, 
  method = &quot;ML&quot;, weights = varIdent(form = ~ 1|treatment))
summary(m)</code></pre>
<pre><code>Generalized least squares fit by maximum likelihood
  Model: pulse2 ~ treatment + pulse1 + treatment:pulse1 
  Data: pulse 
    AIC   BIC logLik
  763.1 779.3 -375.6

Variance function:
 Structure: Different standard deviations per stratum
 Formula: ~1 | treatment 
 Parameter estimates:
  sat   ran 
1.000 5.723 

Coefficients:
                     Value Std.Error t-value p-value
(Intercept)          59.42    15.755   3.771  0.0003
treatmentsat        -51.26    16.058  -3.192  0.0019
pulse1                0.89     0.205   4.367  0.0000
treatmentsat:pulse1  -0.01     0.209  -0.069  0.9452

 Correlation: 
                    (Intr) trtmnt pulse1
treatmentsat        -0.981              
pulse1              -0.980  0.962       
treatmentsat:pulse1  0.962 -0.980 -0.981

Standardized residuals:
    Min      Q1     Med      Q3     Max 
-2.0920 -0.7688  0.1026  0.5886  2.1968 

Residual standard error: 3.634 
Degrees of freedom: 109 total; 105 residual</code></pre>
<p>Note the different syntax for extracting standardized residuals.</p>
<pre class="r"><code>pulse$yhat &lt;- predict(m)
pulse$resz &lt;- residuals(m, type = &quot;p&quot;) # note different syntax
p &lt;- ggplot(pulse, aes(x = yhat, y = resz, color = treatment)) + 
  geom_point() + theme_minimal() + 
  labs(x = &quot;Predicted Value&quot;, y = &quot;Standardized Residual&quot;, 
    color = &quot;Treatment&quot;)
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-18-1.png" width="100%" style="display: block; margin: auto;" /> Here is an example with the <code>CancerSurvival</code> data.</p>
<pre class="r"><code>library(Stat2Data)
data(CancerSurvival)
m &lt;- gls(Survival ~ Organ, data = CancerSurvival, 
  method = &quot;ML&quot;, weights = varIdent(form = ~ 1|Organ))
summary(m)</code></pre>
<pre><code>Generalized least squares fit by maximum likelihood
  Model: Survival ~ Organ 
  Data: CancerSurvival 
    AIC   BIC logLik
  976.8 998.4 -478.4

Variance function:
 Structure: Different standard deviations per stratum
 Formula: ~1 | Organ 
 Parameter estimates:
 Stomach Bronchus    Colon    Ovary   Breast 
  1.0000   0.6119   1.2455   3.0141   3.5504 

Coefficients:
                Value Std.Error t-value p-value
(Intercept)    1395.9     371.0   3.763  0.0004
OrganBronchus -1184.3     374.5  -3.162  0.0025
OrganColon     -938.5     385.5  -2.435  0.0179
OrganOvary     -511.6     565.2  -0.905  0.3691
OrganStomach  -1109.9     383.2  -2.896  0.0053

 Correlation: 
              (Intr) OrgnBr OrgnCl OrgnOv
OrganBronchus -0.991                     
OrganColon    -0.962  0.953              
OrganOvary    -0.656  0.650  0.632       
OrganStomach  -0.968  0.959  0.932  0.635

Standardized residuals:
    Min      Q1     Med      Q3     Max 
-1.1613 -0.6824 -0.2878  0.1748  3.3435 

Residual standard error: 332.7 
Degrees of freedom: 64 total; 59 residual</code></pre>
<pre class="r"><code>CancerSurvival$yhat &lt;- predict(m)
CancerSurvival$resz &lt;- residuals(m, type = &quot;p&quot;) 
p &lt;- ggplot(CancerSurvival, aes(x = yhat, y = resz, color = Organ)) +
  geom_point() + theme_minimal() + 
  labs(x = &quot;Predicted Value&quot;, y = &quot;Standardized Residual&quot;, color = &quot;Organ&quot;)
plot(p)</code></pre>
<p><img src="lecture-02-23-2022_files/figure-html/unnamed-chunk-19-1.png" width="100%" style="display: block; margin: auto;" /> Comments about parametric models for heteroscedasticity.</p>
<p><strong>Advantages</strong>: Potentially very effective <em>if</em> we can specify an accurate model for the variance.</p>
<p><strong>Disadvantages</strong>: If we do not specify an accurate model for the variance, it may bias estimation of parameters concerning the expected response.</p>
</div>
<div id="heteroscedastic-consistent-standard-errors" class="section level2">
<h2>Heteroscedastic Consistent Standard Errors</h2>
<p>The idea is to estimate the model parameters using ordinary least squares, but estimate the standard errors in such a way that we do not assume heteroscedasticity. This is sometimes called <em>heteroscedastic consistent standard errors</em>, <em>robust standard errors</em>, or <em>sandwich estimators</em>.</p>
<p><strong>Example</strong>: Consider again the cancer survival data.</p>
<pre class="r"><code>m &lt;- lm(Survival ~ Organ, data = CancerSurvival)</code></pre>
<p>The <strong>sandwich</strong> package provides resources for using heteroscedastic-consistent standard errors. Technically, what is being estimated is the <em>covariance matrix</em> of the parameter estimators.</p>
<pre class="r"><code>library(sandwich) # for vcovHC used below
vcov(m)   # bad estimate if there is heteroscedasticity</code></pre>
<pre><code>              (Intercept) OrganBronchus OrganColon OrganOvary OrganStomach
(Intercept)         40752        -40752     -40752     -40752       -40752
OrganBronchus      -40752         67121      40752      40752        40752
OrganColon         -40752         40752      67121      40752        40752
OrganOvary         -40752         40752      40752     115464        40752
OrganStomach       -40752         40752      40752      40752        75235</code></pre>
<pre class="r"><code>vcovHC(m) # better estimate if there is heteroscedasticity</code></pre>
<pre><code>              (Intercept) OrganBronchus OrganColon OrganOvary OrganStomach
(Intercept)        153504       -153504    -153504    -153504      -153504
OrganBronchus     -153504        156256     153504     153504       153504
OrganColon        -153504        153504     164908     153504       153504
OrganOvary        -153504        153504     153504     394879       153504
OrganStomach      -153504        153504     153504     153504       163498</code></pre>
<p>The square root of the diagonal elements are the standard errors.</p>
<pre class="r"><code>sqrt(diag(vcov(m)))   # bad estimates of the standard errors</code></pre>
<pre><code>  (Intercept) OrganBronchus    OrganColon    OrganOvary  OrganStomach 
        201.9         259.1         259.1         339.8         274.3 </code></pre>
<pre class="r"><code>sqrt(diag(vcovHC(m))) # better estimates of the standard errors</code></pre>
<pre><code>  (Intercept) OrganBronchus    OrganColon    OrganOvary  OrganStomach 
        391.8         395.3         406.1         628.4         404.3 </code></pre>
<p>But the usual way to interface with the functions in the <strong>sandwich</strong> package is through other functions.</p>
<pre><code>              Estimate Std. Error t value  Pr(&gt;|t|) 2.5 % 97.5 %
(Intercept)     1395.9      201.9   6.915 3.770e-09   992 1799.9
OrganBronchus  -1184.3      259.1  -4.571 2.530e-05 -1703 -665.9
OrganColon      -938.5      259.1  -3.622 6.083e-04 -1457 -420.1
OrganOvary      -511.6      339.8  -1.506 1.375e-01 -1192  168.4
OrganStomach   -1109.9      274.3  -4.046 1.533e-04 -1659 -561.1</code></pre>
<pre class="r"><code>confint(m) # bad confidence intervals due to bad standard error estimates</code></pre>
<pre><code>              2.5 % 97.5 %
(Intercept)     992 1799.9
OrganBronchus -1703 -665.9
OrganColon    -1457 -420.1
OrganOvary    -1192  168.4
OrganStomach  -1659 -561.1</code></pre>
<pre class="r"><code>library(lmtest) # for coeftest and coefci used below
coeftest(m, vcov = vcovHC) # better standard error estimates</code></pre>
<pre><code>
t test of coefficients:

              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)       1396        392    3.56  0.00073 ***
OrganBronchus    -1184        395   -3.00  0.00400 ** 
OrganColon        -938        406   -2.31  0.02434 *  
OrganOvary        -512        628   -0.81  0.41886    
OrganStomach     -1110        404   -2.74  0.00801 ** 
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>coefci(m, vcov = vcovHC)   # better confidence intervals</code></pre>
<pre><code>                2.5 % 97.5 %
(Intercept)     611.9 2179.9
OrganBronchus -1975.3 -393.3
OrganColon    -1751.1 -125.9
OrganOvary    -1769.0  745.8
OrganStomach  -1919.0 -300.8</code></pre>
<p>Both <code>lincon</code> and <code>contrast</code> will accept a <code>fcov</code> argument to provide a function to estimate standard errors.</p>
<pre class="r"><code>lincon(m, fcov = vcovHC) </code></pre>
<pre><code>              estimate    se   lower  upper  tvalue df    pvalue
(Intercept)     1395.9 391.8   611.9 2179.9  3.5628 59 0.0007337
OrganBronchus  -1184.3 395.3 -1975.3 -393.3 -2.9961 59 0.0039950
OrganColon      -938.5 406.1 -1751.1 -125.9 -2.3111 59 0.0243421
OrganOvary      -511.6 628.4 -1769.0  745.8 -0.8141 59 0.4188611
OrganStomach   -1109.9 404.3 -1919.0 -300.8 -2.7449 59 0.0080080</code></pre>
<pre class="r"><code>organs &lt;- sort(unique(CancerSurvival$Organ)) # sorted organ names
contrast(m, a = list(Organ = organs),
  cnames = organs, fcov = vcovHC)</code></pre>
<pre><code>         estimate     se  lower  upper tvalue df    pvalue
Breast     1395.9 391.80 611.93 2179.9  3.563 59 7.337e-04
Bronchus    211.6  52.46 106.61  316.6  4.033 59 1.604e-04
Colon       457.4 106.79 243.72  671.1  4.283 59 6.884e-05
Ovary       884.3 491.30 -98.75 1867.4  1.800 59 7.698e-02
Stomach     286.0  99.97  85.96  486.0  2.861 59 5.836e-03</code></pre>
<pre class="r"><code>lincon(m, a = c(1,0,0,0,1), fcov = vcovHC)   </code></pre>
<pre><code>              estimate    se lower upper tvalue df   pvalue
(1,0,0,0,1),0      286 99.97 85.96   486  2.861 59 0.005836</code></pre>
<p>You can use a similar approach with the <code>emmeans</code> function from the <strong>emmeans</strong> package, but there the argument is <code>vcov</code>.</p>
<pre class="r"><code>library(emmeans)
emmeans(m, ~Organ, vcov = vcovHC)</code></pre>
<pre><code> Organ    emmean    SE df lower.CL upper.CL
 Breast     1396 391.8 59    611.9     2180
 Bronchus    212  52.5 59    106.6      317
 Colon       457 106.8 59    243.7      671
 Ovary       884 491.3 59    -98.8     1867
 Stomach     286 100.0 59     86.0      486

Confidence level used: 0.95 </code></pre>
<pre class="r"><code>pairs(emmeans(m, ~Organ, vcov = vcovHC), adjust = &quot;none&quot;, infer = TRUE)</code></pre>
<pre><code> contrast           estimate  SE df lower.CL upper.CL t.ratio p.value
 Breast - Bronchus    1184.3 395 59      393   1975.3   2.996  0.0040
 Breast - Colon        938.5 406 59      126   1751.1   2.311  0.0243
 Breast - Ovary        511.6 628 59     -746   1769.0   0.814  0.4189
 Breast - Stomach     1109.9 404 59      301   1919.0   2.745  0.0080
 Bronchus - Colon     -245.8 119 59     -484     -7.7  -2.066  0.0432
 Bronchus - Ovary     -672.7 494 59    -1661    315.9  -1.362  0.1785
 Bronchus - Stomach    -74.4 113 59     -300    151.5  -0.659  0.5124
 Colon - Ovary        -426.9 503 59    -1433    579.1  -0.849  0.3992
 Colon - Stomach       171.4 146 59     -121    464.1   1.172  0.2460
 Ovary - Stomach       598.3 501 59     -405   1601.6   1.193  0.2375

Confidence level used: 0.95 </code></pre>
<p>Use the function <code>waldtest</code> in place of <code>anova</code> when using heteroscedastic-consistent standard errors.</p>
<pre class="r"><code>m.full &lt;- lm(Survival ~ Organ, data = CancerSurvival)
m.null &lt;- lm(Survival ~ 1, data = CancerSurvival)
waldtest(m.null, m.full, vcov = vcovHC)</code></pre>
<pre><code>Wald test

Model 1: Survival ~ 1
Model 2: Survival ~ Organ
  Res.Df Df    F Pr(&gt;F)  
1     63                 
2     59  4 3.52  0.012 *
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Comments about heteroscedastic-consistent standard errors:</p>
<p><strong>Advantages</strong>: Does not require us to specify a variance structure/function. We let the data inform the estimator.</p>
<p><strong>Disadvantages</strong>: Highly dependent on the data to help produce better estimates of the standard errors, and tends to work well only if <span class="math inline">\(n\)</span> is relatively large.</p>
<p>Note: There are a variety of variations of the “sandwich” estimator. Different estimators can be specified through the <code>type</code> argument to <code>vcovHC</code> so instead of writing <code>vcov = vcovHC</code> or <code>fcov = vcovHC</code> we write <code>vcov = function(m) vcovHC(m, type = "HC0")</code> or <code>vcov = function(m) vcovHC(m, type = "HC0")</code> if we wanted to use that particular type of estimator (sometimes called “White’s estimator”).</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
