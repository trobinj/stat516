<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Friday, Apr 29</title>

<script src="site_libs/header-attrs-2.14/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Statistics 436/516</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="lectures.html">Lectures</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Friday, Apr 29</h1>

</div>


<p>You can also download a <a href="lecture-04-29-2022.pdf">PDF</a> copy
of this lecture.</p>
<div id="nonlinear-regression-with-random-effects"
class="section level2">
<h2>Nonlinear Regression With Random Effects</h2>
<p><strong>Example</strong>: The model we specified for the
<code>Sitka</code> data can be written as <span class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 o_{ij} + \beta_2 w_{ij} + \beta_3
o_{ij}w_{ij} + \delta_i + \gamma_iw_{ij},
\]</span> where <span class="math inline">\(o_{ij}\)</span> is an
indicator for if the observation is from the ozone treatment condition
and <span class="math inline">\(w_{ij}\)</span> is weeks. We can also
write this model as <span class="math display">\[
  E(Y_{ij}) = \underbrace{\beta_0 + \beta_1 o_{ij} +
\delta_i}_{\beta_{0ij}} + \underbrace{(\beta_2 + \beta_3o_{ij} +
\gamma_i)}_{\beta_{1ij}}w_i,
\]</span> or <span class="math display">\[
  E(Y_{ij}) = \beta_{0ij} + \beta_{1ij}w_{ij},
\]</span> to show that the model assumes a linear relationship between
expected size and weeks, but where the “intercept” <span
class="math inline">\(\beta_{0ij}\)</span> depends on the treatment
condition and tree, and the “slope” <span
class="math inline">\(\beta_{1ij}\)</span> depends on the treatment
condition and tree because <span class="math display">\[\begin{align*}
  \beta_{0ij} &amp; = \beta_0 + \beta_1o_{ij} + \delta_i \\
  \beta_{1ij} &amp; = \beta_2 + \beta_3o_{ij} + \gamma_i.
\end{align*}\]</span> Models with random effects written in this way are
sometimes called “random coefficient” models. The coefficients <span
class="math inline">\(\beta_{0ij}\)</span> and <span
class="math inline">\(\beta_{1ij}\)</span> are random (due to <span
class="math inline">\(\delta_i\)</span> and <span
class="math inline">\(\gamma_i\)</span>) but may also depend on one or
more explanatory variables (such as treatment condition via <span
class="math inline">\(o_{ij}\)</span>).</p>
<p>The <code>nlme</code> function from the <strong>nlme</strong> package
can estimate a linear or nonlinear regression model with random
coefficients (assuming a normally-distributed response variable and
random parameters). We estimated a model for the <code>Sitka</code> data
as follows.</p>
<pre class="r"><code>library(MASS)
library(lme4)
m &lt;- lmer(exp(size) ~ treat * I(Time/7) + (1 + I(Time/7) | tree),
  data = Sitka, REML = FALSE)
summary(m)$coefficients</code></pre>
<pre><code>                     Estimate Std. Error t value
(Intercept)          -305.123     31.251  -9.764
treatozone            110.675     37.799   2.928
I(Time/7)              17.565      1.685  10.424
treatozone:I(Time/7)   -5.516      2.038  -2.707</code></pre>
<p>I am using <code>REML = FALSE</code> to use maximum likelihood rather
than <em>restricted</em> maximum likelihood (REML) for estimation so
that we can compare the results with <code>nlme</code>, which only uses
maximum likelihood.</p>
<pre class="r"><code>library(nlme)
m &lt;- nlme(exp(size) ~ b0 + b1 * I(Time/7),
  fixed = b0 + b1 ~ treat, 
  random = b0 + b1 ~ 1 | tree,
  start = c(0,0,0,0), data = Sitka)
summary(m)</code></pre>
<pre><code>Nonlinear mixed-effects model fit by maximum likelihood
  Model: exp(size) ~ b0 + b1 * I(Time/7) 
  Data: Sitka 
   AIC  BIC logLik
  3947 3978  -1965

Random effects:
 Formula: list(b0 ~ 1, b1 ~ 1)
 Level: tree
 Structure: General positive-definite, Log-Cholesky parametrization
               StdDev  Corr  
b0.(Intercept) 148.699 b0.(I)
b1.(Intercept)   8.266 -0.987
Residual        19.575       

Fixed effects:  b0 + b1 ~ treat 
                 Value Std.Error  DF t-value p-value
b0.(Intercept) -305.12     31.41 313  -9.714  0.0000
b0.treatozone   110.68     37.99 313   2.913  0.0038
b1.(Intercept)   17.56      1.69 313  10.371  0.0000
b1.treatozone    -5.52      2.05 313  -2.693  0.0075
 Correlation: 
               b0.(I) b0.trt b1.(I)
b0.treatozone  -0.827              
b1.(Intercept) -0.980  0.810       
b1.treatozone   0.810 -0.980 -0.827

Standardized Within-Group Residuals:
     Min       Q1      Med       Q3      Max 
-2.96548 -0.38922 -0.05501  0.38267  4.82179 

Number of Observations: 395
Number of Groups: 79 </code></pre>
<p>The <code>nlme</code> function is like <code>nls</code> in that it
needs starting values for the (fixed) parameters, but since the model is
linear we do not need particularly good starting values.</p>
<p><strong>Example</strong>: Now consider a <em>nonlinear</em>
regression model with random effects for the <code>Loblolly</code> data
that come with R.</p>
<pre class="r"><code>head(Loblolly)</code></pre>
<pre><code>Grouped Data: height ~ age | Seed
   height age Seed
1    4.51   3  301
15  10.89   5  301
29  28.72  10  301
43  41.74  15  301
57  52.70  20  301
71  60.92  25  301</code></pre>
<pre class="r"><code>p &lt;- ggplot(Loblolly, aes(x = age, y = height)) + 
  geom_line(aes(group = Seed), alpha = 0.5, size = 0.01) +
  geom_point(size = 0.5) + facet_wrap(~ Seed, ncol = 7) + 
  ylab(&quot;Height (ft)&quot;) + xlab(&quot;Age (yr)&quot;) + theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;" />
Suppose we want to estimate the nonlinear growth model <span
class="math display">\[
  E(H) = \theta_1 + (\theta_2 - \theta_1)e^{-a\log(2)/\theta_3},
\]</span> where <span class="math inline">\(H\)</span> and <span
class="math inline">\(a\)</span> are height and age, respectively, <span
class="math inline">\(\theta_1\)</span> is the asymptote as <span
class="math inline">\(a \rightarrow \infty\)</span>, and <span
class="math inline">\(\theta_2\)</span> is an “intercept” parameter, and
<span class="math inline">\(\theta_3\)</span> is the age at which the
tree is half way between <span class="math inline">\(E(H) =
\theta_2\)</span> and <span class="math inline">\(E(H) =
\theta_1\)</span>. To allow for differences between trees with respect
to <span class="math inline">\(\theta_1\)</span> and <span
class="math inline">\(\theta_3\)</span> (but not <span
class="math inline">\(\theta_2\)</span>) we could write the model as
<span class="math display">\[
  E(H_{ij}) = \theta_{1i} + (\theta_{2} -
\theta_{1i})e^{-a_{ij}\log(2)/\theta_{3i}},
\]</span> where <span class="math inline">\(H_{ij}\)</span> and <span
class="math inline">\(a_{ij}\)</span> are now the height and age of the
<span class="math inline">\(j\)</span>-th observation of the <span
class="math inline">\(i\)</span>-th tree.</p>
<pre class="r"><code>m &lt;- nlme(height ~ t1 + (t2 - t1) * exp(-age * log(2)/t3), 
  fixed = t1 + t2 + t3 ~ 1, 
  random = t1 + t3 ~ 1 | Seed,
  start = c(t1 = 100, t2 = 0, t3 = 15), 
  data = Loblolly)
summary(m)</code></pre>
<pre><code>Nonlinear mixed-effects model fit by maximum likelihood
  Model: height ~ t1 + (t2 - t1) * exp(-age * log(2)/t3) 
  Data: Loblolly 
    AIC   BIC logLik
  239.1 256.1 -112.5

Random effects:
 Formula: list(t1 ~ 1, t3 ~ 1)
 Level: Seed
 Structure: General positive-definite, Log-Cholesky parametrization
         StdDev Corr 
t1       5.4054 t1   
t3       1.2334 0.769
Residual 0.6462      

Fixed effects:  t1 + t2 + t3 ~ 1 
    Value Std.Error DF t-value p-value
t1 101.03    2.4708 68   40.89       0
t2  -8.71    0.2850 68  -30.55       0
t3  17.48    0.6289 68   27.79       0
 Correlation: 
   t1    t2   
t2 0.615      
t3 0.918 0.698

Standardized Within-Group Residuals:
     Min       Q1      Med       Q3      Max 
-1.88049 -0.59420 -0.04009  0.70784  1.47988 

Number of Observations: 84
Number of Groups: 14 </code></pre>
<p>We can plot the estimated growth curves (both per tree and average)
as follows.</p>
<pre class="r"><code>d &lt;- expand.grid(age = seq(0, 50, length = 100), Seed = unique(Loblolly$Seed))

d$yhat.ind &lt;- predict(m, newdata = d, level = 1) # individual tree
d$yhat.avg &lt;- predict(m, newdata = d, level = 0) # average tree

p &lt;- ggplot(Loblolly, aes(x = age, y = height)) + 
  geom_line(aes(y = yhat.ind), data = d, linetype = 3) +
  geom_line(aes(y = yhat.avg), data = d) + 
  geom_point(size = 0.5) + facet_wrap(~ Seed, ncol = 7) + 
  ylab(&quot;Height (ft)&quot;) + xlab(&quot;Age (yr)&quot;) + theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-6-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p><strong>Example</strong>: The data frame <code>Soybean</code> from
the <strong>nlme</strong> package has data from an experiment looking at
soybean growth.</p>
<pre class="r"><code>head(Soybean)</code></pre>
<pre><code>Grouped Data: weight ~ Time | Plot
    Plot Variety Year Time weight
1 1988F1       F 1988   14  0.106
2 1988F1       F 1988   21  0.261
3 1988F1       F 1988   28  0.666
4 1988F1       F 1988   35  2.110
5 1988F1       F 1988   42  3.560
6 1988F1       F 1988   49  6.230</code></pre>
<pre class="r"><code>p &lt;- ggplot(Soybean, aes(x = Time, y = weight)) + 
  geom_point() + facet_wrap(~ Plot, ncol = 8) + 
  labs(x = &quot;Time (days after planting)&quot;, 
    y = &quot;Weight (average leaf weight per plant in grams)&quot;) +
  theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-7-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>p &lt;- ggplot(Soybean, aes(x = Time, y = weight)) + 
  geom_point(size = 1) + facet_wrap(~ Variety) + 
  geom_line(aes(group = Plot), size = 0.1) + 
  labs(x = &quot;Time (days after planting)&quot;,
    y = &quot;Weight (average leaf weight per plant in grams)&quot;) +
  theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;" />
Consider a logistic growth model which can be written as <span
class="math display">\[
  E(W) = \frac{\theta_1}{1 + e^{-(t-\theta_2)/\theta_3}},
\]</span> where <span class="math inline">\(\theta_1\)</span> is the
asymptote as <span class="math inline">\(t \rightarrow \infty\)</span>,
<span class="math inline">\(\theta_2\)</span> is the time at which the
expected weight is <span class="math inline">\(\theta_1/2\)</span>, and
<span class="math inline">\(\theta_3\)</span> is inversely related to
the steepness of the curve at <span
class="math inline">\(\theta_2\)</span>. We could assume that each
parameter varies by plot, and is also affected by variety as
follows.</p>
<pre class="r"><code>m &lt;- nlme(weight ~ theta1 / (1 + exp(-(Time - theta2) / theta3)), data = Soybean,
 fixed = theta1 + theta2 + theta3 ~ Variety, 
 random = theta1 + theta2 + theta3 ~ 1 | Plot,
 start = c(20, 0, 60, 0, 10, 0),
 control = nlmeControl(msMaxIter = 1000))
summary(m)$tTable</code></pre>
<pre><code>                     Value Std.Error  DF t-value    p-value
theta1.(Intercept) 16.9466    1.0308 359 16.4410  1.121e-45
theta1.VarietyP     4.5664    1.4630 359  3.1212  1.947e-03
theta2.(Intercept) 54.8759    1.0561 359 51.9630 4.219e-169
theta2.VarietyP     0.1828    1.4504 359  0.1260  8.998e-01
theta3.(Intercept)  8.2284    0.4748 359 17.3304  2.526e-49
theta3.VarietyP     0.3741    0.6345 359  0.5896  5.558e-01</code></pre>
<p>In more complex models getting the inferences you want from a
<code>nlme</code> object can be a bit tricky. Functions like
<code>contrast</code> and <code>emmeans</code> will not work with a
<code>nlme</code> object. But you can use the <code>lincon</code>
function, although you need to tell it how to extract the parameter
estimates from <code>nlme</code> (it needs to use the <code>fixef</code>
function). Here we can get results like those returned by
<code>summary</code>.</p>
<pre class="r"><code>trtools::lincon(m, fest = fixef)</code></pre>
<pre><code>                   estimate     se   lower  upper  tvalue  df    pvalue
theta1.(Intercept)  16.9466 1.0232 14.9412 18.952 16.5620 Inf 1.311e-61
theta1.VarietyP      4.5664 1.4523  1.7199  7.413  3.1442 Inf 1.666e-03
theta2.(Intercept)  54.8759 1.0483 52.8212 56.931 52.3455 Inf 0.000e+00
theta2.VarietyP      0.1828 1.4398 -2.6391  3.005  0.1269 Inf 8.990e-01
theta3.(Intercept)   8.2284 0.4713  7.3046  9.152 17.4580 Inf 2.994e-68
theta3.VarietyP      0.3741 0.6299 -0.8605  1.609  0.5939 Inf 5.525e-01</code></pre>
<p>The estimate of mean <span class="math inline">\(\theta_1\)</span>
parameter for the F variety is given by <code>theta1.(Intercept)</code>.
But the estimate of the mean <span
class="math inline">\(\theta_1\)</span> parameter for the P variety is
the sum of the <code>theta1.(Intercept)</code> and
<code>theta1.VarietyP</code> parameters. This can be obtained as
follows.</p>
<pre class="r"><code>trtools::lincon(m, a = c(1,1,0,0,0,0), fest = fixef)</code></pre>
<pre><code>                estimate    se lower upper tvalue  df    pvalue
(1,1,0,0,0,0),0    21.51 1.031 19.49 23.53  20.87 Inf 9.498e-97</code></pre>
<p>Again we can plot this model as we did with the <code>Loblolly</code>
data/model, although setting up the data frame is a little more
complicated because plots and variety are not crossed.</p>
<pre class="r"><code>library(dplyr)
library(tidyr)
d &lt;- Soybean %&gt;% dplyr::select(Plot, Variety) %&gt;% unique() %&gt;% 
  group_by(Plot, Variety) %&gt;% tidyr::expand(Time = seq(14, 84, length = 100))
d$yhat.ind &lt;- predict(m, newdata = d, level = 1)
d$yhat.avg &lt;- predict(m, newdata = d, level = 0)

p &lt;- ggplot(Soybean, aes(x = Time, y = weight)) + 
  geom_line(aes(y = yhat.ind, group = Plot), data = d, alpha = 0.125) + 
  geom_line(aes(y = yhat.avg), data = d) + 
  geom_point(size = 1, alpha = 0.25) + facet_wrap(~ Variety) + 
  labs(x = &quot;Time (days after planting)&quot;,
    y = &quot;Weight (average leaf weight per plant in grams)&quot;) + theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="crossed-random-effects" class="section level2">
<h2>Crossed Random Effects</h2>
<p>Crossed random effects might be specified when two (or more) factors
modeled as having random effects are crossed (i.e., having a “factorial
design” structure).</p>
<p><strong>Example</strong>: Six samples of penicillin were tested using
24 plates. The response varaible was the diameter of the zone of
inhibition of the growth of a bacteria.</p>
<pre class="r"><code>p &lt;- ggplot(Penicillin, aes(x = plate, y = diameter)) + 
  geom_point(size = 1) + facet_wrap(~ sample, ncol = 6) + 
  coord_flip() + theme_minimal() + 
  theme(axis.text.x = element_text(size = 5)) + 
  labs(y = &quot;Diameter (mm)&quot;, x = &quot;Plate&quot;)
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-13-1.png" width="100%" style="display: block; margin: auto;" />
Let <span class="math inline">\(Y_{ij}\)</span> denote the diameter of
inhibition for the <span class="math inline">\(i\)</span>-th sample
(<span class="math inline">\(i = 1, 2, \dots, 6\)</span>) and the <span
class="math inline">\(j\)</span>-th plate (<span class="math inline">\(j
= 1, 2, \dots, 26\)</span>). A model might be <span
class="math display">\[
  E(Y_{ij}) = \beta_0 + \delta_i + \zeta_j \ \ \text{or} \ \
  Y_{ij} = \beta_0 + \delta_i + \zeta_j + e_{ij}.
\]</span> where <span class="math inline">\(\delta_i\)</span> and <span
class="math inline">\(\zeta_j\)</span> are sample-specific and
plate-specific effects, respectively. Here we will model both as random
effects, each with an independent normal distribution. Note that we
don’t have any fixed effects.</p>
<pre class="r"><code>m &lt;- lmer(diameter ~ (1 | plate) + (1 | sample), data = Penicillin)
summary(m)</code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: diameter ~ (1 | plate) + (1 | sample)
   Data: Penicillin

REML criterion at convergence: 330.9

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.0792 -0.6714  0.0629  0.5838  2.9796 

Random effects:
 Groups   Name        Variance Std.Dev.
 plate    (Intercept) 0.717    0.847   
 sample   (Intercept) 3.731    1.932   
 Residual             0.302    0.550   
Number of obs: 144, groups:  plate, 24; sample, 6

Fixed effects:
            Estimate Std. Error t value
(Intercept)   22.972      0.809    28.4</code></pre>
<p><strong>Example</strong>: Consider the following data from a study
that examined mating success with multiple combinations of male and
female salamanders.</p>
<pre class="r"><code>library(hglm.data)
data(salamander)
head(salamander, 12)</code></pre>
<pre><code>   Season Experiment TypeM TypeF Cross Male Female Mate
1  Summer          1     R     R    RR    1      1    1
2  Summer          1     W     R    RW   14      1    1
3  Summer          1     R     R    RR    5      1    1
4  Summer          1     W     R    RW   11      1    0
5  Summer          1     R     R    RR    4      1    1
6  Summer          1     W     R    RW   15      1    1
7  Summer          1     R     R    RR    5      2    1
8  Summer          1     W     R    RW   15      2    1
9  Summer          1     R     R    RR    3      2    1
10 Summer          1     W     R    RW   13      2    1
11 Summer          1     R     R    RR    1      2    1
12 Summer          1     W     R    RW   12      2    1</code></pre>
<p>The question here is how the combination female and male salamanders
in terms of population (W = “White Side”, R = “Rough Butt”) affects
mating success, while accounting for individual differences in the
salamanders themselves.</p>
<pre class="r"><code>salamander$Cross &lt;- relevel(salamander$Cross, ref = &quot;WR&quot;)
m &lt;- glmer(Mate ~ Cross + (1 | Male) + (1 | Female),
  family = binomial, data = salamander)
summary(m)</code></pre>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [glmerMod
]
 Family: binomial  ( logit )
Formula: Mate ~ Cross + (1 | Male) + (1 | Female)
   Data: salamander

     AIC      BIC   logLik deviance df.resid 
   430.6    453.9   -209.3    418.6      354 

Scaled residuals: 
   Min     1Q Median     3Q    Max 
-2.051 -0.616  0.271  0.597  2.551 

Random effects:
 Groups Name        Variance Std.Dev.
 Male   (Intercept) 1.04     1.02    
 Female (Intercept) 1.17     1.08    
Number of obs: 360, groups:  Male, 60; Female, 60

Fixed effects:
            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   -1.896      0.446   -4.25  2.1e-05 ***
CrossRR        2.904      0.561    5.18  2.2e-07 ***
CrossRW        2.202      0.588    3.75  0.00018 ***
CrossWW        2.886      0.549    5.26  1.4e-07 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Correlation of Fixed Effects:
        (Intr) CrssRR CrssRW
CrossRR -0.716              
CrossRW -0.771  0.678       
CrossWW -0.709  0.521  0.661</code></pre>
</div>
<div id="nested-random-effects" class="section level2">
<h2>Nested Random Effects</h2>
<p>Nested factors occur when they form a <em>hierarchical</em>
structure. For example, in the <code>Sitka</code> data the levels of
<code>tree</code> are nested within levels of <code>treat</code> (i.e.,
ozone or control), and in the <code>Soybean</code> data the levels of
<code>Plot</code> are nested within levels of <code>Variety</code>.
Nested random effects when the levels of one factor, modeled as a random
effect, are nested within the levels of another factor that is also
modeled as a random effect.</p>
<p><strong>Example</strong>: The <code>Pastes</code> data frame from the
<strong>lme4</strong> package is from a study of the strength of
chemical pastes. Paste was delivered in a cask, and there were three
casks per batch, and 10 batches. Two tests were run per cask.</p>
<pre class="r"><code>head(Pastes, 12)</code></pre>
<pre><code>   strength batch cask sample
1      62.8     A    a    A:a
2      62.6     A    a    A:a
3      60.1     A    b    A:b
4      62.3     A    b    A:b
5      62.7     A    c    A:c
6      63.1     A    c    A:c
7      60.0     B    a    B:a
8      61.4     B    a    B:a
9      57.5     B    b    B:b
10     56.9     B    b    B:b
11     61.1     B    c    B:c
12     58.9     B    c    B:c</code></pre>
<p>Note that levels of <code>cask</code> are not the same between
batches — i.e., cask <code>a</code> in batch <code>A</code> is
<em>not</em> the same as cask <code>a</code> in batch <code>B</code>,
for example. The <code>sample</code> variable was created to identify a
particular <code>cask</code>. We could model these data as <span
class="math display">\[
  E(Y_{ijk}) = \beta_0 + \delta_i + \zeta_{ij},
\]</span> where <span class="math inline">\(Y_{ijk}\)</span> is <span
class="math inline">\(k\)</span>-th (<span
class="math inline">\(k=1,2\)</span>) test a paste from the <span
class="math inline">\(j\)</span>-th (<span
class="math inline">\(j=1,2,3\)</span>) cask from the <span
class="math inline">\(i\)</span>-th batch (<span
class="math inline">\(i=1,2,\dots,10\)</span>). So here <span
class="math inline">\(\delta_i\)</span> is the effect of the <span
class="math inline">\(i\)</span>-th batch, and <span
class="math inline">\(\zeta_{ij}\)</span> is the effect of the <span
class="math inline">\(j\)</span>-th cask from the <span
class="math inline">\(i\)</span>-th batch.</p>
<pre class="r"><code>m &lt;- lmer(strength ~ (1|batch) + (1|cask:batch), data = Pastes)
summary(m)</code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: strength ~ (1 | batch) + (1 | cask:batch)
   Data: Pastes

REML criterion at convergence: 247

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.4798 -0.5156  0.0095  0.4720  1.3897 

Random effects:
 Groups     Name        Variance Std.Dev.
 cask:batch (Intercept) 8.434    2.904   
 batch      (Intercept) 1.657    1.287   
 Residual               0.678    0.823   
Number of obs: 60, groups:  cask:batch, 30; batch, 10

Fixed effects:
            Estimate Std. Error t value
(Intercept)   60.053      0.677    88.7</code></pre>
<p>Note that you could use <code>sample</code> in place of
<code>cask:batch</code>.</p>
<p><strong>Example</strong>: Consider the following data from an
experiment on the treatment of arthritis.</p>
<pre class="r"><code>myhips &lt;- faraway::hips %&gt;% pivot_longer(cols = c(fbef,faft,rbef,raft), 
   names_to = &quot;obs&quot;, values_to = &quot;angle&quot;) %&gt;%
   mutate(time = rep(c(&quot;before&quot;,&quot;after&quot;), n()/2)) %&gt;%
   mutate(variable = rep(c(&quot;flexion&quot;,&quot;flexion&quot;,&quot;rotation&quot;,&quot;rotation&quot;), n()/4)) %&gt;%
   mutate(time = factor(time, levels = c(&quot;before&quot;,&quot;after&quot;)))
head(myhips,10)</code></pre>
<pre><code># A tibble: 10 × 7
   grp   side  person obs   angle time   variable
   &lt;fct&gt; &lt;fct&gt; &lt;fct&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;fct&gt;  &lt;chr&gt;   
 1 treat right 1      fbef    125 before flexion 
 2 treat right 1      faft    126 after  flexion 
 3 treat right 1      rbef     25 before rotation
 4 treat right 1      raft     36 after  rotation
 5 treat left  1      fbef    120 before flexion 
 6 treat left  1      faft    127 after  flexion 
 7 treat left  1      rbef     35 before rotation
 8 treat left  1      raft     37 after  rotation
 9 treat right 2      fbef    135 before flexion 
10 treat right 2      faft    135 after  flexion </code></pre>
<pre class="r"><code>p &lt;- ggplot(subset(myhips, variable == &quot;flexion&quot;), aes(x = time, y = angle, fill = side)) + 
   theme_minimal() + geom_dotplot(binaxis = &quot;y&quot;, stackdir = &quot;center&quot;, binwidth = 1, 
      position = position_dodge(width = 0.5)) + facet_wrap(~ grp) + 
   labs(x = &quot;Observation Time&quot;, y = &quot;Hip Rotation Angle&quot;, fill = &quot;Hip&quot;)
plot(p)</code></pre>
<p><img src="lecture-04-29-2022_files/figure-html/unnamed-chunk-19-1.png" width="100%" style="display: block; margin: auto;" />
Here for each of two response variables (flexion and rotation) we have
two observations (before and after) for each hip (side) for each person.
Here we specify a random effect for each person and a random effect for
each hip within each person. Here we will consider the rotation response
variable. Note that I am assuming that there is not, on average, an
effect of left versus right side.</p>
<pre class="r"><code>m &lt;- lmer(angle ~ time * grp + (1|person) + (1|person:side), 
   subset = variable == &quot;rotation&quot;, data = myhips)
summary(m)</code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: angle ~ time * grp + (1 | person) + (1 | person:side)
   Data: myhips
 Subset: variable == &quot;rotation&quot;

REML criterion at convergence: 1033

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.0275 -0.5006  0.0254  0.4548  1.8289 

Random effects:
 Groups      Name        Variance Std.Dev.
 person:side (Intercept) 33.1     5.76    
 person      (Intercept) 27.6     5.25    
 Residual                18.0     4.24    
Number of obs: 156, groups:  person:side, 78; person, 39

Fixed effects:
                   Estimate Std. Error t value
(Intercept)          25.000      2.105   11.88
timeafter             0.958      1.224    0.78
grptreat             -0.222      2.529   -0.09
timeafter:grptreat    5.634      1.471    3.83

Correlation of Fixed Effects:
            (Intr) timftr grptrt
timeafter   -0.291              
grptreat    -0.832  0.242       
tmftr:grptr  0.242 -0.832 -0.291</code></pre>
<p>What is the estimated change in expected rotation from before to
after treatment in each group?</p>
<pre class="r"><code>trtools::contrast(m,
  a = list(time = &quot;after&quot;, grp = c(&quot;control&quot;,&quot;treat&quot;)),
  b = list(time = &quot;before&quot;, grp = c(&quot;control&quot;,&quot;treat&quot;)),
  cnames = c(&quot;control&quot;,&quot;treat&quot;))</code></pre>
<pre><code>        estimate     se  lower upper tvalue  df    pvalue
control   0.9583 1.2238 -1.440 3.357  0.783 Inf 4.336e-01
treat     6.5926 0.8159  4.993 8.192  8.080 Inf 6.468e-16</code></pre>
<p>The <code>icc_specs</code> function from the <strong>specr</strong>
package can be used to produce estimates concerning the “variance
components” (i.e., the variance due to person, side, and error).</p>
<pre class="r"><code>specr::icc_specs(m)</code></pre>
<pre><code>          grp  vcov    icc percent
1 person:side 33.14 0.4210   42.10
2      person 27.59 0.3506   35.06
3    Residual 17.97 0.2284   22.84</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
