---
output:
  html_document:
    theme: readable
  pdf_document: default
---

```{r, echo = FALSE, message = FALSE}
library(lubridate)
date <- "04-11-2022"
weekday <- wday(mdy(date), label = TRUE, abbr = FALSE)
month <- month(mdy(date), label = TRUE)
day <- day(mdy(date))
```

---
title: `r paste(weekday, ", ", month, " ", day, sep = "")`
header-includes:
  - \usepackage{array}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", message = FALSE, out.width = "100%", fig.align = "center", fig.width = 9, cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "pdf"))
```

```{r packages, echo = FALSE}
library(tidyverse)
library(kableExtra)
library(trtools)
```

```{r utilities, echo = FALSE}
source("../../utilities.R")
```

```{r options, echo = FALSE}
options(digits = 4, width = 90)
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](lecture-", date, ".pdf) copy of this lecture.", sep = ""), "")`

<!-- Note: Probably no need to cover ConvertWeibull since we can estimate a parametric proportional hazards model with flexsurvreg. -->

## Probability Density, Survival, and Hazard Functions

Let $T$ be a continuous random variable that is time-till-event. Four related functions are used to describe the distribution of $T$. 

### The Probability Density Function

The *probability density function* of $T$ is 
$$
  f(t) = \lim_{\delta t \rightarrow 0} \frac{P(t \le T < t + \delta t)}{\delta t}.
$$
If $\delta$ is relatively small then $P(t \le T < t + \delta t) \approx f(t)\delta t$ and so $f(t) \approx P(t \le T < t + \delta t)/(\delta t)$ and thus $f(t)$ is approximately *proportional* to the probability that $T$ is between $t$ and $t + \delta t$. *So $f(t)$ is approximately proportional to the probability that the event will happen "near" $t$.*

For the distribution below, the probability that $T$ is *approximately* 40 (say, between 39 and 41) equals the area under the curve and between 39 and 41. This probability is *approximated* by the rectangle, which has area $wf(40)$, where $w$ = 2 is the width of the rectangle and $f(40)$ is the height of the rectangle. So the probability that $T$ is approximately 40 is *proportional to* $f(40)$. 

```{r, echo = FALSE, fig.height}
par(mai = c(1,0.8,0.3,0.1))

x <- seq(0, 100, length = 1000)
y <- dlnorm(x, 3.25, s = 0.6)
plot(x, y, type = "l", bty = "n", ylab = "f(t)", xlab = "t", bty = "L")

trtools::aucpoly(x, function(z) dlnorm(z, 3.25, 0.6), 39, 41, col = grey(0.85), border = NA)

lines(c(39, 39), c(0, dlnorm(40, 3.25, 0.6)), lty = 2)
lines(c(41, 41), c(0, dlnorm(40, 3.25, 0.6)), lty = 2)
lines(c(39, 41), c(0,0), lty = 2)
lines(c(39, 41), c(dlnorm(40, 3.25, 0.6), dlnorm(40, 3.25, 0.6)), lty = 2)
```

<!-- ### The (Cumulative) Distribution Function -->

<!-- The *(cumulative) distribution function* is  -->
<!-- $$ -->
<!--   F(t) = P(T \le t).  -->
<!-- $$ -->
<!-- It equals the area under $f(t)$ and between 0 and $t$.  -->

<!-- ```{r, echo = FALSE, fig.height = 8} -->
<!-- m <- 2.25 + 1 -->
<!-- s <- 0.6 -->

<!-- q <- c(20,40,60,80) -->

<!-- par(mfrow = c(4,2), mai = c(0.6,0.8,0.3,0.1)) -->

<!-- for (i in 1:4) { -->

<!--   x <- seq(0, 100, length = 800) -->
<!--   y <- dlnorm(x, m, s) -->
<!--   plot(x, y, type = "l", bty = "n", ylab = "f(t)", xlab = "t", xaxt = "n") -->
<!--   axis(1, at = seq(0, 100, by = 20), cex.axis = 0.8) -->
<!--   x.p <- c(q[i], 100, seq(100, q[i], length = 1000)) -->
<!--   y.p <- c(0, 0, dlnorm(seq(100, q[i], length = 1000), m, s)) -->
<!--   trtools::aucpoly(x, function(z) dlnorm(z, m, s), 0, q[i], col = grey(0.85)) -->

<!--   y <- plnorm(x, m, s) -->
<!--   plot(x, y, type = "l", bty = "n", ylab = "F(t)", xlab = "t", xaxt = "n", yaxt = "n") -->
<!--   axis(2, at = seq(0, 1, by = 0.2), cex.axis = 0.8) -->
<!--   axis(1, at = seq(0, 100, by = 20), cex.axis = 0.8) -->
<!--   points(q[i], plnorm(q[i], m, s), pch = 16) -->
<!--   lines(c(q[i],q[i]), c(-10, plnorm(q[i], m, s)), lty = 3) -->
<!--   lines(c(-10, q[i]), rep(plnorm(q[i], m, s), 2), lty = 3) -->
<!-- } -->
<!-- ``` -->
<!-- Thus $f(t) = dF(t)/dt$ and -->
<!-- $$ -->
<!--   F(t) = \int_0^{t} \!\!\! f(z)dz. -->
<!-- $$ -->

### The Survival Function

The *survival function* is 
$$
  S(t) = P(T \ge t).
$$
It equals the area under $f(t)$ and between $t$ and $\infty$. The area under $S(t)$ equals $E(T)$ if $S(0) = 1$ and $S(\infty) = 1$. 

<!-- It is sometimes defined as $S(t) = P(T > t)$, which is the same function if $T$ is continuous, and thus $S(t) = 1 - F(t)$.  -->

```{r, echo = FALSE, fig.height = 8}
m <- 2.25 + 1
s <- 0.6

q <- c(20,40,60,80)

par(mfrow = c(4,2), mai = c(0.6,0.8,0.3,0.1))

for (i in 1:4) {
  
  x <- seq(0, 100, length = 800)
  y <- dlnorm(x, m, s)
  plot(x, y, type = "l", bty = "n", ylab = "f(t)", xlab = "t", xaxt = "n")
  axis(1, at = seq(0, 100, by = 20), cex.axis = 0.8)
  x.p <- c(q[i], 100, seq(100, q[i], length = 1000))
  y.p <- c(0, 0, dlnorm(seq(100, q[i], length = 1000), m, s))
  trtools::aucpoly(x, function(z) dlnorm(z, m, s), q[i], 100, col = grey(0.85))
  
  y <- 1-plnorm(x, m, s)
  plot(x, y, type = "l", bty = "n", ylab = "S(t)", xlab = "t", xaxt = "n", yaxt = "n")
  axis(2, at = seq(0, 1, by = 0.2), cex.axis = 0.8)
  axis(1, at = seq(0, 100, by = 20), cex.axis = 0.8)
  points(q[i], 1-plnorm(q[i], m, s), pch = 16)
  lines(c(q[i],q[i]), c(-10, 1-plnorm(q[i], m, s)), lty = 3)
  lines(c(-10, q[i]), rep(1-plnorm(q[i], m, s), 2), lty = 3)
}
```
Thus
$$
  S(t) = \int_t^{\infty} \!\!\! f(z)dz.
$$

### The Hazard Function

The *hazard function* is 
$$
h(t) = \lim_{\delta t \rightarrow 0} \frac{P(t \le T < t + \delta t|T \ge t)}{\delta t} = \frac{f(t)}{S(t)}.
$$
If $\delta$ is relatively small then $h(t)$ is approximately *proportional* to the probability that $t \le T < t + \delta t$ *given* survival up to $t$ --- i.e., $T \ge t$. *So $h(t)$ is approximately proportional to the probability of the event happening at near time $t$ if it has not yet happened.*

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(flexsurv)
par(mfcol = c(1,3))
x <- seq(0, 12, by = 0.1)
m <- 3
s <- 1
for (t in c(2,4,6)) {
  plot(x, dgamma(x, m, s), type = "l", bty = "n", xlab = "t", ylab = "", ylim = c(0, 0.8))
  lines(x[x>=t], dgamma(x[x>=t], m, s)/(1 - pgamma(t, m, s)), col = grey(0.5))
  points(t, hgamma(t, m, s), pch = 16)
  lines(c(t, t), c(0, hgamma(t, m, s)), lty = 3)
  lines(c(0, t), c(hgamma(t, m, s), hgamma(t, m, s)), lty = 3)
  lines(x, hgamma(x, m, s), type = "l", lty = 2)
  if (t == 2) {
    text(4, 0.055, "f(t)")
    text(2.5, 0.57, "h(t)")
  }
}
```

## Distributions and Hazard Functions

A wide variety of distributions can be used for parametric survival models such as AFT models. Below is a list of just some of those distributions. One of the more noticeable differences between them is the shape of their hazard functions. 

1. *Log-normal*. The distribution of $\log(T_i)$ is normal. Single-peaked hazard function. Known as `lognormal` by `survreg` and `flexsurvreg`, and also `lnorm` by `flexsurvreg`.

2. *Log-logistic*. The distribution of $\log(T_i)$ is logistic. Single-peaked or decreasing hazard function. Known as `loglogistic` by `survreg` and `flexsurvreg` and `llogis` by `flexsurvreg`. 

3. *Gamma*. Monotonic or flat hazard function. Known as `gamma` to `flexsurvreg`. 

4. *Weibull*. Monotonic or flat hazard function. Known as `weibull` to both `survreg` and `flexsurvreg`. 

5. *Exponential*. Flat hazard function ("memoryless"). Known as `exp` to `flexsurvreg` but also as a special case of `weibull` if `scale = 1` with `survreg`. 

6. *Gompertz*. Increasing hazard function. Known as `gompertz` to `flexsurvreg`. 

7. *Generalized gamma*. Monotonic, single-peaked, and "bathtub" hazard functions. The exponential, Weibull, gamma, and log-normal are special cases. Known as `gengamma` to `flexsurvreg`. 

8. *Generalized F*. Single-peaked or decreasing. Known as `genf` to `flexsurvreg`. 

## Estimating and Plotting Hazard Functions

The `summary` function can be used to estimate the hazard function based on a `flexsurvreg` model object.

**Example**: Consider data from an experiment on the effects of sexual activity on the lifespan of the male fruitfly. Thorax length was used as a covariate. 
```{r, message = FALSE}
library(faraway)
p <- ggplot(fruitfly, aes(x = thorax, y = longevity)) + 
  geom_point() + facet_wrap(~ activity, ncol = 5) + 
  labs(x = "Thorax Length (mm)", y = "Longevity (days)") + 
  theme_minimal()
plot(p)
```
```{r}
m <- flexsurvreg(Surv(longevity) ~ activity + thorax,
  data = fruitfly, dist = "gamma")
 
d <- data.frame(activity = levels(fruitfly$activity), thorax = 0.8)
d <- summary(m, newdata = d, t = seq(0, 100, length = 100), 
 type = "hazard", tidy = TRUE)
head(d)

p <- ggplot(d, aes(x = time, y = est, color = activity)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Days", y = "h(t)", color = "Condition", title = "Hazard Functions")
plot(p)
```
```{r}
d <- expand.grid(activity = levels(fruitfly$activity), thorax = c(0.7,0.8,0.9))
d <- summary(m, newdata = d, t = seq(0, 100, length = 100), 
  type = "hazard", tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est, color = activity)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Days", y = "h(t)", color = "Condition", title = "Hazard Functions") +
  facet_wrap(~ thorax)
plot(p)
```
For comparison here are the *survival functions*.
```{r}
d <- expand.grid(activity = levels(fruitfly$activity), thorax = c(0.7,0.8,0.9))
d <- summary(m, newdata = d, t = seq(0, 100, length = 100), 
  type = "survival", tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est, color = activity)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Days", y = "S(t)", color = "Condition", title = "Survival Functions") +
  facet_wrap(~ thorax)
plot(p)
```
And here are the *probability density functions*.
```{r}
d <- expand.grid(activity = levels(fruitfly$activity), thorax = c(0.7,0.8,0.9))
d <- summary(m, newdata = d, t = seq(0, 100, length = 100), 
  fn = function(t, ...) dgamma(t, ...), tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est, color = activity)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Days", y = "f(t)", color = "Condition", title = "Density Functions") +
  facet_wrap(~ thorax)
plot(p)
```
Note that we can adapt this to other distributions by adding a `d` to the beginning of the distribution name recognized by `flexsurvreg`. This include log-normal (`dlnorm`), log-logistic (`dllogis`), gamma (`dgamma`), Weibull (`dweibull`), exponential (`dexp`), Gompertz (`dgompertz`), generalized gamma (`dgengamma`), and generalized *F* (`dgenf`). 

Finally we can also plot the *expected* survival time. This is analogous to using `predict` with `type = response` in a GLM. 
```{r}
d <- expand.grid(activity = levels(fruitfly$activity), 
  thorax = seq(0.6, 1.0, length = 100))
d <- summary(m, newdata = d, type = "mean", tidy = TRUE)
head(d)

p <- ggplot(d, aes(x = thorax, y = est, color = activity)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Thorax Length (mm)", y = "E(T)", color = "Condition",
    title = "Expected Survival Time")
plot(p)

p <- ggplot(fruitfly, aes(x = thorax, y = longevity)) + 
  geom_point() + facet_wrap(~ activity, ncol = 5) + 
  labs(x = "Thorax Length (mm)", y = "Longevity (days)",
   title = "Observed and Expected Survival Time") + 
  theme_minimal() + geom_line(aes(y = est), data = d)
plot(p)
```

**Example**: Consider an AFT model for the `leukemia` data.
```{r, fig.width = 9}
library(survival)
leukemia$status <- factor(leukemia$status, labels = c("alive","dead"))

m <- flexsurvreg(Surv(time, status == "dead") ~ x, 
  dist = "weibull", data = leukemia)

# create plot of hazard functions
d <- data.frame(x = c("Maintained","Nonmaintained"))
d <- summary(m, newdata = d, t = seq(1, 200, length = 1000),
  type = "hazard", tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est)) + 
  geom_line(aes(linetype = x)) + theme_minimal() + 
  labs(x = "Time", y = "h(t)", linetype = "Extended",
    title = "Hazard Functions") + theme(legend.position = c(0.8, 0.5))
p.h <- p

# create plot of survival functions
d <- data.frame(x = c("Maintained","Nonmaintained"))
d <- summary(m, newdata = d, t = seq(1, 200, length = 1000),
  type = "survival", tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est)) + 
  geom_line(aes(linetype = x)) + theme_minimal() + 
  labs(x = "Time", y = "S(t)", linetype = "Extended",
    title = "Survival Functions") + theme(legend.position = c(0.7, 0.7))
p.s <- p

# create plot of probability density functions
d <- data.frame(x = c("Maintained","Nonmaintained"))
d <- summary(m, newdata = d, t = seq(1, 200, length = 1000),
  fn = function(t, ...) dweibull(t, ...), tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est)) + 
  geom_line(aes(linetype = x)) + theme_minimal() + 
  labs(x = "Time", y = "f(t)", linetype = "Extended", 
    title = "Probability Density Functions") +
  theme(legend.position = c(0.7, 0.7))
p.d <- p

# put the plots together into one plot
cowplot::plot_grid(p.h, p.s, p.d, ncol = 3)
```
We can also plot the raw data with the estimated expected survival times and confidence intervals for the estimated expected survival time. 
```{r}
d <- summary(m, newdata = data.frame(x = c("Maintained","Nonmaintained")), 
 type = "mean", tidy = TRUE)
d
p <- ggplot(leukemia, aes(x = x, y = time)) + 
  geom_dotplot(aes(fill = status), stackdir = "center", binaxis = "y", 
    binwidth = 1, dotsize = 2, alpha = 0.5) + coord_flip() + 
  scale_fill_manual(name = "Status", values = c("white","black")) + 
  geom_pointrange(aes(y = est, ymin = lcl, ymax = ucl), 
    shape = 3, data = d) + 
  labs(x = "Maintained", y = "Remission Time (weeks)") + 
  theme_classic() + theme(legend.position = c(0.8, 0.8))
plot(p)
```

A very useful feature of the **flexsurv** package is that a user can program their own distribution for use with the functions therein.

## Proportional Hazards Models

Let $h_0(t)$ be the "baseline" hazard function (i.e., the hazard function when all $x_j = 0$). A *proportional hazards model* has the form
$$
	h_i(t) = h_0(t)e^{\beta_1 x_{i1}} e^{\beta_2 x_{i2}} \cdots e^{\beta_k x_{ik}},
$$
so that $h_i(t) \propto e^{\beta_1 x_{i1}} e^{\beta_2 x_{i2}} \cdots e^{\beta_k x_{ik}}$. Thus increasing $x_j$ by one changes the hazard function by a factor of $e^{\beta_j}$. This is the *hazard ratio*. For example, the hazard ratio for $x_1$ is 
$$
	\frac{h_0(t)e^{\beta_1 (x_1 + 1)} e^{\beta_2 x_2} \cdots e^{\beta_k x_k}}{h_0(t)e^{\beta_1 x_1} e^{\beta_2 x_2} \cdots e^{\beta_k x_k}} = e^{\beta_1},
$$
since $e^{\beta_1 (x_1 + 1)} = e^{\beta_1 x_1}e^{\beta_1}$. 

## Parametric Proportional Hazards Models

AFT models with a Weibull distribution (or exponential, which is a special case of the Weibull distribution) are also proportional hazards models. Consider the AFT model,
$$
	\log T_i = \beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + \cdots + \beta_k x_{ik}
	+ \sigma\epsilon_i,
$$
and the proportional hazards model
$$
	h_i(t) = h_0(t)\exp(\beta_1^* x_{i1} + \beta_2^* x_{i2} + 
	\cdots + \beta_k^* x_{ik}),
$$
where in both cases $T_i$ has a *Weibull* distribution. It can be shown that the models are equivalent with
$$
	\beta_j^* = -\beta_j/\sigma.
$$
The hazard ratios are $e^{\beta_j^*}$. 

An AFT model with a Weibull distribution is the *only* AFT model that is also a proportional hazards model. Other proportional hazards models exist, but none of the them are AFT models.

**Example**: We can estimate a Weibull proportional hazards model for the `leukemia` data using `survreg` as follows.
```{r}
m <- survreg(Surv(time, status == "dead") ~ x, dist = "weibull", data = leukemia)
summary(m)
```
The estimated hazard ratio is $e^{\hat\beta_1^*}$ where $\hat\beta_1^* \approx `r -round(m$coefficients[-1],3)`/`r round(m$scale,3)` \approx `r -m$coefficients[-1]/m$scale`$ so $e^{\hat\beta_1^*} \approx `r exp(-m$coefficients[-1]/m$scale)`$. Thus
$$
  \frac{h_n(t)}{h_y(t)} = e^{\beta_1^*} \Leftrightarrow h_n(t) = e^{\beta_1^*}h_y(t),
$$
where we estimate the hazard ratio $e^{\beta_1^*}$ to be `r exp(-m$coefficients[-1]/m$scale)`. This conversion can be done using the `ConvertWeibull` function from the **SurvRegCensCov** package. 
```{r, warning = FALSE}
library(SurvRegCensCov)
ConvertWeibull(m)
```
Another approach is to use `dist = "weibullPH"` with `flexsurvreg` which uses a different parameterization of the Weibull distribution so that applying the exponential function to the parameters gives hazard ratios. 
```{r}
m <- flexsurvreg(Surv(time, status == "dead") ~ x, dist = "weibullPH", data = leukemia)
print(m)
```
The proportionality can be seen when plotting the hazard functions.
```{r}
d <- data.frame(x = c("Maintained","Nonmaintained"))
d <- summary(m, newdata = d, t = seq(1, 200, length = 1000),
  type = "hazard", tidy = TRUE)

p <- ggplot(d, aes(x = time, y = est)) + 
  geom_line(aes(linetype = x)) + theme_minimal() + 
  labs(x = "Time", y = "h(t)", linetype = "Extended", title = "Hazard Functions") +
  theme(legend.position = c(0.8, 0.5))
plot(p)
```

**Example**: Consider a Weibull proportional hazards model for the `motors` data.
```{r, warning = FALSE}
m <- flexsurvreg(Surv(time, cens) ~ temp, data = MASS::motors, dist = "weibullPH")
print(m)
```
Here we have that
$$
  h_{x+1}(t) = e^{\beta_1^*}h_x{(t)},
$$
where $h_x(t)$ and $h_{x+1}(t)$ represent the hazard functions at temperatures of $x$ and $x+1$, respectively. The estimated hazard ratio is $e^{\hat\beta_1^*} = 1.15$. 

```{r}
d <- summary(m, newdata = data.frame(temp = seq(110, 150, by = 10)), 
  t = seq(0, 8000, length = 1000), type = "hazard", tidy = TRUE, ci = FALSE)

p <- ggplot(d, aes(x = time, y = est, color = factor(temp))) + 
  geom_line() + theme_minimal() + theme(legend.position = c(0.2, 0.6)) + 
  labs(x = "Hours", y = "h(t)", color = "Temperature", title = "Hazard Functions")
plot(p)
```

