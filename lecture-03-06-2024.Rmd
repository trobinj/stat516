---
output:
  html_document: 
    theme: readable
  pdf_document: default
---

```{r, echo = FALSE, message = FALSE}
library(lubridate)
date <- "03-06-2024"
weekday <- wday(mdy(date), label = TRUE, abbr = FALSE)
month <- month(mdy(date), label = TRUE)
day <- day(mdy(date))
```

---
title: `r paste(weekday, ", ", month, " ", day, sep = "")`
header-includes:
  - \usepackage{float}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(comment = "", echo = TRUE, fig.height = 4, message = FALSE, out.width = "100%", fig.align = "center", cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "pdf"))
```

```{r packages, echo = FALSE}
library(tidyverse)
suppressWarnings(library(kableExtra))
```

```{r utilities, echo = FALSE}
source("../../utilities.R")
```

```{r options, echo = FALSE}
options(digits = 4, width = 100)
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](lecture-", date, ".pdf) copy of this lecture.", sep = ""), "")`

## Odds Ratios Examples

Consider the following data from an experiment that investigated the effects of three insecticides on four beetles. 
```{r}
library(trtools) # contains the insecticide data frame
insecticide
p <- ggplot(insecticide, aes(x = deposit, y = deaths/total)) +
  geom_point() + facet_wrap(~ insecticide) + theme_minimal() + 
  labs(x = "Deposit (mg per 10 square cm)", y = "Proportion Dead")
plot(p)
```
First consider an "additive" logistic regression model (i.e., a model with no interaction). 
```{r}
m <- glm(cbind(deaths, total-deaths) ~ insecticide + deposit, 
  family = binomial, data = insecticide)
summary(m)$coefficients
d <- expand.grid(deposit = seq(2, 8, length = 100), 
  insecticide = c("DDT","g-BHC","both"))
d$yhat <- predict(m, newdata = d, type = "response")
p <- p + geom_line(aes(y = yhat), data = d)
plot(p)
```
A model for the *odds* of death can be written as
$$
  O_i = e^{\beta_0}e^{\beta_1x_{i1}}e^{\beta_2x_{i2}}e^{\beta_3x_{i3}}
$$
where $x_{i1}$ and $x_{i2}$ are indicator variables for the insecticides `both` and `DDT`, respectively, and $x_{i3}$ is deposit. This can be written case-wise as
$$
  O_i = 
  \begin{cases}
    e^{\beta_0}e^{\beta_3d_i},            & \text{if the $i$-th observation of insecticide is g-BHC}, \\
    e^{\beta_0}e^{\beta_1}e^{\beta_3d_i}, & \text{if the $i$-th observation of insecticide is both}, \\
    e^{\beta_0}e^{\beta_2}e^{\beta_3d_i}, & \text{if the $i$-th observation of insecticide is DDT}, 
  \end{cases}    
$$
and where $d_i = x_{i3}$ is the deposit. We could plot the estimated *odds* of death as a function of deposit and insecticide type. 
```{r}
d <- expand.grid(deposit = seq(2, 8, length = 100),
  insecticide = c("g-BHC","both","DDT"))
d$yhat <- predict(m, newdata = d, type = "response")
d$odds <- d$yhat / (1 - d$yhat)

p <- ggplot(d, aes(x = deposit, y = odds)) + 
  geom_line() + facet_wrap(~ insecticide) + theme_minimal() + 
  labs(x = "Deposit (mg per 10 square cm)", y = "Odds of Death")
plot(p)
```
It can be shown that the odds ratio for a one unit increase in deposit is $e^{\beta_3}$ (regardless of insecticide used), and the odds ratio for comparing `both` with `g-BHC` is $e^{\beta_1}$ (regardless of deposit amount). We can get these odds ratios as follows.
```{r}
exp(cbind(coef(m), confint(m)))
```
But using `contrast` allows us to do this without having to figure out the parameterization.
```{r}
# estimate the odds ratio for dose (one unit increase)
contrast(m,
  a = list(deposit = 3, insecticide = c("DDT","g-BHC","both")),
  b = list(deposit = 2, insecticide = c("DDT","g-BHC","both")),
  cnames = c("DDT","g-BHC","both"), tf = exp)
# estimate the odds ratio for type of insecticide (both versus DDT)
contrast(m, 
  a = list(deposit = c(2,5,8), insecticide = "both"),
  b = list(deposit = c(2,5,8), insecticide = "g-BHC"), 
  cnames = c("2mg","5mg","8mg"), tf = exp)
```
Now suppose we include an interaction between dose and type of insecticide.
```{r}
m.int <- glm(cbind(deaths, total-deaths) ~ insecticide * deposit, 
  family = binomial, data = insecticide)
summary(m.int)$coefficients
d <- expand.grid(deposit = seq(2, 8, length = 100),
  insecticide = c("DDT","g-BHC","both"))
d$yhat <- predict(m.int, newdata = d, type = "response")

p <- ggplot(insecticide, aes(x = deposit, y = deaths/total)) + 
  geom_point() + facet_wrap(~ insecticide) + theme_minimal() + 
  labs(x = "Deposit (mg per 10 square cm)", y = "Proportion Dead") +
  geom_line(aes(y = yhat), data = d)
plot(p)
# estimate the odds ratio for the effect of dose
contrast(m.int,
  a = list(deposit = 3, insecticide = c("DDT","g-BHC","both")),
  b = list(deposit = 2, insecticide = c("DDT","g-BHC","both")),
  cnames = c("DDT","g-BHC","both"), tf = exp)
# estimate the odds ratio for the effect of type of insecticide (both versus g-BHC)
contrast(m.int, 
  a = list(deposit = c(2,5,8), insecticide = "both"),
  b = list(deposit = c(2,5,8), insecticide = "g-BHC"), 
  cnames = c("2mg","5mg","8mg"), tf = exp)
```
Now consider a model where we use $\log$ transformation of dose.
```{r}
m <- glm(cbind(deaths, total-deaths) ~ insecticide * log(deposit), 
  family = binomial, data = insecticide)
summary(m)$coefficients
d <- expand.grid(deposit = seq(2, 8, length = 100),
  insecticide = c("DDT","g-BHC","both"))
d$yhat <- predict(m, newdata = d, type = "response")
p <- p + geom_line(aes(y = yhat), data = d, linetype = 3)
plot(p)
```
Now the odds ratio shows the effect of *doubling* the dose.
```{r}
# odds ratio for the effect of increasing dose from 1 to 2 (doubling)
contrast(m,
  a = list(deposit = 2, insecticide = c("DDT","g-BHC","both")),
  b = list(deposit = 1, insecticide = c("DDT","g-BHC","both")),
  cnames = c("DDT","g-BHC","both"), tf = exp)
# odds ratio for the effect of increasing dose from 2 to 4 (doubling)
contrast(m,
  a = list(deposit = 4, insecticide = c("DDT","g-BHC","both")),
  b = list(deposit = 2, insecticide = c("DDT","g-BHC","both")),
  cnames = c("DDT","g-BHC","both"), tf = exp)
# odds ratio for the effect of increasing dose from 2 to 3 (not doubling)
contrast(m,
  a = list(deposit = 3, insecticide = c("DDT","g-BHC","both")),
  b = list(deposit = 2, insecticide = c("DDT","g-BHC","both")),
  cnames = c("DDT","g-BHC","both"), tf = exp)
```
Contrasts between insecticides can proceed in the usual way although the results are not quite the same as when we did not transform dose.
```{r}
# odds ratio to compare two insecticides at three doses
contrast(m, 
  a = list(deposit = c(2,5,8), insecticide = "both"),
  b = list(deposit = c(2,5,8), insecticide = "g-BHC"), 
  cnames = c("2mg","5mg","8mg"), tf = exp)
```
At some point we will want to visit the issue of how to evaluate/select models.

## Binary/Bernoulli Logistic Regression Example

Consider the following data from a study that investigated the relationship between vasoconstriction and the rate and volume of air breathed by human subjects. Here the response variable is *binary* and thus has a *Bernoulli* distribution (a special case of the binomial distribution). 
```{r, fig.height = 5, message = FALSE}
library(catdata)
data(vaso)
head(vaso)
```
Volume (`vol`) is the logarithm of volume in liters, and rate (`rate`) is the logarithm of liters per second. For this example I am going to transform these variables to the volume and rate in deciliters.
```{r}
vaso$dvolume <- exp(vaso$vol)*10       # transform to deciliters
vaso$drate <- exp(vaso$rate)*10        # transform to deciliters per sec
```
I am also going to create a couple different versions of the response variable: one that is a character for plotting and one that is binary for modeling (note that the help file for `vaso` has coding on the `vaso` variable backwards).
```{r}
vaso$vasoconstriction <- ifelse(vaso$vaso == 1, "yes", "no")
vaso$y <- ifelse(vaso$vaso == 1, 1, 0) # create binary response
head(vaso)
```
Here is a scatterplot of volume and rate, with point color indicating vasoconstriction.
```{r}
p <- ggplot(vaso, aes(x = dvolume, y = drate)) + 
  geom_point(aes(fill = vasoconstriction), shape = 21) +
  scale_fill_manual(values = c("white","black")) + 
  labs(x = "Volume of Air Inspired (deciliters)", 
    y = "Rate of Inspiration (deciliters/sec)", 
    fill = "Vasoconstriction?") + 
  theme_minimal() + 
  theme(legend.position = "inside", legend.position.inside = c(0.85, 0.9))
plot(p)
```
If the response variable is *binary* (i.e., 0 or 1) then we can use `glm(y ~ ...)` rather than `glm(cbind(y, 1-y) ~ ...)`.
```{r, fig.height = 5, message = FALSE}
m <- glm(y ~ dvolume + drate, family = binomial, data = vaso)
cbind(summary(m)$coefficients, confint(m))
exp(cbind(coef(m), confint(m)))
d <- expand.grid(dvolume = seq(0, 40, length = 100), 
  drate = seq(0, 40, length = 100))
d$yhat <- predict(m, newdata = d, type = "response")

library(metR) # for geom_text_contour

p <- ggplot(vaso, aes(x = dvolume, y = drate)) + 
  geom_point(aes(fill = vasoconstriction), shape = 21) +
  scale_fill_manual(values = c("white","black")) + 
  geom_contour(aes(z = yhat), data = d, color = "black",
    linewidth = 0.15, breaks = seq(0.05, 0.95, by = 0.05)) +
  geom_text_contour(aes(z = yhat), data = d) + 
  labs(x = "Volume of Air Inspired (deciliters)", 
    y = "Rate of Inspiration (deciliters/sec)", 
    fill = "Vasoconstriction?") + 
  theme_minimal() + 
  theme(legend.position = "inside", legend.position.inside = c(0.85, 0.9))
plot(p)

# odds ratio for the effect of volume 
contrast(m, tf = exp,
  a = list(dvolume = 2, drate = c(10,20,30)),
  b = list(dvolume = 1, drate = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl/sec")))
# odds ratios for rate
contrast(m, tf = exp,
  a = list(drate = 2, dvolume = c(10,20,30)),
  b = list(drate = 1, dvolume = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl")))
```

Now consider a model with a product term (i.e., "interaction") for volume and rate.
```{r, fig.height = 5, message = FALSE}
m <- glm(y ~ dvolume + drate + dvolume*drate, family = binomial, data = vaso)
summary(m)$coefficients
d <- expand.grid(dvolume = seq(0, 40, length = 100), drate = seq(0, 40, length = 100))

d$yhat <- predict(m, newdata = d, type = "response")
p <- ggplot(vaso, aes(x = dvolume, y = drate)) + 
  geom_point(aes(fill = vasoconstriction), shape = 21) +
  scale_fill_manual(values = c("white","black")) + 
  geom_contour(aes(z = yhat), data = d, color = "black",
    linewidth = 0.15, breaks = seq(0.05, 0.95, by = 0.05)) +
  geom_text_contour(aes(z = yhat), data = d) + 
  labs(x = "Volume of Air Inspired (deciliters)", 
    y = "Rate of Inspiration (deciliters/sec)", 
    fill = "Vasoconstriction?") + 
  theme_minimal() + 
  theme(legend.position = "inside", legend.position.inside = c(0.85, 0.9))
plot(p)
# odds ratios for the effect of volume
contrast(m, tf = exp,
  a = list(dvolume = 2, drate = c(10,20,30)),
  b = list(dvolume = 1, drate = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl/sec")))
# odds ratios for the effect of rate
contrast(m, tf = exp,
  a = list(drate = 2, dvolume = c(10,20,30)),
  b = list(drate = 1, dvolume = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl")))
```
Now about a model where we transform volume and rate to make it additive on the log scale?
```{r, fig.height = 5, message = FALSE}
m <- glm(y ~ log(dvolume) + log(drate), family = binomial, data = vaso)
exp(cbind(coef(m), confint(m)))
d <- expand.grid(dvolume = seq(0, 40, length = 100),
  drate = seq(0, 40, length = 100))
d$yhat <- predict(m, newdata = d, type = "response")

p <- ggplot(vaso, aes(x = dvolume, y = drate)) + 
  geom_point(aes(fill = vasoconstriction), shape = 21) +
  scale_fill_manual(values = c("white","black")) + 
  geom_contour(aes(z = yhat), data = d, color = "black",
    linewidth = 0.15, breaks = seq(0.05, 0.95, by = 0.05)) +
  geom_text_contour(aes(z = yhat), data = d) + 
  labs(x = "Volume of Air Inspired (deciliters)", 
    y = "Rate of Inspiration (deciliters/sec)", 
    fill = "Vasoconstriction?") + 
  theme_minimal() + 
  theme(legend.position = "inside", legend.position.inside = c(0.85, 0.9))
plot(p)
# odds ratios for the effect of volume
contrast(m, tf = exp,
  a = list(dvolume = 2, drate = c(10,20,30)),
  b = list(dvolume = 1, drate = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl/sec")))
# odds ratios for the effect of rate
contrast(m, tf = exp,
  a = list(drate = 2, dvolume = c(10,20,30)),
  b = list(drate = 1, dvolume = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl")))
```
Doubling the volume or rate is a relatively large change. How about increasing it by only, say, 10% rather than 100%?
```{r}
# odds ratios for the effect of volume
contrast(m, tf = exp,
  a = list(dvolume = 1.1, drate = c(10,20,30)),
  b = list(dvolume = 1.0, drate = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl/sec")))
# odds ratios for the effect of rate
contrast(m, tf = exp,
  a = list(drate = 1.1, dvolume = c(10,20,30)),
  b = list(drate = 1.0, dvolume = c(10,20,30)),
  cnames = c(paste("at", c(10,20,30), "dl")))
```
Note that we'd get the same results for *any* 10% increase in volume or rate (e.g., from 2.0 to 2.2) because both are on the log scale.
