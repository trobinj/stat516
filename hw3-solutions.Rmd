---
title: "Poisson and Logistic Regression"
subtitle: Statistics 516, Homework 3 (Solutions)
output:
  html_document:
    theme: readable
  pdf_document: default
header-includes:
  - \usepackage{booktabs}
  - \usepackage{float}
  - \usepackage{array}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", message = FALSE, out.width = "100%", fig.align = "center", fig.width = 9, cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "pdf"))
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](hw3.pdf) copy of this homework assignment.", sep = ""), "")`

```{r options, echo = FALSE}
options(digits = 4, width = 100)
```

## Lip Cancer in Scotland

The data frame `epi.SClip` from the **epiR** package features data on the incidence of lip cancer in Scotland from 1975 to 1980. The following code processes the data for plotting and modeling, and shows the first few observations of a new data frame called `lipcancer`.[^order]
```{r}
library(epiR)
data(epi.SClip) # necessary to "load" the data

library(dplyr)
lipcancer <- epi.SClip %>% 
  mutate(district = factor(district, levels = rev(sort(unique(district))))) %>% 
  mutate(percent = paste(prop.ag, "%", sep = "")) %>%
  mutate(percent = reorder(percent, prop.ag)) %>% 
  select(district, cases, population, percent)
head(lipcancer)
```
The data show for each of 56 districts the number of cases of lip cancer, the population (in person-years), and the percent of the population engaged in outdoor activity. Person-years is the sum of the number of years of exposure of all the people living in each district between 1975 to 1980.[^personyears] The percent of people involved in outdoor activity (e.g., agriculture, fishing, forestry) is of interest because exposure to sunlight is a risk factor for lip cancer.[^ecologicalfallacy] The plot below shows the number of cases of lip cancer per person-year for each district, grouped by percent of the population engaged in outdoor activity. Note that the size of each point is proportional to the number of person-years for that district.

```{r, fig.height = 7}
library(ggplot2)
p <- ggplot(lipcancer, aes(y = district, x = cases/population)) +
  theme_minimal() + geom_point(aes(size = population)) + 
  facet_grid(percent ~ ., scales = "free_y", space = "free_y") + 
  labs(y = NULL, x = "Cases per Person-Year", size = "Person-Years:") + 
  scale_x_continuous(labels = scales::label_number()) + 
  theme(axis.text.y = element_text(size = 7), legend.position = "top")
plot(p)
```
The objective here will be to model the relationship between the incidence rate of lip cancer and the percent of the population engaged in outdoor activity using Poisson regression. 

1. Estimate a Poisson regression model for the rate of lip cancer, using the percent of the population engaged in outdoor activity as the only explanatory variable. Note that it will be treated here as a categorical explanatory variable, which will happen automatically since it is stored in the data frame as a character rather than a number. You will **not** be using `district` as an explanatory variable in your model.[^district] Be sure to include an offset variable to account for differences in the person-years across districts. Show the parameter estimates and their standard errors using the `summary` function so that I can verify that you estimated the model correctly.

    **Solution**: We can estimate this model as follows.
    ```{r}
    m <- glm(cases ~ offset(log(population)) + percent, 
      family = poisson, data = lipcancer)
    summary(m)$coefficients
    ```

0. Estimate the expected number of cases of lip cancer per 100K (i.e., 100,000) person-years for each value of the percent of the explanatory variable. But be sure that you set the value of the offset variable to account for the fact that you are estimating the rate per 100K person-years and not per person-year.

    **Solution**: I will show a couple of ways to do this.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(percent = sort(unique(lipcancer$percent)), population = 100000),
      cnames = sort(unique(lipcancer$percent)))
    library(emmeans)
    emmeans(m, ~percent, type = "response", offset = log(100000))
    ```
    Now suppose we want to show the estimated rate of lip cancer on the plot. This needs to be per person-year, since that is the scale used for the plot. Here is one way to do that.
    ```{r, fig.height = 7}
    d <- data.frame(percent = sort(unique(lipcancer$percent)),
      population = 1)
    d$yhat <- predict(m, newdata = d, type = "response")
    p <- ggplot(lipcancer, aes(y = district, x = cases/population)) +
      theme_minimal() + geom_point(aes(size = population)) + 
      facet_grid(percent ~ ., scales = "free_y", space = "free_y") + 
      labs(y = NULL, x = "Cases per Person-Year", size = "Person-Years:") + 
      scale_x_continuous(labels = scales::label_number()) + 
      theme(axis.text.y = element_text(size = 7), legend.position = "top") + 
      geom_vline(aes(xintercept = yhat), data = d)
  plot(p)
    ```
  
0. Estimate five rate ratios to compare the rate of lip cancer at 1%, 7%, 10%, 16%, and 24% versus 0% of the population involved in outdoor activity. Write a sentence or two to interpret each estimated rate ratio in terms of the relationship between the percent of the population involved in outdoor activity and the rate of lip cancer.

    **Solution**: I will show a couple of ways to estimate these rate ratios.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(percent = c("1%","7%","10%","16%","24%"), population = 1),
      b = list(percent = "0%", population = 1),
      cnames = paste(c("1%","7%","10%","16%","24%"), "vs 0%"))
    emmeans::contrast(emmeans(m, ~percent, offset = log(1), type = "response"),
      method = "trt.vs.ctrl", ref = 1, infer = TRUE, adjust = "none")
    ```
    Note that the value of the offset does not matter here since we are looking at ratios. We can interpret these as follows.
    
    *The rate of lip cancer is in a district with a percent outdoor activity of 1% is about 1.25 times that of a district with an outdoor activity of 0% (i.e., about 25% higher).*
    
    *The rate of lip cancer is in a district with a percent outdoor activity of 7% is about 3.64 times that of a district with an outdoor activity of 0% (i.e., about 264% higher).*
        
    *The rate of lip cancer is in a district with a percent outdoor activity of 10% is about 3.65 times that of a district with an outdoor activity of 0% (i.e., about 265% higher).*
            
    *The rate of lip cancer is in a district with a percent outdoor activity of 16% is about 4.48 times that of a district with an outdoor activity of 0% (i.e., about 348% higher).*
                
    *The rate of lip cancer is in a district with a percent outdoor activity of 24% is about 7.59 times that of a district with an outdoor activity of 0% (i.e., about 659% higher).*
    
    Alternatively we can "flip" the rate ratios in the following way.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(percent = "0%", population = 1),
      b = list(percent = c("1%","7%","10%","16%","24%"), population = 1),
      cnames = paste("0% vs", c("1%","7%","10%","16%","24%")))
    emmeans::contrast(emmeans(m, ~percent, offset = log(1), type = "response"),
      method = "trt.vs.ctrl", ref = 1, infer = TRUE, adjust = "none", reverse = TRUE)
    ```
    We can interpret these rate ratios as follows.
    
    *The rate of lip cancer in a district with a percent of outdoor activity of 0% is about 0.8 times that of a district with a percent of outdoor activity of 1% (i.e., about 20% lower).*
    
    *The rate of lip cancer in a district with a percent of outdoor activity of 0% is about 0.275 times that of a district with a percent of outdoor activity of 7% (i.e., about 72.5% lower).*
    
    *The rate of lip cancer in a district with a percent of outdoor activity of 0% is about 0.274 times that of a district with a percent of outdoor activity of 10% (i.e., about 72.6% lower).*
            
    *The rate of lip cancer in a district with a percent of outdoor activity of 0% is about 0.22 times that of a district with a percent of outdoor activity of 16% (i.e., about 78% lower).*
                
    *The rate of lip cancer in a district with a percent of outdoor activity of 0% is about 0.13 times that of a district with a percent of outdoor activity of 24% (i.e., about 87% lower).*

[^district]: There may be considerable variation in the rate of lip cancer across districts, even among those with the same percent of the population engaged in outdoor activity. There are several ways that we might try to account for this. One would be to account for *over-dispersion* in the data due to variation between districts. Another approach would be to introduce a *random effect* for district. You might consider these approaches in future homework assignments.  

[^order]: Aside from some variable selection and renaming, this code sets the order of the levels of `district` so that they are alphabetical from top to bottom in the plot, and the values of `percent` so that they increase from top to bottom in the plot.

[^personyears]: Person-years is a common denominator in rates in epidemiology. It allows us to estimate the number of cases per person per year, controlling for both the number of people and how long they were observed. To compute person-years one needs to sum the years of observation of all the people observed. It also allows to account for changes in the size of the population. For example, suppose we observed a very small population for five years. Two of the people lived there all five years, but one person moved away after the third year. The total number of person-years would then be 5 + 5 + 3 = 13.

[^ecologicalfallacy]: One must be very cautious about assuming that a relationship at the group level (e.g., district) implies a similar association at the individual level. This is known as the [ecological fallacy](https://en.wikipedia.org/wiki/Ecological_fallacy). Districts with a larger percent of the population engaged in outdoor activities may differ in other ways from those with a smaller percentage that may, in part, be responsible for a higher incidence of lip cancer. 

## Treatment of Familial Adenomatous Polyposis

[Familial adenomatous polyposis (FAP)](https://en.wikipedia.org/wiki/Familial_adenomatous_polyposis) is a rare genetic condition that causes polyps to form in the large intestine and rectum. These polyps are likely to later become cancerous. Data from a study that investigated the effectiveness of a non-steroidal anti-inflammatory drug for treating FAP are in the data frame `polyps` in the package **HSAUR3**.[^giardiello]
```{r, fig.height = 2}
library(HSAUR3)
polyps
```
The plots below show the raw data.
```{r}
library(ggplot2)
library(cowplot)

p1 <- ggplot(polyps, aes(x = treat, y = number, fill = treat)) + theme_minimal() + 
  geom_dotplot(binaxis = "y", stackdir = "center", show.legend = FALSE, binwidth = 1) + 
  labs(x = "Treatment", y = "Number of Polyps") + ylim(0, 63)

p2 <- ggplot(polyps, aes(x = age, y = number, color = treat)) + theme_minimal() + 
  geom_point() + labs(x = "Age (years)", y = NULL, color = "Treatment") + 
  theme(legend.position = c(0.8, 0.8)) + ylim(0, 63)

plot_grid(p1, p2, rel_widths = c(1, 3))
```
Twenty subjects with FAP were randomly assigned to either a treatment (drug) or control (placebo) group. After twelve months the polyps in each subject were counted. The focus here is on the statistical relationship between the number of polyps and the treatment condition. But subject age can be used as a covariate since the number of polyps may depend on age.[^ancova] Here you will use Poisson regression to make inferences about the treatment effect as well as the effect of age on the number of polyps for people with FAP.

[^ancova]: This model can be thought of a Poisson regression version of an [analysis of covariance](https://en.wikipedia.org/wiki/Analysis_of_covariance) which uses a covariate to "control" for some variation in the response variable to improve inferences for the treatment variable in a randomized experiment.

1. Estimate a Poisson regression model with the number of polyps as the response variable and only treatment as the explanatory variable (do not include age yet). Report the parameter estimates and their standard errors using `summary` so that I can verify that you estimated the model correctly. Estimate the rate ratio for the effect of the treatment, and write a sentence or two to interpret this rate ratio in terms of the effect of the treatment on the number of polyps. Finally estimate the expected number of polyps for each treatment group. 

    **Solution**: We can estimate this model as follows.
    ```{r}
    m <- glm(number ~ treat, family = poisson, data = polyps)
    summary(m)$coefficients
    ```
    We can estimate the rate ratio as follows.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = "drug"), b = list(treat = "placebo"))
    ```
    Note that for this model we can also estimate it by just exponentiating the parameters.
    ```{r}
    exp(cbind(coef(m), confint(m)))
    ```
    We can interpret this rate ratio as showing us that *the expected number of polyps for patients given the drug is about 0.28 times that of patients given the placebo (i.e., about 72% lower).* We can also "flip" the rate ratio as follows.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = "placebo"), b = list(treat = "drug"))
    ```
    This rate ratio can be interpreted by saying that *the expected number of polyps for patients given the placebo is about 3.6 times higher than patients given the drug (i.e., about 260% higher).* Here is how to estimate these two rate ratios using the **emmeans** package.
    ```{r}
    pairs(emmeans(m, ~treat, type = "response"), infer = TRUE)
    pairs(emmeans(m, ~treat, type = "response"), infer = TRUE, reverse = TRUE)
    ```
    Finally here is how we can estimate the expected number of polyps for each treatment condition.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = c("drug","placebo")), cnames = c("drug","placebo"))
    emmeans(m, ~treat, type = "response")
    ```
    
0. Estimate a Poisson regression model with the number of polyps as the response variable and both treatment and age as the explanatory variables. Do not include an interaction between treatment and age.[^fapinteract] Estimate two rate ratios --- one for the effect of the treatment and one for the effect of age.[^faprateratio] Write a sentence or two that interprets each rate ratio in terms of the relationship between the explanatory variable and the number of polyps. Also estimate the expected number of polyps for a 30-year old person who receives the treatment, and for someone of the same age that does not receive the treatment.

    **Solution**: We can estimate the model as follows.
    ```{r}
    m <- glm(number ~ treat + age, family = poisson, data = polyps)
    summary(m)$coefficients
    ```
    We can estimate the rate ratio for the treatment variable as follows.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = "drug", age = c(20,30,40)),
      b = list(treat = "placebo", age = c(20,30,40)),
      cnames = c("@20","@30","@40"))
    ```
    Note that the age does not matter since there is no interaction between it and treatment, but I included several values to show this. This shows that *the expected number of polyps for a subject given the drug is about 0.26 times that of one of the same age but given the placebo (i.e., about 0.74% lower).* Here is the "flipped" rate ratio.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = "placebo", age = c(20,30,40)),
      b = list(treat = "drug", age = c(20,30,40)),
      cnames = c("@20","@30","@40"))
    ```
    So *the expected number of polyps for a patient given the placebo is about 3.9 times higher than one of the same age but given the drug (i.e., about 290% higher).* We can estimate the rate ratio for the effect of as as follows.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = c("drug","placebo"), age = 30),
      b = list(treat = c("drug","placebo"), age = 29),
      cnames = c("drug","placebo"))
    ```
    Because there is no interaction involving the treatment, the value of the treatment variable does not affect the rate ratio. This rate ratio can be interpreted as showing that *for every year of age the expected number of polyps decreases by a factor of about 0.96 (i.e., about 4%).* The above rate ratios can be estimated using the **emmeans** package as follows.
    ```{r}
    pairs(emmeans(m, ~treat|age, at = list(age = c(20,30,40)), 
      type = "response"), infer = TRUE)
    pairs(emmeans(m, ~treat, type = "response"), infer = TRUE)
    pairs(emmeans(m, ~treat|age, at = list(age = c(20,30,40)), 
      type = "response"), infer = TRUE, reverse = TRUE)
    pairs(emmeans(m, ~treat, type = "response"), infer = TRUE, reverse = TRUE)
    pairs(emmeans(m, ~age|treat, at = list(age = c(30,29)), type = "response"), infer = TRUE)
    pairs(emmeans(m, ~age, at = list(age = c(30,29)), type = "response"), infer = TRUE)
    ```
    Finally here are some ways to estimate the expected number of polyps for a 30-year old patient in each treatment condition.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(treat = c("drug","placebo"), age = 30),
      cnames = c("drug","placebo"))
    emmeans(m, ~treat|age, at = list(age = 30), type = "response")
    ```
  
0. Using the model with both treatment and age as explanatory variables, plot two curves showing the estimated expected number of polyps as a function of treatment and age. Your plot should also include the raw data like the plot on the right-hand side above. You can use the code above that creates the object called `p2` as the basis of your plot.

    **Solution**: Here is the plot for the estimated model.
    ```{r}
    d <- expand.grid(treat = c("drug","placebo"), age = seq(13, 50, length = 100))
    d$yhat <- predict(m, newdata = d, type = "response")
    
    p <- ggplot(polyps, aes(x = age, y = number, color = treat)) + theme_minimal() + 
      geom_point() + labs(x = "Age (years)", y = NULL, color = "Treatment") + 
      theme(legend.position = c(0.8, 0.8)) + 
      geom_line(aes(y = yhat), data = d)
    plot(p)
    ```

0. The model you estimated with both treatment and age as explanatory variables can be written as the nonlinear model
$$
  E(Y_i) = \exp(\beta_0 + \beta_1x_{i1} + \beta_2x_{i2}),
$$
where $Y_i$ is the number of polyps, and $x_{i1}$ and $x_{i2}$ represent treatment and age (although which represents treatment and which represents age will depend on the order that you specified the explanatory variables in the model formula argument of `glm`). Estimate the model above using the `nls` function and show the parameter estimates and standard errors using the `summary` function. These should be similar but not equal to what you got using `glm` (note that you can use the estimates from `glm` as your starting values). The Poisson distribution assumes a variance structure such that $\text{Var}(Y_i) = E(Y_i)$, which suggests that if dealt with the heteroscedasticity using weights then we would use weights of $w_i = 1/E(Y_i)$ which can be approximated as $w_i = 1/\hat{y}_i$, where $\hat{y}_i$ is the predicted value. Now estimate the model above again using `nls`, but use iteratively weighted least squares with the weights defined as above. Report the parameter estimates and their standard errors using `summary`. If you do this correctly the estimates should be the same as what you got from `glm`, but the standard errors will not necessarily be the same.[^iwls] **Note**: This problem is *extra credit* for students in Stat 436, but is *required* for students in Stat 516.

    **Solution**: First I will estimate the model without using weights.
    ```{r}
    m <- nls(number ~ exp(b0 + b1 * (treat == "drug") + b2 * age), 
      data = polyps, start = list(b0 = 4.5, b1 = -1.36, b2 = -0.04))
    summary(m)$coefficients
    ```
    Now I will estimate it using iteratively weighted least squares.
    ```{r}
    polyps$w <- 1
    for (i in 1:10) {
      m <- nls(number ~ exp(b0 + b1 * (treat == "drug") + b2 * age), data = polyps, 
        start = list(b0 = 4.5, b1 = -1.36, b2 = -0.04), weights = w)
      polyps$w <- 1 / predict(m)
    }
    summary(m)$coefficients
    ```
    Notice that the estimates are the same as when using `glm` to estimate a Poisson regression model, but the standard errors are different.
    ```{r}
    m <- glm(number ~ treat + age, family = poisson, data = polyps)
    summary(m)$coefficients
    ```
    However, using iteratively weighted least squares here is equivalent to using a quasi-likelihood approach with `family = quasipoisson`.
    ```{r}
    m <- glm(number ~ treat + age, family = quasipoisson, data = polyps)
    summary(m)$coefficients
    ```
    Note that both the estimates and the standard errors are the same as what was obtained when using iteratively weighted least squares.

[^iwls]: The reason that the standard errors are not the same is that Poisson regression assumes the variance structure $\text{Var}(Y_i) = E(Y_i)$ whereas using the weights as above assumes that $\text{Var}(Y_i) = \phi E(Y_i)$ for some unknown value of $\phi$. That is, iteratively weighted least squares assumes that $\text{Var}(Y_i)$ is *proportional to* (rather than *equal to*) $E(Y_i)$, which we can write as $\text{Var}(Y_i) \propto E(Y_i)$. Interestingly it turns out that using iteratively weighted least squares with `nls` is effectively equivalent to using quasi-likelihood.

[^giardiello]: Giardiello, F. M., Hamilton, S. R., Krush, A. J., Piantadosi, S., Hylind, L. M., Celano, P., Booker, S. V., Robinson, C. R., & Offerhaus, G. J. (1993). Treatment of colonic and rectal adenomas with sulindac in familial adenomatous polyposis. *New England Journal of Medicine*, *328(18)*, 1313--1316.

[^fapinteract]: The interaction is negligible so we will ignore it. 

[^faprateratio]: Note that since there is no interaction modeled between treatment and age the estimated rate ratio for one variable will not depend on the value of the other, so what value you use is arbitrary if you specify it using `contrast` or `emmeans`.

## Analgesic Potency

The data frame `analgesics` in the **trtools** package is from a study comparing four analgesics at varying doses.[^grewel] Here are the data in aggregated form.
```{r}
library(trtools)
analgesics
```
Mice were randomly assigned one of four analgesics (morphine hydrochloride, amidone, phenadoxone, or pethidine hydrochloride) at one of nine doses. Each mouse was administered a number of electric shocks until a pain response (a squeak) was elicited. This was done before the administration of the analgesic (as a baseline) and after. A mouse was recorded as "responding" to an analgesic if at least four more shocks were required to elicit a pain response than before the analgesic was administered. The plot below shows the proportion of mice responding to the analgesic.
```{r}
library(ggplot2)
p <- ggplot(analgesics, aes(x = dose, y = responding/tested, color = analgesic)) + 
  theme_minimal() + geom_point() + theme(legend.position = c(0.85,0.25)) + ylim(0, 1) +
  labs(x = "Dose (mg/kg)", y = "Proportion Responding", color = "Analgesic") 
plot(p)
```
The goal here is to model how the mice respond to the different analgesics using logistic regression. 

1. Estimate a logistic regression model for the proportion of mice responding to the analgesics, using both the type of analgesic and the dose as explanatory variables. This model will include an interaction so that the odds ratio for dose depends on the type of analgesic used, but will also include a constraint that the probability of a response is the same at a dose of zero (since then the type of analgesic is irrelevant). To do this, specify the right-hand side of the model formula argument of the `glm` function as simply `analgesic:dose`. To verify that you estimated the model correctly, show the parameter estimates and their standard errors using `summary`. 

    **Solution**: We can estiamte this model as follows.
    ```{r}
    m <- glm(cbind(responding, tested - responding) ~ analgesic:dose, 
      family = binomial, data = analgesics)
    summary(m)$coefficients
    ```

0. Using the model you estimated above, plot the estimated expected proportion of responses (which is also the estimated probability of a response) as a function of type of analgesic used and the dose. This plot should also include the observed proportions as shown above. 

    **Solution**: Here is a plot of the estimated model with the raw data.
    ```{r}
    d <- expand.grid(analgesic = unique(analgesics$analgesic), dose = seq(0, 20, length = 100))
    d$yhat <- predict(m, newdata = d, type = "response")
    
    p <- ggplot(analgesics, aes(x = dose, y = responding/tested, color = analgesic)) + 
      theme_minimal() + geom_point() + theme(legend.position = c(0.85,0.25)) + ylim(0, 1) +
      labs(x = "Dose (mg/kg)", y = "Proportion Responding", color = "Analgesic") + 
      geom_line(aes(y = yhat), data = d)
    plot(p)
    ```

0. Estimate the probability of a response for each analgesic at a dose of 0 mg/kg, and again at a dose of 5 mg/kg. Note that you should find that the estimates at 0 mg/kg are the same for the four analgesics.

    **Solution**: These probabilities can be estimated as follows.
    ```{r}
    drug <- sort(unique(analgesics$analgesic))
    trtools::contrast(m, tf = plogis, 
      a = list(analgesic = drug, dose = 0),
      cnames = paste(drug, "at 0 mg/kg"))
    trtools::contrast(m, tf = plogis, 
      a = list(analgesic = drug, dose = 5),
      cnames = paste(drug, "at 5 mg/kg"))
    ```
    Note that creating `drug` here lets me avoid having to type out all of the analgesics each time. Here is another way to do this.
    ```{r}
    emmeans(m, ~analgesic|dose, at = list(dose = c(0,5)), type = "response")
    ```
    
0. Estimate the odds ratio for the effect of increasing dose by one unit for *each* of the four analgesics. For each odds ratio, write a sentence or two that interprets the odds ratio in terms of the relationship between dose and the response.

    **Solution**: Here are a couple of ways to estimate these odds ratios.
    ```{r}
    drug <- sort(unique(analgesics$analgesic))
    trtools::contrast(m, tf = exp,
      a = list(analgesic = drug, dose = 1),
      b = list(analgesic = drug, dose = 0),
      cnames = drug)
    pairs(emmeans(m, ~dose|analgesic, at = list(dose = c(1,0)), type = "response"), infer = TRUE)
    ```
    We can interpret these four odds ratios as follows.
    
    *For every unit increase in dose, the odds of a response increases by a factor of about 1.71 (71%) when using amidone, 1.52 (52%) when using morphine hydrochloride, 1.16 (16%) when using pethidine hydrochloride, and 4.1 (310%) when using phenadoxone.*

0. It can be seen from the output of `summary` for the model you estimated above that it can be written as
$$
O_i = 
\begin{cases}
  e^{\beta_0}e^{\beta_1d_i}, & \text{if the analgesic is amidone}, \\
  e^{\beta_0}e^{\beta_2d_i}, & \text{if the analgesic is morphine hydrochloride}, \\
  e^{\beta_0}e^{\beta_3d_i}, & \text{if the analgesic is pethidine}, \\
  e^{\beta_0}e^{\beta_4d_i}, & \text{if the analgesic is phenadoxone hydrochloride},
\end{cases}
$$
where $O_i$ is the odds of responding and $d_i$ is the dose of the analgesic. The odds ratios for the effect of a one unit increase in dose for amidone, morphine hydrochloride, pethidine, and phenadoxone hydrochloride can be shown to be equal to $e^{\beta_1}$, $e^{\beta_2}$, $e^{\beta_3}$, and $e^{\beta_4}$, respectively. You estimated these odds ratios in the previous problem. Now consider the problem of testing if the odds ratio for, say, morphine hydrochloride is different from that for each of the other three analgesics. This would amount to testing each of the null hypotheses $\beta_1 - \beta_2 = 0$, $\beta_3 - \beta_2 = 0$, and $\beta_4 - \beta_2 = 0$. This can be done several ways. One is to use the `lincon` function from the **trtools** package. But it can also be done using `contrast` from the same package, or by using functions from the **emmeans** package. Test each of the three null hypotheses using a significance level of $\alpha$ = 0.05. Be sure to state your conclusion. **Note**: This problem is *extra credit* for students in Stat 436, but is *required* for students in Stat 516.

    **Solution**: Here is how we can do it using `lincon`.
    ```{r}
    lincon(m, a = c(0, 1, -1, 0, 0)) # b1 - b2 = 0
    lincon(m, a = c(0, 0, -1, 1, 0)) # b3 - b2 = 0
    lincon(m, a = c(0, 0, -1, 0, 1)) # b4 - b2 = 0
    ```
    Note that all three null hypotheses are rejected at a significance level of 0.05. Using `contrast` is a bit trickier. Here I will just show how to do it to test $\beta_1 - \beta_2 = 0$ (i.e., comparing amidone and morphine).
    ```{r}
    trtools::contrast(m, 
      a = list(analgesic = "amidone", dose = 1),
      b = list(analgesic = "amidone", dose = 0),
      u = list(analgesic = "morphine", dose = 1),
      v = list(analgesic = "morphine", dose = 0))
    ```
    Using the **emmeans** package we can compare all pairs of analgesics.
    ```{r}
    pairs(pairs(emmeans(m, ~dose|analgesic, at = list(dose = c(1,0)))),
      by = NULL, adjust = "none")
    ```
    It is possible to target certain comparisons. 
    ```{r}
    emmeans::contrast(pairs(emmeans(m, ~dose|analgesic, at = list(dose = c(1,0)))), 
      method = "trt.vs.ctrl", by = NULL, ref = 2, adjust = "none")
    ```
    Here is another approach using the `emtrends` function. First I will show all possible pairwise comparisons and then only those comparing against morphine.
    ```{r}
    pairs(emtrends(m, ~analgesic, var = "dose"), adjust = "none")
    emmeans::contrast(emtrends(m, ~analgesic, var = "dose"), method = "trt.vs.ctrl", 
      ref = 2, adjust = "none")
    ```
    Here is another approach. Consider that if, for example, $\beta_1 - \beta_2 = 0$ then the expected response is the same for amidone and morphine hydrochloride *for any dose*. So we can actually test the null hypothesis by testing the difference in the expected response between two analgesics for any given dose (other than zero where they are the same for this model). 
    ```{r}
    trtools::contrast(m,
      a = list(analgesic = c("amidone","pethidine","phenadoxone"), dose = 5),
      b = list(analgesic = "morphine", dose = 5), 
      cnames = c("amidone versus morphine", "pethdine versus morphine", 
        "phenadoxone versus morphine"))
    emmeans::contrast(emmeans(m, ~analgesic|dose, at = list(dose = 5)), 
      method = "trt.vs.ctrl", ref = 2, adjust = "none")
    ```
    Note that since we are just testing the differences between odds ratios there is no need to use `tf = exp` in `lincon` or `contrast`, or to use `type = "response"` with the **emmeans** package.
    
    Here is another approach using a reparameterization of the model.
    ```{r}
    analgesics$analgesic <- relevel(factor(analgesics$analgesic), ref = "morphine")
    m <- glm(cbind(responding, tested - responding) ~ dose + dose:analgesic, 
      family = binomial, data = analgesics)
    summary(m)$coefficients
    ```
    This model can be written as
    $$
O_i = 
\begin{cases}
  e^{\beta_0}e^{(\beta_1 + \beta_2)d_i}, & \text{if the analgesic is amidone}, \\
  e^{\beta_0}e^{\beta_1 d_i}, & \text{if the analgesic is morphine hydrochloride}, \\
  e^{\beta_0}e^{(\beta_1 + \beta_3)d_i}, & \text{if the analgesic is pethidine}, \\
  e^{\beta_0}e^{(\beta_1 + \beta_4)d_i}, & \text{if the analgesic is phenadoxone hydrochloride},
\end{cases}
$$
so the hypotheses are now written as $\beta_2 = 0$, $\beta_3 = 0$, and $\beta_4 = 0$. These can be tested just using the output from `summary`. 

    Here is one more approach, but this time using a likelihood ratio test. Here I will demonstrate it for testing the null hypothesis $\beta_1 - \beta_2 = 0$. To do this we need to specify a null model that is implied by the null hypothesis. In that model there is no distinction between amidone or morphine hydrochloride. To do this we can create a new variable by combining two levels. 
    ```{r}
    library(forcats)
    analgesics <- analgesics %>%
        mutate(adrug = fct_collapse(analgesic, 
          amidone_or_morphine = c("amidone","morphine"),
        ))
    analgesics
    m <- glm(cbind(responding, tested - responding) ~ analgesic:dose,
      family = binomial, data = analgesics)
    m.null <- glm(cbind(responding, tested - responding) ~ adrug:dose,
      family = binomial, data = analgesics)
    anova(m.null, m, test = "LRT")
    ```

[^grewel]: Grewal, R. S. (1952). A method for testing analgesics in mice. *British Journal of Pharmacology and Chemotherapy*, *7*, 433--437.

## Race and the Death Penalty

The data frame `deathpenalty` in the package **catdata** tabulates judgments of the death penalty in cases of murder in Florida between 1976 and 1987.[^radelet] The race of the defendant and victim were also recorded. The data are in a form that is not very convenient for modeling.
```{r}
library(catdata)
data(deathpenalty)
deathpenalty
```
Here values of 0 and 1 correspond to *no* and *yes*, respectively, for the variable `DeathPenalty`, and *black* and *white*, respectively, for the variables `VictimRace` and `DefendentRace`. It is useful to make these variables factors with clearly labeled values. To avoid confusion I will create a new data frame called `dpenalty`. 
```{r}
library(dplyr)
dpenalty <- deathpenalty %>%
  mutate(DeathPenalty = factor(DeathPenalty, levels = c(0,1), labels = c("no","yes"))) %>%
  mutate(VictimRace = factor(VictimRace, levels = c(0,1), labels = c("black","white"))) %>%
  mutate(DefendantRace = factor(DefendantRace, levels = c(0,1), labels = c("black", "white")))
dpenalty
```
Consider using logistic regression to model these data with `DeathPenalty` as the response variable. It is possible to model the data in this form, and I will show you how that can be done in the solutions. But I will put the data in a form that is more familiar to you when using logistic regression. 
```{r}
library(tidyr)
dpenalty <- dpenalty %>%
  pivot_wider(names_from = DeathPenalty, values_from = Freq)
dpenalty
```
Here the data are in the familiar aggregated form where for each combination of `VictimRace` and `DefendentRace` we have the number of cases where the death penalty was and was not decided. These data can be used to demonstrate what is sometimes called [Simpson's Paradox](https://en.wikipedia.org/wiki/Simpson%27s_paradox) which occurs when the association between two variables reverses when we collapse across a third variable. Here you will use logistic regression with the data frame `dpenalty` to explore this phenomenon. 

1. First consider using only paying attention to the defendant's race. We can compute the proportion of cases where the death penalty was imposed as follows.
    ```{r}
    dpenalty %>% group_by(DefendantRace) %>% 
      summarize(no = sum(no), yes = sum(yes)) %>%
      mutate(proportion = yes / (no + yes))
    ```
From this we can see that a slightly larger proportion of white defendants were given the death penalty in comparison to black defendants. Estimate a logistic regression model with the proportion of judgments resulting in the death penalty as your response variable, but using *only the defendant's race* as an explanatory variable. Report the parameter estimates and their standard errors using `summary` so I can verify that you estimated this model correctly. Estimate (a) the probability of a death penalty decision for each race of the defendant, and (b) the odds ratio that summarizes the relationship between the defendant's race and the death penalty decision. Summarize the odds ratio in a sentence or two that describes the relationship between the race of the defendant and the death penalty decision. 

    **Solution**: This model can be estimated as follows.
    ```{r}
    m <- glm(cbind(yes, no) ~ DefendantRace, family = binomial, data = dpenalty)
    summary(m)$coefficients
    ```
    The probability of the death penalty conditional on the defendant's race can be estimated several ways.
    ```{r}
    trtools::contrast(m, tf = plogis,
      a = list(DefendantRace = c("black","white"))) 
    emmeans(m, ~DefendantRace, type = "response")
    ```
    Note that for this particular model these estimates are equivalent to the sample proportions. Here is the estimated odds ratio.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(DefendantRace = "black"),
      b = list(DefendantRace = "white"))
    pairs(emmeans(m, ~DefendantRace, type = "response"), infer = TRUE)
    ```
    Thus we estimate that *the odds of the death penalty being given to a black defendant is 0.69 times that of a white defendant (i.e., 31% lower).* Alternatively we can "flip" the odds ratio as follows.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(DefendantRace = "white"),
      b = list(DefendantRace = "black"))
    pairs(emmeans(m, ~DefendantRace, type = "response"), infer = TRUE, reverse = TRUE)
    ```
    This says that we estimate that *the odds of the death penalty being given to a white defendant is 1.45 times larger (i.e., 45% higher) than for a black defendant.* Note that we can also get this odds ratio by just exponentiating the parameters.
    ```{r}
    exp(cbind(coef(m), confint(m)))
    ```

0. Now consider all conditioning on the race of the *victim*. We can compute the proportion of cases where the death penalty was imposed as follows.
    ```{r}
    dpenalty %>% mutate(proportion = yes / (no + yes)) %>% arrange(VictimRace)
    ```
Note that now a larger proportion of black defendants were given the death penalty when the victim is black, but also when the victim is white. This apparent reversal is due to two things. First, the death penalty is given more often when the *victim* is white, and secondly there is an association between the race of the defendant and that of the victim which can be seen in the original data. In a majority of the cases the race of the victim and the defendant are the same as can be seen below.
    ```{r}
    dpenalty %>% mutate(total = no + yes)
    ```
    To account for the race of the victim as well as the defendant, estimate a logistic like that you estimated in the previous problem, but now using *both* the race of the defendant *and* the race of the victim as explanatory variables, but do not include an interaction.[^interaction] Report the parameter estimates and their standard errors using `summary` so that I can verify that you estimated this model correctly. Estimate (a) the probability of a death penalty decision for each combination of levels of victim's race and defendant's race, (b) the odds ratio that summarizes the relationship between the defendant's race and the death penalty decision, and (c) the odds ratio that summarizes the relationship between the victim's race and the death penalty decision. Summarize each odds ratio in a sentence or two that describes the relationship between the explanatory variable and the death penalty decision.
    
    **Solution**: Here is how to estimate this model.
    ```{r}
    m <- glm(cbind(yes, no) ~ DefendantRace + VictimRace, family = binomial, data = dpenalty)
    summary(m)$coefficients
    ```
    We can estimate the probabilities as follows.
    ```{r}
    trtools::contrast(m, tf = plogis,
      a = list(DefendantRace = c("black","white","black","white"),
        VictimRace = c("black","black","white","white")),
      cnames = c("black D, black V", "white D, black V", "black D, white V", "white D, white V"))
    emmeans(m, ~DefendantRace*VictimRace, type = "response")
    ```
    Here are the odds ratios for the effect of defendant's race, when controlling for the victim's race.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(DefendantRace = "black", VictimRace = c("black","white")),
      b = list(DefendantRace = "white", VictimRace = c("black","white")),
      cnames = c("black victim", "white victim"))
    pairs(emmeans(m, ~DefendantRace|VictimRace, type = "response"))
    trtools::contrast(m, tf = exp,
      a = list(DefendantRace = "white", VictimRace = c("black","white")),
      b = list(DefendantRace = "black", VictimRace = c("black","white")),
      cnames = c("black victim", "white victim"))
    pairs(emmeans(m, ~DefendantRace|VictimRace, type = "response"), reverse = TRUE)
    ```
    Thus *the odds of the death penalty for a black defendant is about 2.38 times higher (i.e., 138% larger) than for a white defendant when controlling for the race of the victim* Alternatively, we might say that *the odds of the death penalty for a white defendant is about 0.42 times that of a black defendant (i.e., 58% smaller) when controlling for the race of the victim.* 
    
    Here are the odds ratios for the effect of the victim's race, when controlling for the defendant's race.
    ```{r}
    trtools::contrast(m, tf = exp,
      a = list(VictimRace = "black", DefendantRace = c("black","white")),
      b = list(VictimRace = "white", DefendantRace = c("black","white")),
      cnames = c("black victim", "white victim"))
    pairs(emmeans(m, ~VictimRace|DefendantRace, type = "response"))
    trtools::contrast(m, tf = exp,
      a = list(VictimRace = "white", DefendantRace = c("black","white")),
      b = list(VictimRace = "black", DefendantRace = c("black","white")),
      cnames = c("black victim", "white victim"))
    pairs(emmeans(m, ~VictimRace|DefendantRace, type = "response"), reverse = TRUE)
    ```
    These odds ratios show that *the odds of the death penalty when the victim is black is about 0.09 times that when the victim is white (i.e., about 91% smaller) when controlling for the race of the defendant*. Or we could say that *the odds of the death penalty when the victim is white is about 11.1 times that when the victim is black (i.e., 1010% larger) when controlling for the race of the defendant.*
    
    Note that the expression "controlling for" means that we are estimating the odds ratio for one variable when the other variable does not change. We can do this in the second model, because the other variable is also an explanatory variable which we can hold constant when defining an odds ratio. But this was not the case in the first model where we could hold constant the race of the victim. 
    
    Here I will show you how to specify the model with the data in their original form with one frequency per row. Here is how those data looked.
    ```{r}
    dpenalty <- dpenalty %>% pivot_longer(c(no,yes), 
      names_to = "DeathPenalty", values_to = "Freq")
    dpenalty
    ```
    To handle the data in this form we can use weights to indicate the frequency of each observation. Note that the output of `summary` is the same as before.
    ```{r}
    m <- glm(DeathPenalty == "yes" ~ DefendantRace + VictimRace,
      family = binomial, weights = Freq, data = dpenalty)
    summary(m)$coefficients
    ```
    
[^radelet]: Radelet, M. & Pierce, G. L. (1991). Choosing those who will die: Race and the death penalty in Florida, *Florida Law Review*, *43(1)*, 1--34.

[^interaction]: The interaction is negligible so for simplicity we will ignore it. 