---
output:
  html_document:
    theme: readable
  pdf_document: default
---

```{r, echo = FALSE, message = FALSE}
library(lubridate)
date <- "04-15-2022"
weekday <- wday(mdy(date), label = TRUE, abbr = FALSE)
month <- month(mdy(date), label = TRUE)
day <- day(mdy(date))
```

---
title: `r paste(weekday, ", ", month, " ", day, sep = "")`
header-includes:
  - \usepackage{array}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", message = FALSE, out.width = "100%", fig.align = "center", fig.width = 9, cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "pdf"))
```

```{r packages, echo = FALSE}
library(tidyverse)
library(kableExtra)
library(trtools)
```

```{r utilities, echo = FALSE}
source("../../utilities.R")
```

```{r options, echo = FALSE}
options(digits = 4, width = 90)
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](lecture-", date, ".pdf) copy of this lecture.", sep = ""), "")`

<!-- To do: Use lincon to extract parameter estimates, standard errors, etc. Also can use tf argument to exponentiate. -->

## Sequential (Continuation Ratio) Models

In a discrete survival time model we model the hazard function
$$
h(t) = P(T = t|T \ge t)
$$ 
(i.e., the probability of a unit not "surviving" to time $t+1$ *given* that it survived to time $t$). This is closely related to a family of models for *ordered categorical response variables* that are conceptualized as a series of "stages" or "phases" of some sort. But here instead we usually model 
$$
P(T > t|T \ge t)
$$
(i.e., the probability that a unit will transition to stage $t+1$ *given* that it made it to stage $t$). In terms of the hazard function 
$$
P(T > t|T \ge t) = 1 - P(T = t|T \ge t) = 1 - h(t). 
$$
**Warning**: The **VGAM** package includes a function called `margeff` which computes instantaneous marginal effects for model objects created using the `vglm` function. To avoid conflicts, use `trtools::margeff` when using the `margeff` function from the **trtools** package if the **VGAM** package is loaded.

**Example**: The data frame `pneumo` from the package **VGAM** contains aggregated data of pneumoconiosis in coal miners. 
```{r, message = FALSE, warning = FALSE}
library(VGAM)
print(pneumo)
```
This kind of model can also be estimated using the `vglm` function from the **VGAM** package. With the original aggregated data we would specify the model as follows. Note that the order of the arguments to `cbind` is important. We want to order them from lowest/first to highest/last.
```{r}
m <- vglm(cbind(normal,mild,severe) ~ exposure.time, 
    family = cratio(link = "logitlink"), data = pneumo)
summary(m)
exp(cbind(coef(m), confint(m)))
```
If the data are not aggregated (i.e., one observational unit per row) then the syntax is different. Here I disaggregate the data for demonstration. 
```{r}
library(tidyr)
pneumosingle <- pneumo %>% pivot_longer(c(normal,mild,severe), 
  names_to = "condition", values_to = "frequency") %>% uncount(frequency)
head(pneumosingle)
tail(pneumosingle)
```
An important step here is that we need to *order* the levels of `condition` appropriately since we cannot order it in `cbind` now. 
```{r}
pneumosingle$conditionf <- factor(pneumosingle$condition,
    levels = c("normal","mild","severe"), ordered = TRUE)
levels(pneumosingle$conditionf) # correct order
```
We actually don't *need* the `ordered = TRUE` here, as the `levels` argument will imply the order, but it avoids `vglm` throwing a warning.

Now we can specify the model as follows.
```{r}
m <- vglm(conditionf ~ exposure.time, 
  family = cratio(link = "logitlink"), data = pneumosingle)
summary(m)
exp(cbind(coef(m), confint(m)))
```
Now suppose we want to plot the model. First we can compute the probability of each condition as a function of exposure.
```{r}
d <- data.frame(exposure.time = seq(5, 55, length = 100))
d <- cbind(d, predict(m, newdata = d, type = "response"))
head(d)
```
We can use the `pivot_longer` function from the **tidyr** package to reshape the data for plotting.
```{r}
library(tidyr)
d <- d %>% pivot_longer(c(normal,mild,severe), 
  names_to = "condition", values_to = "probability")
head(d)
tail(d)
p <- ggplot(d, aes(x = exposure.time, y = probability, color = condition)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Exposure (Years)", y = "Probability", color = "Condition") +
  theme(legend.position = c(0.8,0.8))
plot(p)
```
Alternatively we can plot the probability of passing from one condition to the next --- i.e., $P(Y>y|Y \ge y)$. But we need to compute those probabilities using the following fact.
$$
    P(Y > y|Y \ge y) = \frac{P(Y > y \text{ and } Y \ge y)}{P(Y \ge y)} = 
    \frac{P(Y > y)}{P(Y \ge y)}.
$$
Note that this uses the definition of a conditional probability and the fact that if $Y > y$ and $Y \ge y$ then $Y > y$. So
$$
    P(Y > 1|Y \ge 1) = \frac{P(Y > 1)}{P(Y \ge 1)} = 
    \frac{P(Y=2) + P(Y=3)}{P(Y=1) + P(Y=2) + P(Y=3)},
$$
and
$$
    P(Y > 2|Y \ge 2) = \frac{P(Y > 2)}{P(Y \ge 2)} = 
    \frac{P(Y=3)}{P(Y=2) + P(Y=3)}.
$$
So we can compute the probability by adding together category probabilities.
```{r}
d <- data.frame(exposure.time = seq(5, 55, length = 100))
d <- cbind(d, predict(m, newdata = d, type = "response"))
# probability of going from normal to mild -- i.e., P(Y > normal|Y >= normal)
d$nm <- with(d, (mild + severe) / (normal + mild + severe))
# probability of going from mild to severe -- i.e., P(Y > mild|Y >= mild)
d$ms <- with(d, severe / (mild + severe))
head(d)
```
Remove original category probabilities just for clarity, reshape the data, and plot.
```{r}
d$normal <- NULL
d$mild <- NULL
d$severe <- NULL
d <- d %>% pivot_longer(c(nm,ms), names_to = "transition", values_to = "probability")
head(d)
tail(d)
p <- ggplot(d, aes(x = exposure.time, y = probability, color = transition)) + 
  geom_line() + theme_minimal() + 
  labs(x = "Exposure (Years)", y = "Probability", color = "Transition") +
  theme(legend.position = c(0.2,0.8))
plot(p)
```
**Example**: Consider again the `firstsex` data.
```{r}
firstsex <- read.table("https://stats.idre.ucla.edu/stat/examples/alda/firstsex.csv", 
  sep = ",", header = TRUE)
firstsex$parent_trans <- factor(firstsex$pt, 
  levels = c(0,1), labels = c("no","yes"))
```
The discrete survival model can be estimated using `vglm` *if* the right-censoring is always at the highest observed time, which it is here (grade 12). We need to create a new "grade" for those cases where sex had not occurred for the first time in grade 12 (this represents first sex after HS, if at all). 
```{r}
firstsex$time <- ifelse(firstsex$censor == 1, 13, firstsex$time)
```
Probabilities of the form $P(Y = y|Y \ge y)$ can be modeled using `vglm` if we use the `sratio` family. Here we do not need to worry about the ordering of the response variable because it is implied by the ordering of the grade numbers.  
```{r}
m <- vglm(time ~ parent_trans, data = firstsex,
  family = sratio(link = "logitlink", parallel = TRUE))
summary(m)
```
Note that specifying `parallel = TRUE` means that the effect of `pt` is the same at each grade (i.e., no interaction between grade and `pt`). Note that the odds ratio for parenting transition (`pt`) is the same as what we obtained in the previous lecture.
```{r}
exp(cbind(coef(m), confint(m)))
```
The other parameters are not the same because this model is parameterized differently, using indicator variables for all grades (called `(Intercept)` here for reasons we will see in the next lecture) and then dropping the overall intercept term. 
```{r}
firstsex <- read.table("https://stats.idre.ucla.edu/stat/examples/alda/firstsex.csv", 
  sep = ",", header = TRUE)
firstsex$parent_trans <- factor(firstsex$pt, 
  levels = c(0,1), labels = c("no","yes"))
firstsex$status <- ifelse(firstsex$censor == 1, 0, 1)
firstsex <- trtools::dsurvbin(firstsex, "time", "status")
m <- glm(y ~ -1 + t + parent_trans, 
  family = binomial, data = firstsex)
summary(m)$coefficients
exp(cbind(coef(m), confint(m)))
```

**Example**: We can estimate the discrete survival model for the `cycles` data as follows. Note that we do not need to do anything for the censoring here because all observations censored at 12 are recorded at 13 (much like we did with the `firstsex` data). 
```{r}
library(trtools)
m <- vglm(cycles ~ mother, data = cycles, 
   family = sratio(link = "logitlink", parallel = TRUE ~ 1 + mother))
summary(m)
exp(cbind(coef(m), confint(m)))
```
Same results as in the last lecture except confidence interval is slightly different (the confidence interval here is a Wald confidence interval as opposed to a profile likelihood interval). Note that the argument `parallel = TRUE ~ 1 + mother` forces the parameters to be the same across categories (i.e., cycles).