<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Wednesday, Apr 27</title>

<script src="site_libs/header-attrs-2.13/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Statistics 436/516</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="lectures.html">Lectures</a>
</li>
<li>
  <a href="resources.html">Resources</a>
</li>
<li>
  <a href="syllabus.html">Syllabus</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Wednesday, Apr 27</h1>

</div>


<p>You can also download a <a href="lecture-04-27-2022.pdf">PDF</a> copy
of this lecture.</p>
<div id="random-effects-approach" class="section level2">
<h2>Random Effects Approach</h2>
<p>The random effects approach conceptualizes the parameters associated
with the levels of the many-leveled factor as <em>random variables</em>.
Another way to think of this is that the levels of that factor are a
<em>sample</em> of levels from a real or conceptual population of
levels.</p>
<p>Note: We sometimes use the term “mixed effects” model for a model
where some parameters are modeled as random and some that are not
modeled as random (i.e., fixed). Most (but not all) models with random
effects also have some fixed effects, and are thus mixed effects
models.</p>
<p><strong>Example</strong>: Consider again the <code>baserun</code>
data, but a system of subscripts that distinguishes between the
<em>player</em> and the <em>observation within each player</em> so that
<span class="math inline">\(Y_{ij}\)</span> is the <span
class="math inline">\(j\)</span>-th observation of running time for the
<span class="math inline">\(i\)</span>-th player.</p>
<pre class="r"><code>library(trtools)
head(baserun)</code></pre>
<pre><code>  round narrow wide
1  5.40   5.50 5.55
2  5.85   5.70 5.75
3  5.20   5.60 5.50
4  5.55   5.50 5.40
5  5.90   5.85 5.70
6  5.45   5.55 5.60</code></pre>
<p>If we were to ignore the effect of player we could write a model for
these data as <span class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2},
\]</span> where <span class="math inline">\(x_{i1}\)</span> and <span
class="math inline">\(x_{i2}\)</span> are indicator variables for two of
the three routes.</p>
<p>In the <em>fixed effects</em> approach we include an indicator
variable for each player, so the model would become <span
class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} + \beta_3
x_{ij3} + \beta_4 x_{ij4} + \cdots + \beta_{23} x_{ij23},
\]</span> where <span class="math inline">\(x_{ij3}, x_{ij4}, \dots,
x_{ij23}\)</span> are the 21 indicator variables for the 22 players.</p>
<p>In the <em>random effects</em> approach we would view <span
class="math inline">\(\beta_3, \beta_4, \dots, \beta_{23}\)</span> as
<em>random variables</em>. To distinguish the random from the non-random
(fixed) parameters I will change the symbols for the indicator variables
and the parameters corresponding to the players and write the model as
<span class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} + \delta_1
z_{ij1} + \delta_2 z_{ij2} + \dots + \delta_{22} z_{ij22}.
\]</span> Note also that here we have 22 rather than 21 indicator
variables (each player has their own parameter). A more compact way to
write this model is <span class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} +
\underbrace{\delta_1 z_{ij1} + \delta_2 z_{ij2} + \dots + \delta_{22}
z_{ij22}}_{\delta_i} = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} +
\delta_i,
\]</span> so that <span class="math inline">\(\delta_i\)</span>
represents the “random effect” of the <span
class="math inline">\(i\)</span>-th player.</p>
<p>Another way to write this model is <span class="math display">\[
  Y_{ij} = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} + \delta_i +
\epsilon_{ij},
\]</span> where <span class="math inline">\(\epsilon_{ij}\)</span> is
the usual random error term, which is implicitly assumed to be
normally-distributed. Thus on the right-hand side of the above
expression we have <em>two</em> random variables on the right-hand side:
<span class="math inline">\(\delta_i\)</span> and <span
class="math inline">\(\epsilon_{ij}\)</span>.</p>
<p>To complete the model a distribution is needed to be assumed for each
<span class="math inline">\(\delta_i\)</span>. Typically they are
assumed to be normally distributed with zero mean and some variance
<span class="math inline">\(\sigma_{\delta}^2\)</span> so that we write
<span class="math inline">\(\delta_i \sim
N(0,\sigma_{\delta}^2)\)</span>. Because the <span
class="math inline">\(\delta_i\)</span> have a mean of zero they can be
viewed as a “deviation” of the effect of the <span
class="math inline">\(i\)</span>-th player from a (conceptual) average
player.</p>
<p>The presence of the random <span
class="math inline">\(\delta_i\)</span> parameters fundamentally changes
the likelihood function. Specialized inferential methods are (usually)
necessary to arrive at correct inferences when random effects are
specified. As with other approaches functions to implement these methods
require that the data be in “long form” so we reshape the
<code>baserun</code> data.</p>
<pre class="r"><code>library(dplyr)
library(tidyr)
baselong &lt;- trtools::baserun %&gt;% mutate(player = factor(letters[1:n()])) %&gt;% 
  pivot_longer(cols = c(round, narrow, wide), names_to = &quot;route&quot;, values_to = &quot;time&quot;)
head(baselong)</code></pre>
<pre><code># A tibble: 6 × 3
  player route   time
  &lt;fct&gt;  &lt;chr&gt;  &lt;dbl&gt;
1 a      round   5.4 
2 a      narrow  5.5 
3 a      wide    5.55
4 b      round   5.85
5 b      narrow  5.7 
6 b      wide    5.75</code></pre>
<p>The <code>lmer</code> function from the <strong>lme4</strong> package
can estimate a <em>linear mixed effects regression</em> model with
normally-distributed random effects. The model above can be estimated as
follows.</p>
<pre class="r"><code>library(lme4)
m &lt;- lmer(time ~ route + (1 | player), data = baselong)
summary(m)</code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: time ~ route + (1 | player)
   Data: baselong

REML criterion at convergence: -51.4

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.0968 -0.3473  0.0031  0.5001  1.6424 

Random effects:
 Groups   Name        Variance Std.Dev.
 player   (Intercept) 0.06448  0.2539  
 Residual             0.00745  0.0863  
Number of obs: 66, groups:  player, 22

Fixed effects:
            Estimate Std. Error t value
(Intercept)  5.53409    0.05718   96.78
routeround   0.00909    0.02603    0.35
routewide   -0.07500    0.02603   -2.88

Correlation of Fixed Effects:
           (Intr) rotrnd
routeround -0.228       
routewide  -0.228  0.500</code></pre>
<p>Profile likelihood confidence intervals for <span
class="math inline">\(\sigma_{\delta}^2\)</span> (the variance of the
<span class="math inline">\(\delta_i\)</span> parameters), <span
class="math inline">\(\sigma^2\)</span> (the variance of <span
class="math inline">\(\epsilon_{ij}\)</span>), and <span
class="math inline">\(\beta_0\)</span>, <span
class="math inline">\(\beta_1\)</span>, and <span
class="math inline">\(\beta_2\)</span> can be obtained using
<code>confint</code>.</p>
<pre class="r"><code>confint(m)</code></pre>
<pre><code>               2.5 %   97.5 %
.sig01       0.18688  0.34746
.sigma       0.06937  0.10557
(Intercept)  5.42025  5.64793
routeround  -0.04186  0.06004
routewide   -0.12595 -0.02405</code></pre>
<p>Using <code>lincon</code> will produce Wald confidence intervals for
<span class="math inline">\(\beta_0\)</span>, <span
class="math inline">\(\beta_1\)</span>, and <span
class="math inline">\(\beta_2\)</span>.</p>
<pre class="r"><code>trtools::lincon(m)</code></pre>
<pre><code>             estimate      se    lower    upper  tvalue  df   pvalue
(Intercept)  5.534091 0.05718  5.42202  5.64616 96.7838 Inf 0.000000
routeround   0.009091 0.02603 -0.04192  0.06010  0.3493 Inf 0.726871
routewide   -0.075000 0.02603 -0.12601 -0.02399 -2.8817 Inf 0.003956</code></pre>
<p>Other inferences can be made using <code>trtools::contrast</code> and
the <strong>emmeans</strong> package, but note that player is never
specified when using these functions. These tools provide inferences
only for the “fixed effects” of the model. We can estimate the expected
running time for each route.</p>
<pre class="r"><code>library(emmeans)

emmeans(m, ~route)</code></pre>
<pre><code> route  emmean     SE   df lower.CL upper.CL
 narrow   5.53 0.0572 24.2     5.42     5.65
 round    5.54 0.0572 24.2     5.42     5.66
 wide     5.46 0.0572 24.2     5.34     5.58

Degrees-of-freedom method: kenward-roger 
Confidence level used: 0.95 </code></pre>
<pre class="r"><code>trtools::contrast(m, a = list(route = c(&quot;narrow&quot;,&quot;round&quot;,&quot;wide&quot;)),
  cnames = c(&quot;narrow&quot;,&quot;round&quot;,&quot;wide&quot;))</code></pre>
<pre><code>       estimate      se lower upper tvalue  df pvalue
narrow    5.534 0.05718 5.422 5.646  96.78 Inf      0
round     5.543 0.05718 5.431 5.655  96.94 Inf      0
wide      5.459 0.05718 5.347 5.571  95.47 Inf      0</code></pre>
<p>Notice that <code>emmeans</code> uses the “Kenward-Roger” method of
computing approximate degrees of freedom. The issue of degrees of
freedom is a difficult problem in models with random effects. Some
statisticians suggest just using Wald methods which specify infinite
degrees of freedom as an approximation (which is the default in my
functions). This can be done using the
<code>lmer.df = "asymptotic"</code> option.</p>
<pre class="r"><code>emmeans(m, ~route, lmer.df = &quot;asymptotic&quot;)</code></pre>
<pre><code> route  emmean     SE  df asymp.LCL asymp.UCL
 narrow   5.53 0.0572 Inf      5.42      5.65
 round    5.54 0.0572 Inf      5.43      5.66
 wide     5.46 0.0572 Inf      5.35      5.57

Degrees-of-freedom method: asymptotic 
Confidence level used: 0.95 </code></pre>
<p>We can also compare the routes as before.</p>
<pre class="r"><code>pairs(emmeans(m, ~ route, lmer.df = &quot;asymptotic&quot;), adjust = &quot;none&quot;, infer = TRUE)</code></pre>
<pre><code> contrast       estimate    SE  df asymp.LCL asymp.UCL z.ratio p.value
 narrow - round -0.00909 0.026 Inf   -0.0601    0.0419  -0.349  0.7269
 narrow - wide   0.07500 0.026 Inf    0.0240    0.1260   2.882  0.0040
 round - wide    0.08409 0.026 Inf    0.0331    0.1351   3.231  0.0012

Degrees-of-freedom method: asymptotic 
Confidence level used: 0.95 </code></pre>
<pre class="r"><code>trtools::contrast(m, a = list(route = c(&quot;narrow&quot;,&quot;round&quot;,&quot;wide&quot;)), 
  cnames = c(&quot;narrow&quot;,&quot;round&quot;,&quot;wide&quot;))</code></pre>
<pre><code>       estimate      se lower upper tvalue  df pvalue
narrow    5.534 0.05718 5.422 5.646  96.78 Inf      0
round     5.543 0.05718 5.431 5.655  96.94 Inf      0
wide      5.459 0.05718 5.347 5.571  95.47 Inf      0</code></pre>
<pre class="r"><code>trtools::contrast(m, 
  a = list(route = c(&quot;narrow&quot;,&quot;narrow&quot;,&quot;round&quot;)),
  b = list(route = c(&quot;round&quot;,&quot;wide&quot;,&quot;wide&quot;)),
  cnames = c(&quot;narrow - round&quot;,&quot;narrow - wide&quot;,&quot;round - wide&quot;))</code></pre>
<pre><code>                estimate      se    lower   upper  tvalue  df   pvalue
narrow - round -0.009091 0.02603 -0.06010 0.04192 -0.3493 Inf 0.726871
narrow - wide   0.075000 0.02603  0.02399 0.12601  2.8817 Inf 0.003956
round - wide    0.084091 0.02603  0.03308 0.13510  3.2309 Inf 0.001234</code></pre>
<p>Some built-in functions also allow us to plot estimates of the <span
class="math inline">\(\delta_i\)</span> parameters.</p>
<pre class="r"><code>lattice::dotplot(ranef(m, condVar = TRUE))</code></pre>
<pre><code>$player</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-10-1.png" width="100%" style="display: block; margin: auto;" />
Alternatively you can use the <code>ranef</code> function to return
these estimates and plot them using <code>ggplot</code> or something
else.</p>
<pre class="r"><code>d &lt;- as.data.frame(ranef(m))
head(d)</code></pre>
<pre><code>  grpvar        term grp  condval condsd
1 player (Intercept)   a -0.02772 0.0489
2 player (Intercept)   b  0.24510 0.0489
3 player (Intercept)   c -0.07587 0.0489
4 player (Intercept)   d -0.02772 0.0489
5 player (Intercept)   e  0.29325 0.0489
6 player (Intercept)   f  0.02043 0.0489</code></pre>
<pre class="r"><code>d &lt;- d %&gt;% mutate(lower = condval - 1.96 * condsd, upper = condval + 1.96 * condsd)
head(d)</code></pre>
<pre><code>  grpvar        term grp  condval condsd    lower   upper
1 player (Intercept)   a -0.02772 0.0489 -0.12357 0.06813
2 player (Intercept)   b  0.24510 0.0489  0.14925 0.34096
3 player (Intercept)   c -0.07587 0.0489 -0.17172 0.01999
4 player (Intercept)   d -0.02772 0.0489 -0.12357 0.06813
5 player (Intercept)   e  0.29325 0.0489  0.19740 0.38910
6 player (Intercept)   f  0.02043 0.0489 -0.07543 0.11628</code></pre>
<pre class="r"><code>p &lt;- ggplot(d, aes(x = grp, y = condval)) +
  geom_linerange(aes(ymin = lower, ymax = upper)) +
  geom_point(size = 1.5) + 
  theme_minimal() + coord_flip() + 
  labs(x = &quot;Player&quot;, y = &quot;Estimated Player Effect&quot;)
plot(p)</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p><strong>Example</strong>: Now consider again the <code>Sitka</code>
data.</p>
<pre class="r"><code>library(MASS)
head(Sitka, 10)</code></pre>
<pre><code>   size Time tree treat
1  4.51  152    1 ozone
2  4.98  174    1 ozone
3  5.41  201    1 ozone
4  5.90  227    1 ozone
5  6.15  258    1 ozone
6  4.24  152    2 ozone
7  4.20  174    2 ozone
8  4.68  201    2 ozone
9  4.92  227    2 ozone
10 4.96  258    2 ozone</code></pre>
<pre class="r"><code>p &lt;- ggplot(Sitka, aes(x = Time, y = exp(size))) +
  geom_line(aes(group = tree), alpha = 0.75, size = 0.1) +
  facet_wrap(~ treat) + geom_point(size = 0.5) + 
  labs(y = &quot;Size (height times squared diameter)&quot;, 
    x = &quot;Days Since January 1, 1988&quot;) + theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;" />
First let’s consider the model</p>
<p><span class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} + \beta_3
x_{ij3} + \delta_i,
\]</span> where <span class="math inline">\(Y_{ij}\)</span> is the <span
class="math inline">\(j\)</span>-th observation of size for the <span
class="math inline">\(i\)</span>-th tree, <span
class="math inline">\(x_{ij1}\)</span> is an indicator for treatment
(ozone), <span class="math inline">\(x_{ij2}\)</span> is time, and <span
class="math inline">\(x_{ij3} = x_{ij1}x_{ij2}\)</span>.</p>
<pre class="r"><code>m &lt;- lmer(exp(size) ~ treat * Time + (1 | tree), data = Sitka)
summary(m)</code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: exp(size) ~ treat * Time + (1 | tree)
   Data: Sitka

REML criterion at convergence: 4472

Scaled residuals: 
   Min     1Q Median     3Q    Max 
-2.811 -0.436 -0.027  0.350  3.620 

Random effects:
 Groups   Name        Variance Std.Dev.
 tree     (Intercept) 8827     94.0    
 Residual             2857     53.5    
Number of obs: 395, groups:  tree, 79

Fixed effects:
                Estimate Std. Error t value
(Intercept)     -305.123     32.256   -9.46
treatozone       110.675     39.014    2.84
Time               2.509      0.127   19.70
treatozone:Time   -0.788      0.154   -5.12

Correlation of Fixed Effects:
            (Intr) tretzn Time  
treatozone  -0.827              
Time        -0.799  0.661       
treatozn:Tm  0.661 -0.799 -0.827</code></pre>
<pre class="r"><code>Sitka$yhat.sub &lt;- predict(m)               # for each tree (with deltas)
Sitka$yhat.avg &lt;- predict(m, re.form = NA) # for the &quot;average&quot; tree (deltas = 0)

p &lt;- ggplot(Sitka, aes(x = Time, y = exp(size))) + 
  labs(y = &quot;Size (height times squared diameter)&quot;, 
    x = &quot;Days Since January 1, 1988&quot;) + 
  theme_minimal() + facet_wrap(~treat) + 
  geom_line(aes(y = yhat.sub, group = tree), color = grey(0.75)) + 
  geom_line(aes(y = yhat.avg), size = 0.75) + 
  geom_point(size = 0.5)
plot(p)</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-14-1.png" width="100%" style="display: block; margin: auto;" />
This doesn’t really capture differences in the growth rates between
trees (i.e., an <em>interaction</em> between tree and time). Such a
model could be written as <span class="math display">\[
  E(Y_{ij}) = \beta_0 + \beta_1 x_{ij1} + \beta_2 x_{ij2} + \beta_3
x_{ij3} + \delta_i + \gamma_i x_{ij2},
\]</span> where now there are <em>two</em> random parameters for each
tree: <span class="math inline">\(\delta_i\)</span> and <span
class="math inline">\(\gamma_i\)</span>. We can also write this model as
<span class="math display">\[
  E(Y_{ij}) =
  \begin{cases}
    \beta_0 + \delta_i + (\beta_2 + \gamma_i)t_{ij}, &amp; \text{if the
treatment is control}, \\
    \beta_0 + \beta_1 + \delta_i + (\beta_2 + \beta_3 + \gamma_i)t_{ij},
&amp; \text{if the treatment is ozone},
  \end{cases}
\]</span> where <span class="math inline">\(t_{ij}\)</span> is time.
This means that the linear relationship between time and expected size
varies over treatment conditions, but also trees — i.e., each tree has
its own intercept and slope (rate).</p>
<pre class="r"><code>m &lt;- lmer(exp(size) ~ treat * Time + (1 + Time | tree), data = Sitka)</code></pre>
<pre><code>Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control$checkConv, : Model
failed to converge with max|grad| = 2.20761 (tol = 0.002, component 1)</code></pre>
<pre><code>Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control$checkConv, : Model is nearly unidentifiable: very large eigenvalue
 - Rescale variables?</code></pre>
<p>Oh no! Models with random effects are cranky. But let’s take the
advice of the warning and re-scale time from days to weeks.</p>
<pre class="r"><code>m &lt;- lmer(exp(size) ~ treat * I(Time/7) + (1 + I(Time/7) | tree), data = Sitka)</code></pre>
<pre><code>Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control$checkConv, : Model
failed to converge with max|grad| = 0.0418627 (tol = 0.002, component 1)</code></pre>
<p>That <em>probably</em> is not a problem. I suspect it is due to the
very high correlation between the random intercept and slope parameters.
But changing the optimizer seems to avoid the error.</p>
<pre class="r"><code>library(optimx)
m &lt;- lmer(exp(size) ~ treat * I(Time/7) + (1 + I(Time/7) | tree), data = Sitka,
  control = lmerControl(optimizer = &quot;optimx&quot;, optCtrl = list(method = &quot;nlminb&quot;)))
summary(m) </code></pre>
<pre><code>Linear mixed model fit by REML [&#39;lmerMod&#39;]
Formula: exp(size) ~ treat * I(Time/7) + (1 + I(Time/7) | tree)
   Data: Sitka
Control: lmerControl(optimizer = &quot;optimx&quot;, optCtrl = list(method = &quot;nlminb&quot;))

REML criterion at convergence: 3915

Scaled residuals: 
   Min     1Q Median     3Q    Max 
-2.964 -0.395 -0.049  0.391  4.816 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 tree     (Intercept) 22745.6  150.82        
          I(Time/7)      70.2    8.38   -0.99
 Residual               383.2   19.57        
Number of obs: 395, groups:  tree, 79

Fixed effects:
                     Estimate Std. Error t value
(Intercept)           -305.12      31.65   -9.64
treatozone             110.68      38.29    2.89
I(Time/7)               17.56       1.71   10.29
treatozone:I(Time/7)    -5.52       2.06   -2.67

Correlation of Fixed Effects:
            (Intr) tretzn I(T/7)
treatozone  -0.827              
I(Time/7)   -0.980  0.810       
trtz:I(T/7)  0.810 -0.980 -0.827</code></pre>
<p>I found that you get more or less the same result even without
changing the optimizer. Here’s a plot.</p>
<pre class="r"><code>Sitka$yhat.sub &lt;- predict(m)               # for each tree (with deltas)
Sitka$yhat.avg &lt;- predict(m, re.form = NA) # for the &quot;average&quot; tree (deltas = 0)

p &lt;- ggplot(Sitka, aes(x = Time, y = exp(size))) + 
  labs(y = &quot;Size (height times squared diameter)&quot;, 
    x = &quot;Days Since January 1, 1988&quot;) + 
  theme_minimal() + facet_wrap(~treat) + 
  geom_line(aes(y = yhat.sub, group = tree), color = grey(0.75)) +
  geom_line(aes(y = yhat.avg), size = 0.75) + 
  geom_point(size = 0.5)
plot(p)</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-18-1.png" width="100%" style="display: block; margin: auto;" />
Now we can estimate and compare the (average) growth rates in the
control and ozone conditions (per 100 days with <code>contrast</code>
and per day with <code>emtrends</code>).</p>
<pre class="r"><code>trtools::contrast(m,
  a = list(Time = 250, treat = c(&quot;control&quot;,&quot;ozone&quot;)),
  b = list(Time = 150, treat = c(&quot;control&quot;,&quot;ozone&quot;)),
  cnames = c(&quot;control&quot;,&quot;ozone&quot;))</code></pre>
<pre><code>        estimate    se lower upper tvalue  df    pvalue
control    250.9 24.38 203.1 298.7  10.29 Inf 7.718e-25
ozone      172.1 16.59 139.6 204.6  10.37 Inf 3.227e-25</code></pre>
<pre class="r"><code>trtools::contrast(m,
  a = list(Time = 250, treat = &quot;control&quot;),
  b = list(Time = 150, treat = &quot;control&quot;),
  u = list(Time = 250, treat = &quot;ozone&quot;),
  v = list(Time = 150, treat = &quot;ozone&quot;))</code></pre>
<pre><code> estimate    se lower upper tvalue  df   pvalue
    78.81 29.49    21 136.6  2.672 Inf 0.007537</code></pre>
<pre class="r"><code>emtrends(m, ~ treat, var = &quot;Time&quot;, lmer.df = &quot;asymptotic&quot;)</code></pre>
<pre><code> treat   Time.trend    SE  df asymp.LCL asymp.UCL
 control       2.51 0.244 Inf      2.03      2.99
 ozone         1.72 0.166 Inf      1.40      2.05

Degrees-of-freedom method: asymptotic 
Confidence level used: 0.95 </code></pre>
<pre class="r"><code>pairs(emtrends(m, ~ treat, var = &quot;Time&quot;, 
  lmer.df = &quot;asymptotic&quot;), infer = TRUE)</code></pre>
<pre><code> contrast        estimate    SE  df asymp.LCL asymp.UCL z.ratio p.value
 control - ozone    0.788 0.295 Inf      0.21      1.37   2.672  0.0075

Degrees-of-freedom method: asymptotic 
Confidence level used: 0.95 </code></pre>
<p>We can plot estimates of the <span
class="math inline">\(\delta_i\)</span> and <span
class="math inline">\(\gamma_i\)</span> parameters for each tree.</p>
<pre class="r"><code>lattice::dotplot(ranef(m, condVar = TRUE))</code></pre>
<pre><code>$tree</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-20-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>d &lt;- as.data.frame(ranef(m))
head(d)</code></pre>
<pre><code>  grpvar        term grp condval condsd
1   tree (Intercept)   1 -240.18  37.45
2   tree (Intercept)   2  110.08  37.45
3   tree (Intercept)   3   87.68  37.45
4   tree (Intercept)   4   52.13  37.45
5   tree (Intercept)   5 -330.64  37.45
6   tree (Intercept)   6 -141.21  37.45</code></pre>
<pre class="r"><code>d &lt;- d %&gt;% mutate(lower = condval - 1.96 * condsd, upper = condval + 1.96 * condsd)
head(d)</code></pre>
<pre><code>  grpvar        term grp condval condsd   lower  upper
1   tree (Intercept)   1 -240.18  37.45 -313.59 -166.8
2   tree (Intercept)   2  110.08  37.45   36.67  183.5
3   tree (Intercept)   3   87.68  37.45   14.27  161.1
4   tree (Intercept)   4   52.13  37.45  -21.28  125.5
5   tree (Intercept)   5 -330.64  37.45 -404.05 -257.2
6   tree (Intercept)   6 -141.21  37.45 -214.62  -67.8</code></pre>
<pre class="r"><code>p &lt;- ggplot(d, aes(x = grp, y = condval, color = term)) +
  geom_linerange(aes(ymin = lower, ymax = upper)) + 
  geom_point(size = 1) + 
  theme_minimal() + coord_flip() + 
  labs(x = &quot;Tree&quot;, y = &quot;Estimated Tree Effects&quot;, color = &quot;Term&quot;) +
  theme(axis.text.y = element_text(size = 5)) 
plot(p)</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-20-2.png" width="100%" style="display: block; margin: auto;" /></p>
<p><strong>Example</strong>: Consider again the smoking cessation meta
analysis data.</p>
<pre class="r"><code>library(dplyr)  
library(tidyr) 
quitsmoke &lt;- HSAUR3::smoking
quitsmoke$study &lt;- rownames(quitsmoke)
quitsmoke.quits &lt;- quitsmoke %&gt;% dplyr::select(study, qt, qc) %&gt;% 
  rename(gum = qt, control = qc) %&gt;%
  gather(gum, control, key = treatment, value = quit)
quitsmoke.total &lt;- quitsmoke %&gt;% dplyr::select(study, tt, tc) %&gt;% 
  rename(gum = tt, control = tc) %&gt;%
  gather(gum, control, key = treatment, value = total)
quitsmoke &lt;- full_join(quitsmoke.quits, quitsmoke.total) %&gt;% 
  mutate(study = factor(study)) %&gt;% arrange(study)
head(quitsmoke)</code></pre>
<pre><code>         study treatment quit total
1    Blondal89       gum   37    92
2    Blondal89   control   24    90
3   Campbell91       gum   21   107
4   Campbell91   control   21   105
5 Fagerstrom82       gum   30    50
6 Fagerstrom82   control   23    50</code></pre>
<p>We can introduce a random “study effect” into a logistic regression
model to create a <em>generalized linear mixed effects regression</em>
model. This would be written as <span class="math display">\[
  \log\left[\frac{E(Y_{ij})}{1 - E(Y_{ij})}\right] = \beta_0 + \beta_1
x_{ij} + \delta_i,
\]</span> where <span class="math inline">\(Y_{ij}\)</span> is the <span
class="math inline">\(j\)</span>-th proportion of people quitting in the
<span class="math inline">\(i\)</span>-th study, and <span
class="math inline">\(x_{ij}\)</span> is an indicator variable for
treatment (gum). This model can be estimated as follows.</p>
<pre class="r"><code>m &lt;- glmer(cbind(quit, total - quit) ~ treatment + (1 | study),
  family = binomial, data = quitsmoke)
summary(m)</code></pre>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [glmerMod
]
 Family: binomial  ( logit )
Formula: cbind(quit, total - quit) ~ treatment + (1 | study)
   Data: quitsmoke

     AIC      BIC   logLik deviance df.resid 
   367.3    373.2   -180.6    361.3       49 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.9940 -0.6602 -0.0373  0.4633  2.3042 

Random effects:
 Groups Name        Variance Std.Dev.
 study  (Intercept) 0.412    0.642   
Number of obs: 52, groups:  study, 26

Fixed effects:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   -1.3625     0.1376   -9.90  &lt; 2e-16 ***
treatmentgum   0.5149     0.0655    7.87  3.6e-15 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Correlation of Fixed Effects:
            (Intr)
treatmentgm -0.281</code></pre>
<p>We can estimate the odds ratio for the treatment, which is assumed to
be the same for every study in this model.</p>
<pre class="r"><code>trtools::contrast(m, tf = exp,
  a = list(treatment = &quot;gum&quot;),
  b = list(treatment = &quot;control&quot;))</code></pre>
<pre><code> estimate lower upper
    1.673 1.472 1.902</code></pre>
<pre class="r"><code>pairs(emmeans(m, ~ treatment, type = &quot;response&quot;), reverse = TRUE)</code></pre>
<pre><code> contrast      odds.ratio   SE  df null z.ratio p.value
 gum / control       1.67 0.11 Inf    1   7.867  &lt;.0001

Tests are performed on the log odds ratio scale </code></pre>
<p>We can extend the model so that the treatment effect varies over
studies (i.e., an interaction between treatment and study).</p>
<pre class="r"><code>m &lt;- glmer(cbind(quit, total - quit) ~ treatment + (1 + treatment | study),
  family = binomial, data = quitsmoke)
summary(m)</code></pre>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [glmerMod
]
 Family: binomial  ( logit )
Formula: cbind(quit, total - quit) ~ treatment + (1 + treatment | study)
   Data: quitsmoke

     AIC      BIC   logLik deviance df.resid 
   368.3    378.0   -179.1    358.3       47 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.4423 -0.4678  0.0217  0.3796  1.6638 

Random effects:
 Groups Name         Variance Std.Dev. Corr 
 study  (Intercept)  0.4211   0.649         
        treatmentgum 0.0508   0.225    -0.12
Number of obs: 52, groups:  study, 26

Fixed effects:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   -1.3991     0.1415   -9.89  &lt; 2e-16 ***
treatmentgum   0.5723     0.0887    6.45  1.1e-10 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Correlation of Fixed Effects:
            (Intr)
treatmentgm -0.340</code></pre>
<p>Now our odds ratios are for a “typical” study.</p>
<pre class="r"><code>trtools::contrast(m, tf = exp,
  a = list(treatment = &quot;gum&quot;),
  b = list(treatment = &quot;control&quot;))</code></pre>
<pre><code> estimate lower upper
    1.772 1.489 2.109</code></pre>
<pre class="r"><code>pairs(emmeans(m, ~ treatment, type = &quot;response&quot;), reverse = TRUE)</code></pre>
<pre><code> contrast      odds.ratio    SE  df null z.ratio p.value
 gum / control       1.77 0.157 Inf    1   6.449  &lt;.0001

Tests are performed on the log odds ratio scale </code></pre>
<p>Note: In logistic regression, if your response variable is
<em>binary</em> (i.e., not aggregated counts) use the option
<code>nAGQ = x</code> where <code>x</code> is maybe 21+.</p>
<pre class="r"><code>m &lt;- glmer(cbind(quit, total - quit) ~ treatment + (1 | study),
  family = binomial, data = quitsmoke, nAGQ = 31)
summary(m)</code></pre>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Adaptive Gauss-Hermite
  Quadrature, nAGQ = 31) [glmerMod]
 Family: binomial  ( logit )
Formula: cbind(quit, total - quit) ~ treatment + (1 | study)
   Data: quitsmoke

     AIC      BIC   logLik deviance df.resid 
   136.2    142.0    -65.1    130.2       49 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.9943 -0.6602 -0.0374  0.4631  2.3039 

Random effects:
 Groups Name        Variance Std.Dev.
 study  (Intercept) 0.413    0.642   
Number of obs: 52, groups:  study, 26

Fixed effects:
             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)   -1.3625     0.1378   -9.89   &lt;2e-16 ***
treatmentgum   0.5149     0.0655    7.86    4e-15 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Correlation of Fixed Effects:
            (Intr)
treatmentgm -0.281</code></pre>
<p>It can also be used in other GLMERs. Because of the complexity of the
likelihood function in these models, there are many different numerical
approaches to estimation.</p>
<p><strong>Example</strong>: Consider a random effects approach for the
<code>leprosy</code> data.</p>
<pre class="r"><code>library(ALA)
head(leprosy)</code></pre>
<pre><code>   id drug period nBacilli
1   1    A    pre       11
31  1    A   post        6
2   2    B    pre        6
32  2    B   post        0
3   3    C    pre       16
33  3    C   post       13</code></pre>
<pre class="r"><code>p &lt;- ggplot(leprosy, aes(x = drug, y = nBacilli, fill = period)) +
  geom_dotplot(binaxis = &quot;y&quot;, method = &quot;histodot&quot;, 
    stackdir = &quot;center&quot;, binwidth = 1, 
    position = position_dodge(width = 0.5)) + 
  scale_fill_manual(values = c(&quot;white&quot;,&quot;black&quot;)) + 
  labs(x = &quot;Drug&quot;, y = &quot;Number of Bacilli&quot;, fill = &quot;Period&quot;) +
  theme_minimal()
plot(p)</code></pre>
<p><img src="lecture-04-27-2022_files/figure-html/unnamed-chunk-27-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>m &lt;- glmer(nBacilli ~ drug * period + (1 | id), family = poisson, data = leprosy)
summary(m)</code></pre>
<pre><code>Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [glmerMod
]
 Family: poisson  ( log )
Formula: nBacilli ~ drug * period + (1 | id)
   Data: leprosy

     AIC      BIC   logLik deviance df.resid 
   363.9    378.6   -175.0    349.9       53 

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.8757 -0.5729  0.0637  0.4264  1.9372 

Random effects:
 Groups Name        Variance Std.Dev.
 id     (Intercept) 0.259    0.509   
Number of obs: 60, groups:  id, 30

Fixed effects:
                 Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)        2.0936     0.1953   10.72  &lt; 2e-16 ***
drugB              0.0506     0.2737    0.19  0.85320    
drugC              0.3836     0.2682    1.43  0.15270    
periodpost        -0.5623     0.1704   -3.30  0.00097 ***
drugB:periodpost   0.0680     0.2344    0.29  0.77164    
drugC:periodpost   0.5147     0.2114    2.43  0.01490 *  
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Correlation of Fixed Effects:
            (Intr) drugB  drugC  prdpst drgB:p
drugB       -0.707                            
drugC       -0.725  0.515                     
periodpost  -0.317  0.226  0.231              
drgB:prdpst  0.230 -0.317 -0.168 -0.727       
drgC:prdpst  0.255 -0.182 -0.321 -0.806  0.586</code></pre>
<p>Estimated ratios for each drug.</p>
<pre class="r"><code>pairs(emmeans(m, ~ period | drug, type = &quot;response&quot;), 
  reverse = TRUE, infer = TRUE)</code></pre>
<pre><code>drug = A:
 contrast   ratio     SE  df asymp.LCL asymp.UCL null z.ratio p.value
 post / pre 0.570 0.0971 Inf     0.408     0.796    1  -3.300  0.0010

drug = B:
 contrast   ratio     SE  df asymp.LCL asymp.UCL null z.ratio p.value
 post / pre 0.610 0.0982 Inf     0.445     0.836    1  -3.071  0.0021

drug = C:
 contrast   ratio     SE  df asymp.LCL asymp.UCL null z.ratio p.value
 post / pre 0.954 0.1193 Inf     0.746     1.218    1  -0.381  0.7035

Confidence level used: 0.95 
Intervals are back-transformed from the log scale 
Tests are performed on the log scale </code></pre>
<pre class="r"><code>trtools::contrast(m, tf = exp,
  a = list(period = &quot;post&quot;, drug = c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;)),
  b = list(period = &quot;pre&quot;, drug = c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;)),
  cnames = c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;))</code></pre>
<pre><code>  estimate  lower  upper
A   0.5699 0.4081 0.7958
B   0.6100 0.4450 0.8362
C   0.9535 0.7461 1.2185</code></pre>
<p>We can also compare the rate ratios.</p>
<pre class="r"><code>pairs(pairs(emmeans(m, ~ period | drug, type = &quot;response&quot;), 
  reverse = TRUE), by = NULL, adjust = &quot;none&quot;)</code></pre>
<pre><code> contrast                        ratio    SE  df null z.ratio p.value
 (post / pre A) / (post / pre B) 0.934 0.219 Inf    1  -0.290  0.7716
 (post / pre A) / (post / pre C) 0.598 0.126 Inf    1  -2.435  0.0149
 (post / pre B) / (post / pre C) 0.640 0.130 Inf    1  -2.191  0.0284

Tests are performed on the log scale </code></pre>
<pre class="r"><code>trtools::contrast(m, tf = exp,
  a = list(period = &quot;post&quot;, drug = &quot;A&quot;),
  b = list(period = &quot;pre&quot;,  drug = &quot;A&quot;),
  u = list(period = &quot;post&quot;, drug = &quot;B&quot;),
  v = list(period = &quot;pre&quot;,  drug = &quot;B&quot;))</code></pre>
<pre><code> estimate  lower upper
   0.9342 0.5901 1.479</code></pre>
<pre class="r"><code>trtools::contrast(m, tf = exp,
  a = list(period = &quot;post&quot;, drug = &quot;A&quot;),
  b = list(period = &quot;pre&quot;,  drug = &quot;A&quot;),
  u = list(period = &quot;post&quot;, drug = &quot;C&quot;),
  v = list(period = &quot;pre&quot;,  drug = &quot;C&quot;))</code></pre>
<pre><code> estimate  lower  upper
   0.5977 0.3949 0.9045</code></pre>
<pre class="r"><code>trtools::contrast(m, tf = exp,
  a = list(period = &quot;post&quot;, drug = &quot;B&quot;),
  b = list(period = &quot;pre&quot;,  drug = &quot;B&quot;),
  u = list(period = &quot;post&quot;, drug = &quot;C&quot;),
  v = list(period = &quot;pre&quot;,  drug = &quot;C&quot;))</code></pre>
<pre><code> estimate lower upper
   0.6397 0.429 0.954</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
